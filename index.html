<!DOCTYPE html>
<html lang="pt-BR" class="antialiased">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Gerador de Provas</title>

    <!-- Google Font + Tailwind CDN -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root { font-family: 'Inter', sans-serif; }
        [contenteditable]:focus { outline: none; box-shadow: 0 0 0 3px rgba(59,130,246,0.12); }
        .fillable-line { display:inline-block; min-width:150px; border-bottom:1px solid currentColor; padding:2px 6px; }
        .short-line { min-width:50px; }
        .date-line .line { display:inline-block; width:25px; border-bottom:1px solid currentColor; margin:0 2px; }
        .question-line { border-bottom:2px solid #d1d5db; min-height:18px; margin:0.6rem 0; }
        .image-drop-area { pointer-events:auto; }
        .drag-highlight { border-color:#60a5fa !important; background-color:rgba(96,165,250,0.04); }
        /* Print rules */
        @media print {
            #app { display:none; }
            #print-area { display:block; }
            .question-line { border-bottom:2px solid #000; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">

<!-- APP -->
<div id="app" class="p-6 md:p-10 max-w-4xl mx-auto">
    <div class="flex justify-end mb-4">
        <button id="theme-toggle" class="p-2 rounded-full bg-gray-200 hover:bg-gray-300" title="Alternar tema">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m8.66-9H21M3 12H4.34M18.36 18.36l-.7-.7M6.34 6.34l-.7-.7M18.36 5.64l-.7.7M6.34 17.66l-.7.7" />
            </svg>
        </button>
    </div>

    <!-- Header -->
    <div class="bg-white rounded-lg shadow p-6 mb-8 border border-gray-200">
        <div class="flex flex-col md:flex-row items-start gap-4">
            <!-- Logo -->
            <div class="w-full md:w-1/4 flex-shrink-0">
                <div id="logo-container" class="relative w-28 h-28 mx-auto md:mx-0 p-2 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center cursor-pointer overflow-hidden">
                    <input id="logo-upload" type="file" accept="image/*" class="hidden" />
                    <img id="logo-preview" src="" alt="Logo" class="w-full h-full object-contain" style="display:none" />
                    <span id="logo-placeholder" class="text-xs text-gray-500 text-center">Arraste ou clique para adicionar a logo</span>
                </div>
            </div>

            <!-- Header Info -->
            <div id="header-info" class="w-full md:w-3/4 space-y-2">
                <div class="flex items-center justify-end gap-2">
                    <span class="text-sm font-semibold text-gray-600">Alinhamento:</span>
                    <div class="flex gap-1">
                        <button id="align-left" class="p-1 rounded hover:bg-gray-100" title="Esquerda">◀</button>
                        <button id="align-center" class="p-1 rounded hover:bg-gray-100" title="Centro">•</button>
                        <button id="align-right" class="p-1 rounded hover:bg-gray-100" title="Direita">▶</button>
                    </div>
                </div>

                <div id="header-text-container" class="space-y-1 text-right">
                    <div data-key="schoolName" contenteditable="true" class="text-lg font-bold">Nome da Escola</div>
                    <div class="text-lg font-bold">Aluno(a): <span class="fillable-line" contenteditable="true" data-key="student-name"></span></div>
                    <div data-key="teacher" contenteditable="true" class="text-lg font-bold">Professor(a):</div>
                    <div data-key="subject" contenteditable="true" class="text-lg font-bold">Componente curricular:</div>
                    <div class="text-lg font-bold">Ano/Turma: <span class="fillable-line short-line"></span> Data: <span class="date-line"><span class="line"></span>/<span class="line"></span>/<span class="line"></span></span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Title -->
    <div id="exam-title" class="text-xl font-bold text-center mb-6" contenteditable="true">Título da Prova</div>

    <!-- Paste area -->
    <div class="bg-white rounded-lg shadow p-6 mb-8 border border-gray-200">
        <h2 class="text-lg font-bold mb-2">Analisar Questões</h2>
        <p class="text-sm text-gray-500 mb-3">Cole o texto da sua prova aqui para que ele seja processado automaticamente.</p>
        <textarea id="question-input" rows="8" class="w-full p-3 rounded border border-gray-300 focus:ring-2 focus:ring-blue-500" placeholder="Cole suas questões..."></textarea>
        <div class="mt-4 flex flex-col sm:flex-row gap-2">
            <button id="process-questions" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded font-semibold">Analisar e Gerar</button>
            <button id="add-manual" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded font-semibold">Adicionar Questão Manual</button>
        </div>
    </div>

    <!-- Questions list -->
    <div id="question-list" class="space-y-6">
        <!-- dynamically rendered -->
    </div>

    <!-- Controls -->
    <div class="mt-8 flex flex-col sm:flex-row gap-3">
        <button id="export-pdf" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded font-semibold">Gerar Prova PDF</button>
        <button id="clear-exam" class="bg-red-500 hover:bg-red-600 text-white py-3 px-4 rounded font-semibold">Limpar Prova</button>
    </div>

    <!-- Message -->
    <div id="message-box" class="fixed bottom-6 right-6 z-50 p-3 rounded shadow text-white font-semibold opacity-0 pointer-events-none"></div>
</div>

<!-- Print area (hidden) -->
<div id="print-area" class="hidden w-[210mm] min-h-[297mm] p-8 mx-auto bg-white"></div>

<script>
/* =========================
   Gerador de Provas - Versão corrigida
   ========================= */

const state = {
    header: {
        logo: '',
        alignment: 'right', // 'left' | 'center' | 'right' (we use this in inline styles)
        schoolName: 'Nome da Escola',
        teacher: 'Professor(a):',
        subject: 'Componente curricular:',
        studentText: ''
    },
    examTitle: 'Título da Prova',
    questions: [],
    theme: 'light'
};

let saveTimer = null;

/* ---------- Helpers ---------- */

function showMessage(text, type='info') {
    const box = document.getElementById('message-box');
    box.textContent = text;
    box.className = 'fixed bottom-6 right-6 z-50 p-3 rounded shadow text-white font-semibold transition-opacity';
    if (type === 'success') box.classList.add('bg-green-500'); 
    else if (type === 'error') box.classList.add('bg-red-500');
    else box.classList.add('bg-blue-500');

    box.style.opacity = '1';
    box.style.pointerEvents = 'auto';
    clearTimeout(box._hideTimeout);
    box._hideTimeout = setTimeout(() => {
        box.style.opacity = '0';
        box.style.pointerEvents = 'none';
    }, 2500);
}

function saveState() {
    clearTimeout(saveTimer);
    saveTimer = setTimeout(() => {
        localStorage.setItem('examGeneratorState', JSON.stringify(state));
        console.log('estado salvo');
    }, 300);
}

function loadState() {
    const raw = localStorage.getItem('examGeneratorState');
    if (raw) {
        try {
            const parsed = JSON.parse(raw);
            // merge safely
            state.header = Object.assign(state.header, parsed.header || {});
            state.examTitle = parsed.examTitle || state.examTitle;
            state.questions = parsed.questions || state.questions;
            state.theme = parsed.theme || state.theme;
        } catch(e) {
            console.warn('erro ao carregar state', e);
        }
    } else {
        // exemplo inicial
        state.questions = [
            { id: crypto.randomUUID(), text: 'O que é o ponto de fusão?', image:'', imageSize:100, lines:2 },
            { id: crypto.randomUUID(), text: 'Qual a principal característica do bioma Amazônia?', image:'', imageSize:100, lines:3 }
        ];
    }
}

/* escape minimal para inserir em innerHTML */
function escapeHtml(s='') {
    return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;');
}

/* ---------- Rendering ---------- */

function renderHeader() {
    // schoolName, teacher, subject, student
    const schoolEl = document.querySelector('[data-key="schoolName"]');
    const teacherEl = document.querySelector('[data-key="teacher"]');
    const subjectEl = document.querySelector('[data-key="subject"]');
    const studentEl = document.querySelector('[data-key="student-name"]');
    const headerTextContainer = document.getElementById('header-text-container');

    schoolEl.textContent = state.header.schoolName || 'Nome da Escola';
    teacherEl.textContent = state.header.teacher || 'Professor(a):';
    subjectEl.textContent = state.header.subject || 'Componente curricular:';
    studentEl.textContent = state.header.studentText || '';

    // alignment: adjust container text-align
    headerTextContainer.style.textAlign = state.header.alignment;

    // logo
    const logoPreview = document.getElementById('logo-preview');
    const logoPlaceholder = document.getElementById('logo-placeholder');
    if (state.header.logo) {
        logoPreview.src = state.header.logo;
        logoPreview.style.display = 'block';
        logoPlaceholder.style.display = 'none';
    } else {
        logoPreview.style.display = 'none';
        logoPlaceholder.style.display = 'block';
    }
}

function renderExamTitle() {
    document.getElementById('exam-title').textContent = state.examTitle || '';
}

function renderQuestions() {
    const list = document.getElementById('question-list');
    list.innerHTML = '';

    state.questions.forEach((q, idx) => {
        const container = document.createElement('div');
        container.className = 'bg-white rounded-lg shadow p-6 border border-gray-200 relative';
        container.setAttribute('data-id', q.id);

        // header controls
        container.innerHTML = `
            <div class="flex items-start justify-between gap-3 mb-4">
                <div class="flex items-center gap-3">
                    <span class="text-xl font-bold text-blue-600">${idx+1}.</span>
                    <div contenteditable="true" class="question-text text-base leading-relaxed" data-id="${q.id}">${escapeHtml(q.text)}</div>
                </div>
                <div class="flex items-center gap-1 no-print">
                    <button class="duplicate-btn p-2 rounded hover:bg-gray-100" title="Duplicar">⧉</button>
                    <button class="remove-btn p-2 rounded hover:bg-gray-100" title="Remover">🗑</button>
                    <button class="move-up-btn p-2 rounded hover:bg-gray-100" title="Mover cima">▲</button>
                    <button class="move-down-btn p-2 rounded hover:bg-gray-100" title="Mover baixo">▼</button>
                </div>
            </div>
        `;

        // image if exists
        if (q.image) {
            const imgWrap = document.createElement('div');
            imgWrap.className = 'relative mb-4';
            imgWrap.innerHTML = `
                <div class="text-center mb-2"><img src="${q.image}" style="width:${q.imageSize}%;max-width:100%" class="rounded-lg shadow" /></div>
                <div class="flex items-center gap-2 no-print">
                    <input type="range" class="image-size-slider" data-id="${q.id}" min="10" max="100" value="${q.imageSize}" />
                    <button class="remove-image-btn p-1 rounded bg-red-500 text-white" data-id="${q.id}" title="Remover imagem">✕</button>
                </div>
            `;
            container.appendChild(imgWrap);
        }

        // controls for lines
        const controlBlock = document.createElement('div');
        controlBlock.className = 'no-print';
        controlBlock.innerHTML = `
            <label class="block text-sm text-gray-700 mb-1">Número de linhas de resposta: <span class="lines-label font-semibold">${q.lines}</span></label>
            <input type="range" class="response-lines-slider w-full" data-id="${q.id}" min="0" max="10" value="${q.lines}" />
        `;
        container.appendChild(controlBlock);

        // lines for answers
        for (let i=0;i<q.lines;i++){
            const line = document.createElement('div');
            line.className = 'question-line';
            container.appendChild(line);
        }

        // image drop overlay (full)
        const dropOverlay = document.createElement('div');
        dropOverlay.className = 'image-drop-area absolute inset-0 rounded border-2 border-transparent flex items-center justify-center transition-colors';
        dropOverlay.setAttribute('data-id', q.id);
        dropOverlay.innerHTML = `<span class="text-sm text-gray-500 opacity-0">Solte a imagem aqui</span>`;
        container.appendChild(dropOverlay);

        list.appendChild(container);
    });
}

/* ---------- Actions (used by delegation) ---------- */

function addManualQuestion() {
    state.questions.push({
        id: crypto.randomUUID(),
        text: 'Nova questão...',
        image: '',
        imageSize: 100,
        lines: 3
    });
    saveState();
    renderQuestions();
    showMessage('Nova questão adicionada.', 'success');
}

function duplicateQuestion(id) {
    const i = state.questions.findIndex(q=>q.id===id);
    if (i === -1) return;
    const original = state.questions[i];
    const copy = {...original, id: crypto.randomUUID()};
    state.questions.splice(i+1,0,copy);
    saveState();
    renderQuestions();
    showMessage('Questão duplicada.', 'success');
}

function removeQuestion(id) {
    state.questions = state.questions.filter(q=>q.id!==id);
    saveState();
    renderQuestions();
    showMessage('Questão removida.', 'info');
}

function moveQuestionUp(id) {
    const i = state.questions.findIndex(q=>q.id===id);
    if (i>0) {
        const [q] = state.questions.splice(i,1);
        state.questions.splice(i-1,0,q);
        saveState();
        renderQuestions();
    }
}

function moveQuestionDown(id) {
    const i = state.questions.findIndex(q=>q.id===id);
    if (i>-1 && i < state.questions.length-1) {
        const [q] = state.questions.splice(i,1);
        state.questions.splice(i+1,0,q);
        saveState();
        renderQuestions();
    }
}

/* ---------- Pasted text processing ---------- */

function processPastedText() {
    const raw = document.getElementById('question-input').value.trim();
    if (!raw) {
        showMessage('Nenhum texto para analisar.', 'error');
        return;
    }

    // Try numbered split first, fallback to blank-line split
    let parts = raw.split(/(?:\r?\n){2,}/).map(s=>s.trim()).filter(Boolean);
    // If looks like numbered items (line starts with "1."), use a regex to capture
    const numberedMatches = [...raw.matchAll(/(^|\n)\s*\d+[\.\)\-]\s*(.+?)(?=(\n\s*\d+[\.\)\-]\s*)|$)/gs)];
    if (numberedMatches && numberedMatches.length > 1) {
        parts = numberedMatches.map(m => m[2].trim());
    } else {
        // also try simpler split by "1. " patterns
        const alt = raw.split(/^\d+\.\s*/gm).map(s=>s.trim()).filter(Boolean);
        if (alt.length>1) parts = alt;
    }

    state.questions = parts.map(p => ({
        id: crypto.randomUUID(),
        text: p,
        image: '',
        imageSize: 100,
        lines: 3
    }));

    document.getElementById('question-input').value = '';
    saveState();
    renderQuestions();
    showMessage(`Geradas ${state.questions.length} questões.`, 'success');
}

/* ---------- Print / PDF ---------- */

function renderPrintableContent() {
    const pa = document.getElementById('print-area');
    pa.classList.remove('hidden');

    // read header values directly from DOM (ensures latest edits)
    const school = document.querySelector('[data-key="schoolName"]').textContent.trim();
    const teacher = document.querySelector('[data-key="teacher"]').textContent.trim();
    const subject = document.querySelector('[data-key="subject"]').textContent.trim();
    const student = document.querySelector('[data-key="student-name"]').textContent.trim();
    const title = document.getElementById('exam-title').textContent.trim();

    const logoHtml = state.header.logo ? `<div style="flex:0 0 auto;margin-right:12px;"><img src="${state.header.logo}" style="height:70px;object-fit:contain;"></div>` : '';

    const align = state.header.alignment === 'left' ? 'left' : state.header.alignment === 'center' ? 'center' : 'right';

    let html = `
        <div style="display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #999;padding-bottom:8px;margin-bottom:12px;">
            ${logoHtml}
            <div style="flex:1;text-align:${align};font-family:Arial, Helvetica, sans-serif;">
                <div style="font-weight:700;font-size:16px;margin-bottom:6px;">${escapeHtml(school)}</div>
                <div style="font-weight:700;margin-bottom:6px;">Aluno(a): <span style="display:inline-block;border-bottom:1px solid #000;padding:2px 6px;width:360px;">${escapeHtml(student)}</span></div>
                <div style="font-weight:700;margin-bottom:6px;">${escapeHtml(teacher)}</div>
                <div style="font-weight:700;margin-bottom:6px;">${escapeHtml(subject)}</div>
            </div>
        </div>
        <div style="text-align:center;font-weight:700;font-size:18px;margin-bottom:12px;">${escapeHtml(title)}</div>
    `;

    state.questions.forEach((q,idx) => {
        html += `<div style="margin-bottom:18px;font-family:Arial, Helvetica, sans-serif;">
                    <p style="margin:0 0 8px 0;font-size:14px;line-height:1.4;">
                        <strong style="margin-right:8px;">${idx+1}.</strong>${escapeHtml(q.text)}
                    </p>`;
        if (q.image) {
            html += `<div style="text-align:center;margin:10px 0;"><img src="${q.image}" style="width:${q.imageSize}%;max-width:100%;display:inline-block;"></div>`;
        }
        for (let i=0;i<q.lines;i++) {
            html += `<div style="border-bottom:2px solid #000;min-height:18px;margin-top:6px;margin-bottom:6px;"></div>`;
        }
        html += `</div>`;
    });

    pa.innerHTML = html;
    return pa;
}

function exportPDF() {
    if (state.questions.length === 0) {
        showMessage('Nenhuma questão para exportar.', 'error');
        return;
    }
    const el = renderPrintableContent();
    const filename = `${(document.getElementById('exam-title').textContent || 'Prova').replace(/\s+/g,'_')}_${new Date().toLocaleDateString('pt-BR').replace(/\//g,'-')}.pdf`;
    html2pdf().from(el).set({
        margin: 10,
        filename,
        html2canvas: { scale: 2 },
        jsPDF: { unit:'mm', format:'a4', orientation:'portrait' }
    }).save().then(()=> {
        // optional: hide print-area after export
        el.classList.add('hidden');
    });
}

/* ---------- Drag & Drop helpers ---------- */

function handleDropOnQuestion(event, questionEl) {
    event.preventDefault();
    event.stopPropagation();
    questionEl.classList.remove('drag-highlight');

    const id = questionEl.getAttribute('data-id');
    const file = event.dataTransfer.files && event.dataTransfer.files[0];
    if (!file || !file.type.startsWith('image/')) {
        showMessage('Por favor, solte um arquivo de imagem.', 'error');
        return;
    }
    const reader = new FileReader();
    reader.onload = (ev) => {
        const q = state.questions.find(x=>x.id===id);
        if (q) {
            q.image = ev.target.result;
            q.imageSize = 90;
            saveState();
            renderQuestions();
            showMessage('Imagem adicionada na questão.', 'success');
        }
    };
    reader.readAsDataURL(file);
}

/* ---------- Event delegation ---------- */

document.addEventListener('DOMContentLoaded', () => {
    loadState();
    renderHeader();
    renderExamTitle();
    renderQuestions();

    // Header editable listeners (save on input)
    document.querySelector('[data-key="schoolName"]').addEventListener('input', (e)=> {
        state.header.schoolName = e.target.textContent.trim();
        saveState();
    });
    document.querySelector('[data-key="teacher"]').addEventListener('input', (e)=> {
        state.header.teacher = e.target.textContent.trim();
        saveState();
    });
    document.querySelector('[data-key="subject"]').addEventListener('input', (e)=> {
        state.header.subject = e.target.textContent.trim();
        saveState();
    });
    document.querySelector('[data-key="student-name"]').addEventListener('input', (e)=> {
        state.header.studentText = e.target.textContent.trim();
        saveState();
    });

    // Title
    document.getElementById('exam-title').addEventListener('input', (e)=> {
        state.examTitle = e.target.textContent.trim();
        saveState();
    });

    // Logo - click opens file input
    const logoContainer = document.getElementById('logo-container');
    const logoUpload = document.getElementById('logo-upload');
    logoContainer.addEventListener('click', ()=> logoUpload.click());
    logoUpload.addEventListener('change', (e)=> {
        const f = e.target.files[0];
        if (!f) return;
        const r = new FileReader();
        r.onload = (ev)=> {
            state.header.logo = ev.target.result;
            saveState();
            renderHeader();
            showMessage('Logo carregada.', 'success');
        };
        r.readAsDataURL(f);
    });

    // Logo drag events
    logoContainer.addEventListener('dragover', (e)=> { e.preventDefault(); logoContainer.classList.add('drag-highlight'); });
    logoContainer.addEventListener('dragleave', (e)=> { e.preventDefault(); logoContainer.classList.remove('drag-highlight'); });
    logoContainer.addEventListener('drop', (e)=> {
        e.preventDefault();
        logoContainer.classList.remove('drag-highlight');
        const f = e.dataTransfer.files && e.dataTransfer.files[0];
        if (!f || !f.type.startsWith('image/')) { showMessage('Arraste uma imagem válida.', 'error'); return; }
        const r = new FileReader();
        r.onload = (ev)=> { state.header.logo = ev.target.result; saveState(); renderHeader(); showMessage('Logo adicionada.', 'success'); };
        r.readAsDataURL(f);
    });

    // Alignment buttons
    document.getElementById('align-left').addEventListener('click', ()=> { state.header.alignment = 'left'; saveState(); renderHeader(); });
    document.getElementById('align-center').addEventListener('click', ()=> { state.header.alignment = 'center'; saveState(); renderHeader(); });
    document.getElementById('align-right').addEventListener('click', ()=> { state.header.alignment = 'right'; saveState(); renderHeader(); });

    // Theme toggle
    document.getElementById('theme-toggle').addEventListener('click', ()=> {
        document.documentElement.classList.toggle('dark');
        state.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
        saveState();
    });

    // Main buttons
    document.getElementById('process-questions').addEventListener('click', processPastedText);
    document.getElementById('add-manual').addEventListener('click', addManualQuestion);
    document.getElementById('export-pdf').addEventListener('click', exportPDF);
    document.getElementById('clear-exam').addEventListener('click', ()=> {
        if (confirm('Deseja realmente limpar a prova?')) {
            localStorage.removeItem('examGeneratorState');
            state.header.logo = '';
            state.questions = [];
            state.header.schoolName = 'Nome da Escola';
            state.header.teacher = 'Professor(a):';
            state.header.subject = 'Componente curricular:';
            state.header.studentText = '';
            state.examTitle = 'Título da Prova';
            saveState();
            renderHeader();
            renderExamTitle();
            renderQuestions();
            showMessage('Prova limpa.', 'success');
        }
    });

    // Delegation for question-list clicks and inputs
    const qlist = document.getElementById('question-list');

    // click delegation (duplicate, remove, move)
    qlist.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;
        const container = btn.closest('[data-id]');
        if (!container) return;
        const id = container.getAttribute('data-id');

        if (btn.classList.contains('duplicate-btn')) duplicateQuestion(id);
        else if (btn.classList.contains('remove-btn')) removeQuestion(id);
        else if (btn.classList.contains('move-up-btn')) moveQuestionUp(id);
        else if (btn.classList.contains('move-down-btn')) moveQuestionDown(id);
        else if (btn.classList.contains('remove-image-btn')) {
            // remove image of that question
            const q = state.questions.find(x=>x.id===id);
            if (q) { q.image=''; q.imageSize=100; saveState(); renderQuestions(); showMessage('Imagem removida.', 'info'); }
        }
    });

    // input delegation: contenteditable question-text and sliders
    qlist.addEventListener('input', (e) => {
        const qtext = e.target.closest('.question-text');
        if (qtext) {
            const id = qtext.getAttribute('data-id');
            const q = state.questions.find(x=>x.id===id);
            if (q) { q.text = qtext.textContent.trim(); saveState(); }
            return;
        }

        // response lines slider
        if (e.target.classList.contains('response-lines-slider')) {
            const id = e.target.getAttribute('data-id');
            const q = state.questions.find(x=>x.id===id);
            if (q) {
                q.lines = parseInt(e.target.value,10);
                saveState();
                renderQuestions(); // re-render to update lines
            }
            return;
        }

        // image size slider
        if (e.target.classList.contains('image-size-slider')) {
            const id = e.target.getAttribute('data-id');
            const q = state.questions.find(x=>x.id===id);
            if (q) {
                q.imageSize = parseInt(e.target.value,10);
                saveState();
                // update inline img width if exists
                const cont = qlist.querySelector(`[data-id="${id}"]`);
                if (cont) {
                    const img = cont.querySelector('img');
                    if (img) img.style.width = q.imageSize + '%';
                }
            }
            return;
        }
    });

    // dragover / dragleave / drop delegation for question-list
    qlist.addEventListener('dragover', (e) => {
        const container = e.target.closest('[data-id]');
        if (container) {
            e.preventDefault();
            container.classList.add('drag-highlight');
        }
    });
    qlist.addEventListener('dragleave', (e) => {
        const container = e.target.closest('[data-id]');
        if (container) {
            container.classList.remove('drag-highlight');
        }
    });
    qlist.addEventListener('drop', (e) => {
        const container = e.target.closest('[data-id]');
        if (container) {
            handleDropOnQuestion(e, container);
        }
    });

    // allow dropping images directly on body too (optional)
    document.body.addEventListener('dragover', (e) => e.preventDefault());
    document.body.addEventListener('drop', (e) => { /* prevent default navigation */ e.preventDefault(); });

});

/* End DOMContentLoaded block */

/* ===========================
   Fim do script
   =========================== */
</script>
</body>
</html>
