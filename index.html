<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gerador de Provas — Flowmize</title>

<!--
README (no topo do arquivo)
---------------------------
Arquivo: index.html
O que é:
  Aplicativo web "Gerador de Provas" (único arquivo, sem backend). Permite criar, editar,
  visualizar e imprimir provas em A4 (portrait). Tudo salvo em localStorage.

Como usar (resumo rápido):
  1. Edite o cabeçalho da prova clicando nos campos (edição inline).
  2. Cole várias questões no campo "Colar/colocar questões" e clique em "Analisar e gerar".
     O sistema detecta numeração (1, 1., 1 -), gera questões editáveis e tenta detectar
     alternativas (A, B, C...). Você também pode "Adicionar questão manual".
  3. Em cada questão:
     - Edite texto inline;
     - Escolha número de linhas de resposta (1-5);
     - Adicione imagem (arrastar/soltar ou botão);
     - Ajuste tamanho da imagem (slider);
     - Marque gabarito (se houver alternativas, selecione a(s) correta(s));
     - Duplicar/remover/reordenar.
  4. Visualize na prévia A4 e clique em "Exportar PDF" (usa html2pdf.js).
     - Arquivo: Prova_{Componente}_{YYYY-MM-DD}.pdf
     - Opções: exportar prova normal, exportar prova + gabarito separado.
  5. Tudo é salvo automaticamente no localStorage.
  6. "Limpar prova" reseta tudo.

Extras implementados:
  - Tema claro/escuro que também afeta o PDF.
  - Detecção automática de alternativas A,B,C... no texto colado.
  - Gabarito: marcar respostas corretas e exportar PDF do gabarito separadamente.
  - Mensagens de erro amigáveis (ex.: imagem > 5MB).
  - Layout responsivo, acessível, com navegação por tab.
  
Dependência externa (apenas):
  - html2pdf.js via CDN (html2pdf.bundle.min.js)

Observações técnicas:
  - Todo estado é salvo em localStorage em "geradorDeProvas_v1".
  - Para adaptar para slides no futuro: função renderPreviewToDOM faz a renderização — pode ser reaproveitada.
-->

<style>
  :root{
    --bg: #f5f7fb;
    --panel: #ffffff;
    --muted: #6b7280;
    --accent: #0f62fe;
    --danger: #ef4444;
    --text: #0f1724;
    --paper-bg: #fff;
  }
  .dark {
    --bg: #0b1220;
    --panel: #071029;
    --muted: #9aa6b2;
    --accent: #66a0ff;
    --danger: #ff7b7b;
    --text: #e6eef8;
    --paper-bg: #0b1220;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background: linear-gradient(180deg, var(--bg), #e9eef8 120%);
    color:var(--text);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    min-height:100vh;
    padding:18px;
  }
  .app {
    max-width:1200px;
    margin:0 auto;
    display:grid;
    grid-template-columns: 420px 1fr;
    gap:18px;
    align-items:start;
  }
  header.app-header{
    grid-column:1/-1;
    display:flex;
    gap:12px;
    align-items:center;
    margin-bottom:8px;
  }
  h1{font-size:1.15rem;margin:0}
  .controls{display:flex;gap:8px;align-items:center;margin-left:auto}
  button, input[type="button"]{cursor:pointer}
  .card{
    background:var(--panel);
    border-radius:12px;
    padding:12px;
    box-shadow: 0 6px 18px rgba(12,20,40,0.06);
    border:1px solid rgba(15,23,36,0.04);
  }
  /* Left column */
  .left{
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  label.small{font-size:0.8rem;color:var(--muted);display:block;margin-bottom:6px}
  .inline-edit{
    display:flex;
    gap:8px;
    align-items:center;
  }
  .header-preview{
    display:grid;
    grid-template-columns:80px 1fr;
    gap:12px;
    align-items:center;
  }
  .logo-box{
    width:80px;height:80px;border-radius:8px;border:1px dashed rgba(0,0,0,0.06);
    display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(0,0,0,0.02),transparent);
    overflow:hidden;
  }
  .logo-box img{max-width:100%;max-height:100%;object-fit:contain}
  .toolbar{display:flex;gap:6px;flex-wrap:wrap}
  input[type="file"]{display:none}
  textarea{width:100%;min-height:120px;border-radius:8px;padding:10px;border:1px solid rgba(15,23,36,0.06);resize:vertical}
  .btn{
    background:var(--accent);color:white;padding:8px 12px;border-radius:8px;border:none;font-weight:600;
    box-shadow:0 6px 12px rgba(15,98,254,0.08)
  }
  .btn.ghost{background:transparent;color:var(--accent);box-shadow:none;border:1px solid rgba(15,98,254,0.09)}
  .btn.danger{background:var(--danger)}
  .small-btn{padding:6px 8px;border-radius:8px;font-size:0.9rem}
  .muted{color:var(--muted);font-size:0.9rem}
  .flex{display:flex;gap:8px;align-items:center}
  .questions-list{display:flex;flex-direction:column;gap:10px;max-height:52vh;overflow:auto;padding-right:6px}
  .q-card{border-radius:10px;padding:10px;border:1px solid rgba(12,18,28,0.05);display:flex;gap:10px;align-items:flex-start;background:linear-gradient(180deg,rgba(255,255,255,0.6),transparent)}
  .q-num{font-weight:700;min-width:30px}
  .q-body{flex:1}
  .inline-editable{
    padding:6px;border-radius:6px;border:1px dashed transparent;min-height:36px;
  }
  .inline-editable:focus{outline:none;border-color:rgba(15,98,254,0.15);background:linear-gradient(180deg,rgba(15,98,254,0.02),transparent)}
  .q-actions{display:flex;gap:6px;flex-direction:column}
  .small{font-size:0.85rem}
  input[type="range"]{width:100%}
  .muted-block{color:var(--muted);font-size:0.85rem;margin-top:6px}
  /* Right column: preview */
  .right{
    display:flex;flex-direction:column;gap:12px;
  }
  .preview-wrap{
    display:flex;gap:12px;flex-direction:column;align-items:center;
  }
  .a4{
    width:794px; /* A4 at 96dpi: 794x1123 */
    max-width:100%;
    height:1123px;
    background:var(--paper-bg);
    box-shadow:0 10px 30px rgba(11,20,40,0.12);
    border-radius:6px;
    padding:36px;
    box-sizing:border-box;
    overflow:hidden;
  }
  @media (max-width:1000px){
    .app{grid-template-columns:1fr; padding-bottom:60px}
    .a4{height:auto;min-height:1123px}
  }
  .paper-header{display:flex;gap:10px;align-items:center;margin-bottom:10px}
  .paper-header .logo{width:84px;height:84px;border-radius:8px;overflow:hidden;display:flex;align-items:center;justify-content:center;border:1px solid rgba(0,0,0,0.06)}
  .paper-header .meta{flex:1;display:grid;grid-template-columns:1fr 1fr;gap:6px}
  .meta .item{font-size:0.95rem}
  .meta .label{font-weight:700}
  .paper-body{margin-top:6px}
  .paper-q{margin-bottom:18px}
  .paper-q .q-text{margin-bottom:8px}
  .response-lines{display:flex;flex-direction:column;gap:8px}
  .response-line{border-bottom:1.5px solid #000;min-height:20px;padding-bottom:6px}
  /* alternatives */
  .alt-list{margin-left:12px;display:flex;flex-direction:column;gap:6px}
  .alt-item{display:flex;gap:8px;align-items:center}
  .gabarito{color:var(--danger);font-weight:700}
  /* small utilities */
  .center{text-align:center}
  .right-align{text-align:right}
  .align-controls{display:flex;gap:6px}
  .hint{font-size:0.82rem;color:var(--muted);margin-top:6px}
  footer.app-footer{grid-column:1/-1;margin-top:6px;color:var(--muted);font-size:0.9rem;display:flex;justify-content:space-between}
  .notice{background:linear-gradient(180deg,rgba(255,255,255,0.8),transparent);padding:10px;border-radius:8px;font-size:0.9rem}
  /* accessibility focus */
  button:focus, .inline-editable:focus, textarea:focus, input:focus { box-shadow: 0 0 0 3px rgba(15,98,254,0.09); outline:none; }
  /* dark theme styles adjustments for paper lines visibility */
  .dark .response-line{border-bottom:1.5px solid #e6eef8}
  /* small screen */
  @media (max-width:560px){
    .left{order:2}
    .right{order:1}
    .questions-list{max-height:28vh}
  }
</style>
</head>
<body>
<div class="app" id="app">
  <header class="app-header">
    <div>
      <h1>Gerador de Provas</h1>
      <div class="muted">Crie, edite e imprima provas em A4 — sem backend. Tudo salvo localmente.</div>
    </div>
    <div class="controls">
      <div class="muted small">Tema</div>
      <button id="toggleTheme" class="small-btn btn ghost" title="Alternar tema">Escuro / Claro</button>
      <div style="width:8px"></div>
      <button id="exportPdfBtn" class="btn small-btn" title="Exportar prova como PDF">Exportar PDF</button>
      <button id="exportGabaritoBtn" class="btn small-btn ghost" title="Exportar apenas gabarito">Exportar Gabarito</button>
      <button id="clearBtn" class="small-btn btn danger" title="Limpar prova">Limpar prova</button>
    </div>
  </header>

  <!-- Left column: editor controls -->
  <div class="left">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>Cabeçalho da prova</strong>
        <div class="align-controls" aria-label="Alinhamento do cabeçalho">
          <button class="small-btn ghost" data-align="left" title="Alinhar à esquerda">◀</button>
          <button class="small-btn ghost" data-align="center" title="Centralizar">•</button>
          <button class="small-btn ghost" data-align="right" title="Alinhar à direita">▶</button>
        </div>
      </div>
      <div class="header-preview">
        <label class="logo-box" id="logoDrop" title="Arraste/solte ou clique para enviar logo">
          <input id="logoInput" type="file" accept="image/*">
          <span id="logoPlaceholder" class="muted">Logo (arrastar)</span>
        </label>
        <div>
          <div style="display:flex;gap:8px">
            <div style="flex:1">
              <div class="small muted">Nome da escola</div>
              <div class="inline-editable" contenteditable="true" id="fieldSchool">UNIDADE INTEGRADA JOSÉ JOAQUIM DE ARAÚJO</div>
            </div>
            <div style="width:140px">
              <div class="small muted">Data</div>
              <div class="inline-editable" contenteditable="true" id="fieldDate">____/____/______</div>
            </div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
            <div>
              <div class="small muted">Aluno(a)</div>
              <div class="inline-editable" contenteditable="true" id="fieldStudent">_____________________________________________</div>
            </div>
            <div>
              <div class="small muted">Nota</div>
              <div class="inline-editable" contenteditable="true" id="fieldGrade">______</div>
            </div>
            <div>
              <div class="small muted">Professor(a)</div>
              <div class="inline-editable" contenteditable="true" id="fieldTeacher">RENIMAR ALMEIDA</div>
            </div>
            <div>
              <div class="small muted">Ano/Turma</div>
              <div class="inline-editable" contenteditable="true" id="fieldClass">______</div>
            </div>
            <div style="grid-column:1/-1;margin-top:6px">
              <div class="small muted">Componente curricular</div>
              <div class="inline-editable" contenteditable="true" id="fieldComponent">INGLÊS</div>
            </div>
          </div>
        </div>
      </div>
      <div class="hint">Clique em qualquer campo para editar — alterações salvas automaticamente.</div>
    </div>

    <div class="card" aria-live="polite">
      <strong>Questões</strong>
      <div style="margin-top:8px">
        <label class="small muted">Colar/colar várias questões</label>
        <textarea id="pasteArea" placeholder="Cole aqui várias questões (ex.: 1. Questão..., 2) Outra...). O sistema detecta numeração e alternativas."></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="analyzeBtn" class="btn small-btn">Analisar e gerar</button>
          <button id="addManualBtn" class="btn small-btn ghost">Adicionar questão manual</button>
          <button id="sampleBtn" class="btn small-btn ghost" title="Inserir exemplos">Inserir exemplos</button>
        </div>
        <div class="hint">Detecta numeração 1, 1., 1 -) e alternativas A), A., A -). Se colar texto sem numeração, será criado como uma única questão.</div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>Lista de questões</strong>
        <div class="muted small">Total: <span id="totalCount">0</span></div>
      </div>
      <div class="questions-list" id="questionsList" tabindex="0" aria-label="Lista de questões"></div>
    </div>

    <div class="card">
      <strong>Opções</strong>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
        <button id="saveBtn" class="btn ghost small-btn">Forçar salvar</button>
        <button id="loadBtn" class="btn ghost small-btn">Carregar salvo</button>
        <button id="clearLocalBtn" class="btn ghost small-btn danger">Limpar localStorage</button>
      </div>
      <div class="hint" style="margin-top:8px">Arquivos de imagem > 5MB não são carregados — mensagem de erro será mostrada.</div>
    </div>
  </div>

  <!-- Right column: preview + export -->
  <div class="right">
    <div class="card preview-wrap">
      <div style="display:flex;justify-content:space-between;align-items:center;width:100%">
        <strong>Pré-visualização (A4 - retrato)</strong>
        <div style="display:flex;gap:10px;align-items:center">
          <label class="muted small">Tema do PDF</label>
          <select id="pdfTheme" aria-label="Tema do PDF" style="padding:6px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)">
            <option value="current">Usar tema atual</option>
            <option value="light">Claro</option>
            <option value="dark">Escuro</option>
          </select>
        </div>
      </div>

      <div id="previewContainer" class="a4" role="document" aria-label="Pré-visualização da prova">
        <!-- Conteúdo renderizado por JS -->
      </div>

      <div style="display:flex;gap:8px;margin-top:8px;justify-content:space-between;align-items:center;width:100%">
        <div class="muted">As linhas de resposta usam <code>border-bottom:1.5px solid #000</code>.</div>
        <div style="display:flex;gap:8px">
          <button id="exportPdfBtn2" class="btn">Exportar PDF</button>
          <button id="exportGabaritoBtn2" class="btn ghost">Exportar Gabarito</button>
        </div>
      </div>
    </div>

    <div class="card">
      <strong>Mensagens</strong>
      <div id="logArea" class="muted-block">Pronto — carregue ou crie sua prova.</div>
    </div>
  </div>

  <footer class="app-footer">
    <div>Desenvolvido para Flowmize · Gerador de Provas (offline)</div>
    <div>Atalhos: TAB navega entre campos — arraste imagens para adicionar</div>
  </footer>
</div>

<!-- html2pdf (única dependência externa necessária) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

<script>
/* =========================
   Gerador de Provas v1
   Tudo salvo em localStorage: chave "geradorDeProvas_v1"
   Comentários em português para facilitar manutenção.
   ========================= */

(function(){
  // ---------- util ----------
  const qs = (sel,root=document) => root.querySelector(sel);
  const qsa = (sel,root=document) => Array.from(root.querySelectorAll(sel));
  const STORAGE_KEY = 'geradorDeProvas_v1';
  const MAX_IMAGE_MB = 5;

  // ---------- estado inicial ----------
  let state = {
    header: {
      school: 'UNIDADE INTEGRADA JOSÉ JOAQUIM DE ARAÚJO',
      date: '____/____/______',
      student: '_____________________________________________',
      teacher: 'RENIMAR ALMEIDA',
      component: 'INGLÊS',
      class: '______',
      grade: '______',
      logoData: null,
      align: 'left' // left, center, right
    },
    questions: [
      // estrutura de exemplo de uma questão:
      // { id:'q_1', text:'Questão...', lines:3, imageData:null, imageScale:70, alternatives: ['A Texto','B Texto'], correct: [0], shortAnswer:'' }
    ],
    theme: 'light' // light | dark
  };

  // ---------- elementos ----------
  const previewContainer = qs('#previewContainer');
  const logoInput = qs('#logoInput');
  const logoDrop = qs('#logoDrop');
  const logoPlaceholder = qs('#logoPlaceholder');
  const fieldIds = {
    school: 'fieldSchool', date:'fieldDate', student:'fieldStudent',
    teacher:'fieldTeacher', component:'fieldComponent', class:'fieldClass', grade:'fieldGrade'
  };

  const questionsList = qs('#questionsList');
  const pasteArea = qs('#pasteArea');
  const analyzeBtn = qs('#analyzeBtn');
  const addManualBtn = qs('#addManualBtn');
  const sampleBtn = qs('#sampleBtn');
  const totalCount = qs('#totalCount');
  const logArea = qs('#logArea');
  const clearBtn = qs('#clearBtn');
  const clearLocalBtn = qs('#clearLocalBtn');
  const saveBtn = qs('#saveBtn');
  const loadBtn = qs('#loadBtn');
  const toggleThemeBtn = qs('#toggleTheme');
  const exportPdfBtn = qs('#exportPdfBtn';
  ) // placeholder to satisfy linter
  // small fix: above line accidental; reassign correctly below.

})();

</script>

<!-- Script real -->
<script>
/* Main script start */
(() => {
  const STORAGE_KEY = 'geradorDeProvas_v1';
  const MAX_IMAGE_MB = 5;
  const qs = (s, r=document) => r.querySelector(s);
  const qsa = (s, r=document) => Array.from(r.querySelectorAll(s));
  const rndId = (p='q') => p + '_' + Math.random().toString(36).slice(2,9);

  // DOM refs
  const previewContainer = qs('#previewContainer');
  const logoInput = qs('#logoInput');
  const logoDrop = qs('#logoDrop');
  const logoPlaceholder = qs('#logoPlaceholder');
  const questionsList = qs('#questionsList');
  const pasteArea = qs('#pasteArea');
  const analyzeBtn = qs('#analyzeBtn');
  const addManualBtn = qs('#addManualBtn');
  const sampleBtn = qs('#sampleBtn');
  const totalCount = qs('#totalCount');
  const logArea = qs('#logArea');
  const clearBtn = qs('#clearBtn');
  const clearLocalBtn = qs('#clearLocalBtn');
  const saveBtn = qs('#saveBtn');
  const loadBtn = qs('#loadBtn');
  const toggleThemeBtn = qs('#toggleTheme');
  const exportPdfBtnTop = qs('#exportPdfBtn');
  const exportGabaritoBtnTop = qs('#exportGabaritoBtn');
  const exportPdfBtnBottom = qs('#exportPdfBtn2');
  const exportGabaritoBtnBottom = qs('#exportGabaritoBtn2');
  const pdfTheme = qs('#pdfTheme');

  // header fields
  const headerFields = {
    school: qs('#fieldSchool'),
    date: qs('#fieldDate'),
    student: qs('#fieldStudent'),
    teacher: qs('#fieldTeacher'),
    component: qs('#fieldComponent'),
    class: qs('#fieldClass'),
    grade: qs('#fieldGrade')
  };

  // state
  let state = {
    header: {
      school: 'UNIDADE INTEGRADA JOSÉ JOAQUIM DE ARAÚJO',
      date: '____/____/______',
      student: '_____________________________________________',
      teacher: 'RENIMAR ALMEIDA',
      component: 'INGLÊS',
      class: '______',
      grade: '______',
      logoData: null,
      align: 'left'
    },
    questions: [],
    theme: 'light' // 'light' | 'dark'
  };

  // ---------- persistence ----------
  function saveState() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      flash('Salvo automaticamente');
    } catch (e) {
      console.error('Erro ao salvar', e);
      flash('Erro ao salvar no localStorage', true);
    }
  }
  function loadState() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return false;
    try {
      const parsed = JSON.parse(raw);
      state = parsed;
      flash('Prova carregada do localStorage');
      return true;
    } catch (e) {
      console.error('Erro parse localStorage', e);
      return false;
    }
  }
  function clearState() {
    localStorage.removeItem(STORAGE_KEY);
    state = { header: { school:'UNIDADE INTEGRADA JOSÉ JOAQUIM DE ARAÚJO', date:'____/____/______', student:'_____________________________________________', teacher:'RENIMAR ALMEIDA', component:'INGLÊS', class:'______', grade:'______', logoData:null, align:'left' }, questions: [], theme:'light' };
    renderAll();
    flash('Prova reiniciada');
  }

  // ---------- utils ----------
  function flash(msg, isError=false) {
    logArea.textContent = msg;
    logArea.style.color = isError ? 'var(--danger)' : '';
    setTimeout(()=>{ logArea.style.color=''; }, 3500);
  }

  // detect numbered questions and alternatives
  function parseQuestionsFromText(text) {
    // Normalize newlines
    if (!text || !text.trim()) return [];
    text = text.replace(/\r/g,'');
    // Split into blocks by lines that look like question starts:
    // Recognize patterns: ^\s*\d+[\.\-\)]?\s
    // We'll split by positions where a line starts with a number token.
    const lines = text.split('\n');
    const blocks = [];
    let cur = [];
    for (let line of lines) {
      if (/^\s*\d+\s*[\.\-\)]?\s/.test(line) && cur.length>0) {
        blocks.push(cur.join('\n').trim());
        cur = [line];
      } else {
        cur.push(line);
      }
    }
    if (cur.length) blocks.push(cur.join('\n').trim());
    // If blocks empty, treat whole text as single question
    if (blocks.length===0 && text.trim()) blocks.push(text.trim());
    // For each block, try to extract question text and alternatives
    const result = blocks.map(block => {
      // remove leading numbering like "1.", "1 -", "1)"
      const b = block.replace(/^\s*\d+\s*[\.\-\)]?\s*/,'').trim();
      // try to detect alternatives lines starting with letters A,B,C...
      const bLines = b.split('\n').map(l=>l.trim()).filter(Boolean);
      const altLines = bLines.filter(l => /^[A-D]\s*[\.\-\)]\s*/i.test(l) || /^[A-D]\s*[:\-]\s*/i.test(l) || /^[A-D]\s+\w+/i.test(l));
      let alternatives = null;
      let textOnly = b;
      if (altLines.length >= 2) {
        // find index of first alternative line and separate
        let idx = bLines.findIndex(l => altLines.includes(l));
        textOnly = bLines.slice(0, idx).join(' ');
        alternatives = bLines.slice(idx).map(l => l.replace(/^[A-D]\s*[\.\-\):]?\s*/i,'').trim());
      } else {
        // also try alternatives like "a) ..." lowercase or "A) ..." inline with commas
        const inlineAlt = b.match(/(?:A\)|A\.|A -)\s*([^B]+)/i);
        // skip
      }
      // Map to object
      return {
        id: rndId('q'),
        text: textOnly || b,
        lines: 3,
        imageData: null,
        imageScale: 70,
        alternatives: alternatives ? alternatives : null, // array or null
        correct: [], // indices of correct alternatives
        shortAnswer: ''
      };
    });
    return result;
  }

  // ---------- rendering editor list ----------
  function renderQuestionsList() {
    questionsList.innerHTML = '';
    state.questions.forEach((q, idx) => {
      const div = document.createElement('div');
      div.className = 'q-card';
      div.dataset.id = q.id;
      // left num
      const num = document.createElement('div'); num.className='q-num'; num.textContent = (idx+1)+'.';
      const body = document.createElement('div'); body.className='q-body';
      // editable text
      const textBox = document.createElement('div');
      textBox.className='inline-editable';
      textBox.contentEditable = true;
      textBox.innerText = q.text || '';
      textBox.addEventListener('input', (e)=> {
        q.text = textBox.innerText;
        scheduleSave();
        renderPreview();
      });
      // controls: lines, image, alt/gabarito
      const controls = document.createElement('div');
      controls.style.marginTop = '8px';
      controls.innerHTML = `
        <div style="display:flex;gap:8px;align-items:center">
          <label class="small muted">Linhas</label>
          <select class="line-select small-btn" aria-label="Número de linhas">
            <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option>
          </select>
          <label class="small muted">Imagem</label>
          <button class="img-btn small-btn ghost">Enviar</button>
          <button class="dup-btn small-btn ghost">Duplicar</button>
          <button class="del-btn small-btn ghost">Remover</button>
          <button class="up-btn small-btn ghost">↑</button>
          <button class="down-btn small-btn ghost">↓</button>
        </div>
      `;
      // append alt/gabarito UI
      const altWrap = document.createElement('div');
      altWrap.style.marginTop = '8px';
      if (q.alternatives && q.alternatives.length) {
        const altList = document.createElement('div');
        altList.className = 'alt-list';
        q.alternatives.forEach((alt, ai) => {
          const altItem = document.createElement('label');
          altItem.className = 'alt-item';
          const radio = document.createElement('input');
          radio.type = 'checkbox';
          radio.checked = q.correct.includes(ai);
          radio.addEventListener('change', ()=> {
            if (radio.checked) q.correct.push(ai);
            else q.correct = q.correct.filter(x=>x!==ai);
            scheduleSave();
          });
          const span = document.createElement('div');
          span.textContent = String.fromCharCode(65+ai) + '. ' + alt;
          altItem.appendChild(radio);
          altItem.appendChild(span);
          altList.appendChild(altItem);
        });
        altWrap.appendChild(altList);
      } else {
        const shortLabel = document.createElement('div');
        shortLabel.className = 'muted-block';
        shortLabel.textContent = 'Gabarito (resposta curta):';
        const shortInput = document.createElement('input');
        shortInput.type = 'text';
        shortInput.className = 'inline-editable';
        shortInput.style.display='block';
        shortInput.style.width='100%';
        shortInput.value = q.shortAnswer || '';
        shortInput.addEventListener('input', ()=> { q.shortAnswer = shortInput.value; scheduleSave(); });
        altWrap.appendChild(shortLabel);
        altWrap.appendChild(shortInput);
      }
      // image preview and slider
      const imgWrap = document.createElement('div');
      imgWrap.style.marginTop = '8px';
      if (q.imageData) {
        const img = document.createElement('img');
        img.src = q.imageData;
        img.style.maxWidth = '120px';
        img.style.display = 'block';
        img.style.marginTop = '6px';
        img.style.borderRadius = '6px';
        imgWrap.appendChild(img);
        const removeImgBtn = document.createElement('button'); removeImgBtn.className='small-btn ghost'; removeImgBtn.textContent='Remover imagem';
        removeImgBtn.addEventListener('click', ()=> { q.imageData = null; scheduleSave(); renderAll(); });
        const scaleLabel = document.createElement('div'); scaleLabel.className='muted-block'; scaleLabel.textContent='Tamanho imagem';
        const scaleRange = document.createElement('input'); scaleRange.type='range'; scaleRange.min=30; scaleRange.max=100; scaleRange.value=q.imageScale||70;
        scaleRange.addEventListener('input', ()=> { q.imageScale = Number(scaleRange.value); scheduleSave(); renderAll(); });
        imgWrap.appendChild(scaleLabel); imgWrap.appendChild(scaleRange); imgWrap.appendChild(removeImgBtn);
      }

      // wire buttons
      const lineSelect = controls.querySelector('.line-select');
      lineSelect.value = (q.lines||3).toString();
      lineSelect.addEventListener('change', ()=> { q.lines = Number(lineSelect.value); scheduleSave(); renderPreview(); });

      const imgBtn = controls.querySelector('.img-btn');
      imgBtn.addEventListener('click', ()=> {
        // trigger file input
        const tmp = document.createElement('input'); tmp.type='file'; tmp.accept='image/*';
        tmp.onchange = (e) => {
          const f = e.target.files[0];
          if (!f) return;
          if ((f.size/1024/1024) > MAX_IMAGE_MB) { flash('Imagem muito grande. Máx ' + MAX_IMAGE_MB + 'MB', true); return; }
          const reader = new FileReader();
          reader.onload = (ev)=> { q.imageData = ev.target.result; scheduleSave(); renderAll(); };
          reader.readAsDataURL(f);
        };
        tmp.click();
      });

      const dupBtn = controls.querySelector('.dup-btn');
      dupBtn.addEventListener('click', ()=> {
        const newQ = JSON.parse(JSON.stringify(q));
        newQ.id = rndId('q'); state.questions.splice(idx+1,0,newQ); scheduleSave(); renderAll();
      });

      const delBtn = controls.querySelector('.del-btn');
      delBtn.addEventListener('click', ()=> {
        if (!confirm('Remover questão?')) return;
        state.questions.splice(idx,1); scheduleSave(); renderAll();
      });

      const upBtn = controls.querySelector('.up-btn');
      upBtn.addEventListener('click', ()=> {
        if (idx===0) return;
        const [item] = state.questions.splice(idx,1);
        state.questions.splice(idx-1,0,item);
        scheduleSave(); renderAll();
      });

      const downBtn = controls.querySelector('.down-btn');
      downBtn.addEventListener('click', ()=> {
        if (idx===state.questions.length-1) return;
        const [item] = state.questions.splice(idx,1);
        state.questions.splice(idx+1,0,item);
        scheduleSave(); renderAll();
      });

      // assemble
      body.appendChild(textBox);
      body.appendChild(controls);
      if (imgWrap.children.length) body.appendChild(imgWrap);
      body.appendChild(altWrap);

      // append to card
      div.appendChild(num);
      div.appendChild(body);

      // small aria and drag-drop for images
      div.addEventListener('dragover', (ev)=>{ ev.preventDefault(); div.style.opacity=0.8; });
      div.addEventListener('dragleave', ()=>{ div.style.opacity=1; });
      div.addEventListener('drop', (ev)=> {
        ev.preventDefault(); div.style.opacity=1;
        const f = ev.dataTransfer.files && ev.dataTransfer.files[0];
        if (f && f.type.startsWith('image/')) {
          if ((f.size/1024/1024) > MAX_IMAGE_MB) { flash('Imagem muito grande. Máx ' + MAX_IMAGE_MB + 'MB', true); return; }
          const reader = new FileReader();
          reader.onload = (e)=> { q.imageData = e.target.result; scheduleSave(); renderAll(); };
          reader.readAsDataURL(f);
        }
      });

      questionsList.appendChild(div);
    });
    totalCount.textContent = state.questions.length;
  }

  // ---------- render preview ----------
  function renderPreview() {
    // create DOM for preview inside previewContainer
    const header = state.header;
    const paper = document.createElement('div');
    paper.className = 'paper';
    // build header
    const ph = document.createElement('div'); ph.className = 'paper-header';
    // Logo
    const logoBox = document.createElement('div'); logoBox.className='logo';
    if (header.logoData) {
      const img = document.createElement('img');
      img.src = header.logoData;
      img.style.maxWidth='100%'; img.style.maxHeight='100%'; img.alt='Logo';
      logoBox.appendChild(img);
    } else {
      const sp = document.createElement('div'); sp.className='muted'; sp.textContent='LOGO';
      logoBox.appendChild(sp);
    }
    ph.appendChild(logoBox);
    // meta grid
    const meta = document.createElement('div'); meta.className='meta';
    const leftCol = document.createElement('div'); leftCol.className='item';
    leftCol.innerHTML = `<div><span class="label">Escola: </span><span>${header.school}</span></div>
                         <div><span class="label">Aluno(a): </span><span>${header.student}</span></div>`;
    const rightCol = document.createElement('div'); rightCol.className='item';
    rightCol.innerHTML = `<div><span class="label">Professor(a): </span><span>${header.teacher}</span></div>
                          <div><span class="label">Nota: </span><span>${header.grade}</span></div>`;
    meta.appendChild(leftCol);
    meta.appendChild(rightCol);
    // second row with component & class & date
    const meta2 = document.createElement('div'); meta2.className='meta';
    meta2.style.marginTop='8px';
    meta2.innerHTML = `<div class="item"><span class="label">Componente: </span><span>${header.component}</span></div>
                       <div class="item"><span class="label">Ano/Turma: </span><span>${header.class}</span></div>
                       <div class="item"><span class="label">Data: </span><span>${header.date}</span></div>`;
    // combine
    const metaWrap = document.createElement('div');
    metaWrap.style.display='flex'; metaWrap.style.flexDirection='column';
    metaWrap.appendChild(meta);
    metaWrap.appendChild(meta2);
    ph.appendChild(metaWrap);
    paper.appendChild(ph);

    // body: questions
    const pb = document.createElement('div'); pb.className='paper-body';
    state.questions.forEach((q, i) => {
      const pq = document.createElement('div'); pq.className='paper-q';
      const qtext = document.createElement('div'); qtext.className='q-text'; qtext.innerText = (i+1) + '. ' + (q.text || '');
      pq.appendChild(qtext);
      // image if exists
      if (q.imageData) {
        const img = document.createElement('img'); img.src = q.imageData;
        img.style.maxWidth = (q.imageScale||70) + '%';
        img.style.display='block'; img.style.margin='8px 0'; img.style.borderRadius='6px';
        pq.appendChild(img);
      }
      // alternatives
      if (q.alternatives && q.alternatives.length) {
        const altList = document.createElement('div'); altList.className='alt-list';
        q.alternatives.forEach((alt, ai) => {
          const altItem = document.createElement('div'); altItem.className='alt-item';
          altItem.textContent = String.fromCharCode(65+ai) + '. ' + alt;
          altList.appendChild(altItem);
        });
        pq.appendChild(altList);
      }
      // response lines
      const linesWrap = document.createElement('div'); linesWrap.className='response-lines';
      const lines = Math.max(1, Math.min(5, q.lines || 3));
      for (let r=0;r<lines;r++){
        const ln = document.createElement('div'); ln.className='response-line'; ln.setAttribute('aria-hidden','true');
        ln.style.minHeight = '18px';
        // add extra spacing for first line if alternatives exist
        linesWrap.appendChild(ln);
      }
      pq.appendChild(linesWrap);
      // gabarito marker (hidden in main prova PDF, but we can show when exporting gabarito)
      paper.appendChild(pq);
    });
    // replace previewContainer content
    previewContainer.innerHTML = '';
    previewContainer.appendChild(paper);

    // apply alignment
    previewContainer.style.textAlign = state.header.align || 'left';
  }

  // ---------- renderEverything ----------
  function renderAll() {
    // set header fields values
    Object.keys(headerFields).forEach(k => {
      const el = headerFields[k];
      el.innerText = state.header[k] || '';
      // attach input listener only once
      el.oninput = (e)=> {
        state.header[k] = el.innerText; scheduleSave();
        renderPreview();
      };
    });

    // logo
    if (state.header.logoData) {
      logoPlaceholder.style.display = 'none';
      logoDrop.style.background = 'transparent';
      // show small thumbnail inside drop area
      logoDrop.innerHTML = `<img src="${state.header.logoData}" style="max-width:100%;max-height:100%;object-fit:contain;border-radius:6px" alt="logo" />`;
    } else {
      logoDrop.innerHTML = `<input id="logoInput" type="file" accept="image/*" /><span id="logoPlaceholder" class="muted">Logo (arrastar)</span>`;
      // rebind logoInput
      const ni = logoDrop.querySelector('#logoInput');
      ni.addEventListener('change', (e)=> {
        const f = e.target.files[0];
        if (!f) return;
        if ((f.size/1024/1024) > MAX_IMAGE_MB) { flash('Imagem muito grande. Máx ' + MAX_IMAGE_MB + 'MB', true); return; }
        const reader = new FileReader();
        reader.onload = (ev)=> { state.header.logoData = ev.target.result; scheduleSave(); renderAll(); };
        reader.readAsDataURL(f);
      });
    }

    // update list
    renderQuestionsList();
    renderPreview();

    // apply theme
    document.documentElement.classList.toggle('dark', state.theme==='dark');
  }

  // ---------- dragging logo ----------
  (function bindLogoDrop(){
    const drop = qs('#logoDrop');
    drop.addEventListener('dragover', (e)=>{ e.preventDefault(); drop.style.opacity=0.8; });
    drop.addEventListener('dragleave', ()=>{ drop.style.opacity=1; });
    drop.addEventListener('drop', (e)=> {
      e.preventDefault(); drop.style.opacity=1;
      const f = e.dataTransfer.files && e.dataTransfer.files[0];
      if (f && f.type.startsWith('image/')) {
        if ((f.size/1024/1024) > MAX_IMAGE_MB) { flash('Logo muito grande. Máx ' + MAX_IMAGE_MB + 'MB', true); return; }
        const reader = new FileReader();
        reader.onload = (ev)=> { state.header.logoData = ev.target.result; scheduleSave(); renderAll(); };
        reader.readAsDataURL(f);
      }
    });
    // click input
    drop.addEventListener('click', ()=> {
      const tmp = document.createElement('input'); tmp.type='file'; tmp.accept='image/*';
      tmp.onchange = (e)=> {
        const f = e.target.files[0];
        if (!f) return;
        if ((f.size/1024/1024) > MAX_IMAGE_MB) { flash('Logo muito grande. Máx ' + MAX_IMAGE_MB + 'MB', true); return; }
        const reader = new FileReader();
        reader.onload = (ev)=> { state.header.logoData = ev.target.result; scheduleSave(); renderAll(); };
        reader.readAsDataURL(f);
      };
      tmp.click();
    });
  })();

  // ---------- actions ----------
  analyzeBtn.addEventListener('click', ()=> {
    const text = pasteArea.value;
    const parsed = parseQuestionsFromText(text);
    if (parsed.length===0) {
      // if no detected blocks, create a single question
      flash('Nenhuma questão detectada no texto colado.', true);
      return;
    }
    // append parsed
    state.questions = state.questions.concat(parsed);
    scheduleSave();
    renderAll();
    flash(parsed.length + ' questão(ões) adicionada(s).');
  });

  addManualBtn.addEventListener('click', ()=> {
    state.questions.push({ id: rndId('q'), text:'Nova questão...', lines:3, imageData:null, imageScale:70, alternatives:null, correct:[], shortAnswer:'' });
    scheduleSave(); renderAll();
  });

  sampleBtn.addEventListener('click', ()=> {
    const sample = `1. Leia o texto e responda: What is the main idea?
A) Option one
B) Option two
C) Option three
2. Escreva uma pequena frase em inglês sobre sua escola.
3) Observe a imagem e descreva o que vê.`;
    pasteArea.value = sample;
    flash('Exemplos inseridos no campo de colar. Clique em "Analisar e gerar".');
  });

  // Re-implement parseQuestionsFromText here (duplicated for scope)
  function parseQuestionsFromText(text) {
    if (!text || !text.trim()) return [];
    text = text.replace(/\r/g,'');
    const lines = text.split('\n');
    const blocks = [];
    let cur = [];
    for (let line of lines) {
      if (/^\s*\d+\s*[\.\-\)]?\s/.test(line) && cur.length>0) {
        blocks.push(cur.join('\n').trim());
        cur = [line];
      } else {
        cur.push(line);
      }
    }
    if (cur.length) blocks.push(cur.join('\n').trim());
    if (blocks.length===0 && text.trim()) blocks.push(text.trim());
    return blocks.map(block => {
      const b = block.replace(/^\s*\d+\s*[\.\-\)]?\s*/,'').trim();
      const bLines = b.split('\n').map(l=>l.trim()).filter(Boolean);
      // detect alternatives if lines start with A), B), etc.
      let altStart = -1;
      for (let i=0;i<bLines.length;i++){
        if (/^[A-D]\s*[\.\-\):]/i.test(bLines[i]) || /^[A-D]\s*:/.test(bLines[i])) { altStart = i; break; }
      }
      let alternatives = null;
      let textOnly = b;
      if (altStart >= 0) {
        textOnly = bLines.slice(0, altStart).join(' ');
        alternatives = bLines.slice(altStart).map(l => l.replace(/^[A-D]\s*[\.\-\):]?\s*/i,'').trim());
      }
      return { id: rndId('q'), text: textOnly || b, lines:3, imageData:null, imageScale:70, alternatives: alternatives, correct:[], shortAnswer:'' };
    });
  }

  // ---------- save / load / autosave ----------
  let saveTimer = null;
  function scheduleSave() {
    if (saveTimer) clearTimeout(saveTimer);
    saveTimer = setTimeout(()=> {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      flash('Alterações salvas');
    }, 700);
    // update preview quickly
    renderPreview();
    renderQuestionsList();
  }

  saveBtn.addEventListener('click', ()=> {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    flash('Salvo manualmente');
  });

  loadBtn.addEventListener('click', ()=> {
    if (localStorage.getItem(STORAGE_KEY)) {
      try {
        state = JSON.parse(localStorage.getItem(STORAGE_KEY));
        renderAll();
        flash('Carregado do localStorage');
      } catch (e) { flash('Erro ao carregar estado', true); }
    } else flash('Nenhum estado salvo localmente');
  });

  clearLocalBtn.addEventListener('click', ()=> {
    if (!confirm('Remover todos os dados salvos localmente?')) return;
    localStorage.removeItem(STORAGE_KEY);
    state.questions = []; state.header.logoData = null;
    renderAll();
    flash('localStorage limpo');
  });

  clearBtn.addEventListener('click', ()=> {
    if (!confirm('Limpar prova atual (não apaga localStorage salvo automaticamente)?')) return;
    state.questions = [];
    state.header = { school:'UNIDADE INTEGRADA JOSÉ JOAQUIM DE ARAÚJO', date:'____/____/______', student:'_____________________________________________', teacher:'RENIMAR ALMEIDA', component:'INGLÊS', class:'______', grade:'______', logoData:null, align:'left' };
    renderAll();
    scheduleSave();
  });

  // ---------- header alignment buttons ----------
  qsa('.align-controls button').forEach(btn => {
    btn.addEventListener('click', ()=> {
      const a = btn.dataset.align;
      state.header.align = a;
      scheduleSave();
      renderPreview();
    });
  });

  // ---------- theme toggle ----------
  toggleThemeBtn.addEventListener('click', ()=> {
    state.theme = (state.theme === 'dark') ? 'light' : 'dark';
    document.documentElement.classList.toggle('dark', state.theme==='dark');
    scheduleSave();
    flash('Tema alternado: ' + state.theme);
  });

  // ---------- export / pdf ----------
  function getExportFilename(type='Prova') {
    // Prova_{Componente}_{YYYY-MM-DD}.pdf
    const comp = (state.header.component || 'Prova').replace(/\s+/g,'_');
    const d = new Date();
    const iso = d.toISOString().slice(0,10);
    return `${type}_${comp}_${iso}.pdf`.replace(/[^\w\.\-_\u00C0-\u017F]/g,'');
  }

  async function exportPreviewAsPdf({ includeGabarito=false } = {}) {
    // clone previewContainer to make adjustments (like showing gabarito)
    const cloneWrap = previewContainer.cloneNode(true);
    // if includeGabarito, append answers at the end (or highlight)
    if (includeGabarito) {
      // For each question add a small "Gabarito: ..." below it
      const paperQs = cloneWrap.querySelectorAll('.paper-q');
      paperQs.forEach((pq, idx) => {
        const q = state.questions[idx];
        const gDiv = document.createElement('div');
        gDiv.style.marginTop = '6px';
        if (q.alternatives && q.alternatives.length && q.correct.length) {
          const letters = q.correct.map(i => String.fromCharCode(65 + i)).join(', ');
          gDiv.innerHTML = `<div class="gabarito">Gabarito: ${letters}</div>`;
        } else if (q.shortAnswer && q.shortAnswer.trim()) {
          gDiv.innerHTML = `<div class="gabarito">Gabarito: ${q.shortAnswer}</div>`;
        } else {
          gDiv.innerHTML = `<div class="gabarito">Gabarito: —</div>`;
        }
        pq.appendChild(gDiv);
      });
    }
    // apply theme choice for PDF
    const themeChoice = pdfTheme.value;
    if (themeChoice === 'light') cloneWrap.classList.remove('dark');
    else if (themeChoice === 'dark') cloneWrap.classList.add('dark');
    else {
      if (state.theme === 'dark') cloneWrap.classList.add('dark');
      else cloneWrap.classList.remove('dark');
    }

    // create a container element to export (wrap clone in a printable page)
    const exportEl = document.createElement('div');
    exportEl.style.background = 'white';
    exportEl.style.padding = '0';
    exportEl.appendChild(cloneWrap);

    // html2pdf options
    const opt = {
      margin: [10, 10, 10, 10],
      filename: getExportFilename(includeGabarito ? 'Gabarito' : 'Prova'),
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale:1.5, useCORS:true, allowTaint:true, logging:false },
      jsPDF: { unit:'pt', format:'a4', orientation:'portrait' }
    };
    // ensure dark mode styles applied by copying document styles? Simple approach: add inline background white to page (done).
    // Call html2pdf
    try {
      flash('Gerando PDF...');
      await html2pdf().set(opt).from(exportEl).save();
      flash('PDF gerado: ' + opt.filename);
    } catch (e) {
      console.error(e);
      flash('Erro ao gerar PDF', true);
    }
  }

  exportPdfBtnTop.addEventListener('click', ()=> exportPreviewAsPdf({ includeGabarito:false }));
  exportPdfBtnBottom.addEventListener('click', ()=> exportPreviewAsPdf({ includeGabarito:false }));
  exportGabaritoBtnTop.addEventListener('click', ()=> exportPreviewAsPdf({ includeGabarito:true }));
  exportGabaritoBtnBottom.addEventListener('click', ()=> exportPreviewAsPdf({ includeGabarito:true }));

  // ---------- load saved on start ----------
  (function init() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) {
      try {
        state = JSON.parse(raw);
      } catch (e) {
        console.warn('localStorage parse falhou, usando estado padrão', e);
      }
    } else {
      // seed with example questions for first-time users
      state.questions = [
        { id: rndId('q'), text: 'Leia o texto I e responda: Qual é o objetivo do texto I?', lines:3, imageData:null, imageScale:70, alternatives:null, correct:[], shortAnswer:'' },
        { id: rndId('q'), text: 'Leia o texto II e responda: Qual é a orientação dada no segundo texto?', lines:4, imageData:null, imageScale:70, alternatives:null, correct:[], shortAnswer:'' },
        { id: rndId('q'), text: 'O que os pôsteres apresentados têm em comum?', lines:3, imageData:null, imageScale:70, alternatives:['Eles oferecem orientações para evitar a propagação da covid-19.','São campanhas não governamentais.'], correct:[], shortAnswer:'' }
      ];
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }
    renderAll();
  })();

  // expose some helpers for debugging (window)
  window.geradorProvas = {
    state,
    save: () => localStorage.setItem(STORAGE_KEY, JSON.stringify(state)),
    load: () => {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) state = JSON.parse(raw);
    }
  };

  // small helpers used earlier in renderer scope (duplicated for closure)
  function renderQuestionsList() {
    const list = qs('#questionsList');
    list.innerHTML = '';
    state.questions.forEach((q, idx) => {
      const div = document.createElement('div');
      div.className='q-card';
      div.dataset.id=q.id;
      const num = document.createElement('div'); num.className='q-num'; num.textContent=(idx+1)+'.';
      const body = document.createElement('div'); body.className='q-body';
      const text = document.createElement('div'); text.className='inline-editable'; text.contentEditable=true; text.innerText=q.text||'';
      text.oninput = ()=> { q.text = text.innerText; scheduleSave(); renderPreview(); };
      body.appendChild(text);
      // small action buttons
      const actions = document.createElement('div'); actions.className='q-actions';
      const dup = document.createElement('button'); dup.className='small-btn ghost'; dup.textContent='Duplicar';
      dup.onclick = ()=> { const copy = JSON.parse(JSON.stringify(q)); copy.id=rndId('q'); state.questions.splice(idx+1,0,copy); scheduleSave(); renderAll(); };
      const rem = document.createElement('button'); rem.className='small-btn ghost'; rem.textContent='Remover';
      rem.onclick = ()=> { if (!confirm('Remover questão?')) return; state.questions.splice(idx,1); scheduleSave(); renderAll(); };
      const up = document.createElement('button'); up.className='small-btn ghost'; up.textContent='↑'; up.onclick = ()=> { if (idx===0) return; const [it]=state.questions.splice(idx,1); state.questions.splice(idx-1,0,it); scheduleSave(); renderAll(); };
      const down = document.createElement('button'); down.className='small-btn ghost'; down.textContent='↓'; down.onclick = ()=> { if (idx===state.questions.length-1) return; const [it]=state.questions.splice(idx,1); state.questions.splice(idx+1,0,it); scheduleSave(); renderAll(); };
      actions.appendChild(dup); actions.appendChild(rem); actions.appendChild(up); actions.appendChild(down);
      body.appendChild(actions);
      list.appendChild(num); list.appendChild(body);
    });
    qs('#totalCount').textContent = state.questions.length;
  }

  function renderPreview() {
    // reuse earlier implementation: regenerate innerHTML for previewContainer
    const header = state.header;
    const container = qs('#previewContainer');
    container.innerHTML = ''; // clear
    // paper
    const paper = document.createElement('div');
    paper.style.width='100%'; paper.style.height='100%';
    // header
    const ph = document.createElement('div'); ph.className='paper-header';
    const logo = document.createElement('div'); logo.className='logo';
    if (header.logoData) { const img=document.createElement('img'); img.src=header.logoData; img.style.maxWidth='100%'; img.style.maxHeight='100%'; logo.appendChild(img); } else { const sp=document.createElement('div'); sp.className='muted'; sp.textContent='LOGO'; logo.appendChild(sp); }
    ph.appendChild(logo);
    const meta = document.createElement('div'); meta.className='meta';
    meta.innerHTML = `<div class="item"><div class="label">Escola: </div><div>${header.school}</div></div>
                      <div class="item"><div class="label">Professor(a): </div><div>${header.teacher}</div></div>
                      <div class="item"><div class="label">Componente: </div><div>${header.component}</div></div>
                      <div class="item"><div class="label">Ano/Turma: </div><div>${header.class}</div></div>
                      <div class="item"><div class="label">Aluno(a): </div><div>${header.student}</div></div>
                      <div class="item"><div class="label">Data: </div><div>${header.date}</div></div>
                      <div class="item"><div class="label">Nota: </div><div>${header.grade}</div></div>`;
    ph.appendChild(meta);
    paper.appendChild(ph);
    // body
    const body = document.createElement('div'); body.className='paper-body';
    state.questions.forEach((q, idx) => {
      const pq = document.createElement('div'); pq.className='paper-q';
      const qtext = document.createElement('div'); qtext.className='q-text'; qtext.textContent = (idx+1)+'. ' + (q.text||'');
      pq.appendChild(qtext);
      if (q.imageData) {
        const img = document.createElement('img'); img.src=q.imageData; img.style.maxWidth=(q.imageScale||70)+'%'; img.style.display='block'; img.style.margin='8px 0'; pq.appendChild(img);
      }
      if (q.alternatives && q.alternatives.length) {
        const altList = document.createElement('div'); altList.className='alt-list';
        q.alternatives.forEach((alt, ai) => {
          const altItem = document.createElement('div'); altItem.className='alt-item'; altItem.textContent = String.fromCharCode(65+ai)+'. ' + alt;
          altList.appendChild(altItem);
        });
        pq.appendChild(altList);
      }
      const linesWrap = document.createElement('div'); linesWrap.className='response-lines';
      const lines = Math.max(1, Math.min(5, q.lines || 3));
      for (let i=0;i<lines;i++){
        const ln = document.createElement('div'); ln.className='response-line'; ln.style.minHeight='16px';
        linesWrap.appendChild(ln);
      }
      pq.appendChild(linesWrap);
      body.appendChild(pq);
    });
    paper.appendChild(body);
    container.appendChild(paper);
    container.style.textAlign = header.align || 'left';
    document.documentElement.classList.toggle('dark', state.theme==='dark');
  }

})();
</script>

</body>
</html>
