<!DOCTYPE html>
<html lang="pt-BR" class="antialiased">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gerador de Provas</title>

  <!-- Fonte e Tailwind CDN -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    body { font-family:'Inter',sans-serif; background:#f8fafc; color:#111827; margin:0; }
    .container { max-width:900px; margin:1.5rem auto; padding:1.5rem; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:.75rem; padding:1.25rem; box-shadow:0 6px 18px rgba(16,24,40,0.04); }
    [contenteditable]:focus { outline:none; box-shadow:0 0 0 3px rgba(59,130,246,0.12); border-radius:4px; }
    .fillable-line { display:inline-block; border-bottom:1px solid currentColor; margin-left:.5rem; min-width:150px; }
    .short-line { min-width:50px; }
    .question-line { border-bottom:2px solid #cbd5e1; min-height:1.2rem; margin:0.75rem 0; }
    .image-drop-area { border:2px dashed #d1d5db; background-color: rgba(0,0,0,0.02); padding:8px; border-radius:6px; text-align:center; cursor:pointer; }
    .image-drop-area.drag-over { border-color:#3b82f6; background-color: rgba(59,130,246,0.06); }
    #print-area { display:none; width:210mm; min-height:297mm; background:#fff; padding:24mm; box-sizing:border-box; }
    .no-print { display:none; }
  </style>
</head>
<body>

<div class="container" id="app">
  <!-- Header -->
  <div class="card mb-6 flex gap-4">
    <div style="flex:0 0 96px;">
      <div id="logo-container" class="relative w-24 h-24 p-2 border-2 border-dashed rounded-lg flex items-center justify-center overflow-hidden cursor-pointer">
        <input type="file" id="logo-upload" class="hidden" accept="image/*">
        <img id="logo-preview" class="w-full h-full object-contain" style="display:none;">
        <span id="logo-placeholder" class="text-sm text-gray-500">Arraste ou clique para adicionar a logo</span>
      </div>
    </div>
    <div style="flex:1;">
      <div id="header-info" class="flex flex-col items-end text-right">
        <div class="header-field text-lg font-bold" data-key="schoolName" contenteditable="true">Nome da Escola</div>
        <div class="header-field text-lg font-bold" data-key="student" contenteditable="true">Aluno(a): <span class="fillable-line"></span></div>
        <div class="header-field text-lg font-bold" data-key="teacher" contenteditable="true">Professor(a):</div>
        <div class="header-field text-lg font-bold" data-key="subject" contenteditable="true">Componente curricular:</div>
        <div class="header-field text-lg font-bold" data-key="info" contenteditable="true">Ano/Turma: <span class="short-line"></span> Data: <span class="short-line"></span></div>
      </div>
    </div>
  </div>

  <!-- Título da Prova -->
  <div id="exam-title" class="card text-center text-xl font-bold mb-6" contenteditable="true">Título da Prova</div>

  <!-- Adicionar/Analisar Questões -->
  <div class="card mb-6">
    <h2 class="text-lg font-bold mb-2">Questões</h2>
    <textarea id="question-input" rows="4" class="w-full p-3 rounded border mb-4" placeholder="Cole ou escreva suas questões aqui..."></textarea>
    <div class="flex gap-2">
      <button id="process-questions" class="flex-1 bg-blue-600 text-white py-2 rounded">Analisar e Gerar</button>
      <button id="add-manual" class="bg-gray-200 py-2 px-4 rounded">Adicionar Questão Manual</button>
    </div>
  </div>

  <!-- Lista de Questões -->
  <div id="question-list" class="space-y-4"></div>

  <!-- Botões de Exportação -->
  <div class="flex gap-4 mt-6">
    <button id="export-pdf" class="flex-1 bg-green-600 text-white py-3 rounded font-bold">Gerar Prova PDF</button>
    <button id="clear-exam" class="bg-red-500 text-white py-3 px-6 rounded">Limpar Prova</button>
  </div>
</div>

<!-- Print area -->
<div id="print-area" aria-hidden="true"></div>

<script>
const state = {
  header: { logo:'', schoolName:'Nome da Escola', student:'Aluno(a):', teacher:'Professor(a):', subject:'Componente curricular:', info:'Ano/Turma: Data:' },
  examTitle: 'Título da Prova',
  questions: []
};

// Funções auxiliares
function showMessage(msg){ alert(msg); }
function saveState(){ localStorage.setItem('examState', JSON.stringify(state)); }
function loadState(){
  const s = localStorage.getItem('examState');
  if(s){ Object.assign(state, JSON.parse(s)); renderAll(); }
}

// Renderização completa
function renderAll(){
  renderHeader();
  renderExamTitle();
  renderQuestions();
}

// Cabeçalho
function renderHeader(){
  const logoPreview = document.getElementById('logo-preview');
  const logoPlaceholder = document.getElementById('logo-placeholder');
  if(state.header.logo){ logoPreview.src=state.header.logo; logoPreview.style.display='block'; logoPlaceholder.style.display='none'; } 
  else { logoPreview.style.display='none'; logoPlaceholder.style.display='block'; }
  document.querySelector('[data-key="schoolName"]').textContent=state.header.schoolName;
  document.querySelector('[data-key="student"]').textContent=state.header.student;
  document.querySelector('[data-key="teacher"]').textContent=state.header.teacher;
  document.querySelector('[data-key="subject"]').textContent=state.header.subject;
  document.querySelector('[data-key="info"]').textContent=state.header.info;
}

// Título
function renderExamTitle(){ document.getElementById('exam-title').textContent=state.examTitle; }

// Questões
function renderQuestions(){
  const list = document.getElementById('question-list');
  list.innerHTML='';
  state.questions.forEach((q,i)=>{
    const el=document.createElement('div');
    el.className='card';
    el.innerHTML=`
      <div class="flex justify-between items-start">
        <div><span class="font-bold text-blue-600">${i+1}.</span></div>
        <div style="flex:1; margin-left:1rem;">
          <div class="question-text" contenteditable="true" data-id="${q.id}" style="min-height:40px;">${q.text}</div>
          ${q.image ? `<div style="text-align:center; margin-top:8px;"><img src="${q.image}" style="width:${q.imageSize}%; max-width:100%;"></div>` : ''}
          <div class="mt-3">
            ${Array(q.lines).fill('<div class="question-line"></div>').join('')}
          </div>
        </div>
      </div>
    `;
    list.appendChild(el);
  });
  setupQuestionListeners();
}

// Listeners das questões
function setupQuestionListeners(){
  document.querySelectorAll('.question-text').forEach(el=>{
    el.oninput = e=>{
      const id=e.target.dataset.id;
      const q=state.questions.find(x=>x.id===id);
      if(q){ q.text=e.target.textContent; saveState(); }
    };
  });
}

// Adicionar questão manual
document.getElementById('add-manual').addEventListener('click',()=>{
  state.questions.push({id:crypto.randomUUID(), text:'Nova questão...', lines:3, image:'', imageSize:100});
  saveState(); renderQuestions();
});

// Processar texto colado
document.getElementById('process-questions').addEventListener('click',()=>{
  const text=document.getElementById('question-input').value.trim();
  if(!text){ showMessage('Nenhum texto para analisar'); return; }
  const parts=text.split(/\r?\n/).filter(s=>s);
  state.questions=parts.map(qText=>({id:crypto.randomUUID(), text:qText, lines:3, image:'', imageSize:100}));
  document.getElementById('question-input').value='';
  saveState(); renderQuestions();
});

// Logo
document.getElementById('logo-container').addEventListener('click',()=>document.getElementById('logo-upload').click());
document.getElementById('logo-upload').addEventListener('change',e=>{
  const f=e.target.files[0];
  if(f && f.type.startsWith('image/')){
    const r=new FileReader();
    r.onload=ev=>{ state.header.logo=ev.target.result; saveState(); renderHeader(); }
    r.readAsDataURL(f);
  }
});

// Exportar PDF
function renderPrintableContent(){
  const target=document.getElementById('print-area');
  target.innerHTML='';
  // Header
  const logoHtml=state.header.logo?`<img src="${state.header.logo}" style="height:60px; object-fit:contain; margin-bottom:8px;">`:'';
  const headerHtml=`
    <div style="display:flex; justify-content:space-between; margin-bottom:16px;">
      <div>${logoHtml}</div>
      <div style="text-align:right; flex:1;">
        <div style="font-weight:bold;">${state.header.schoolName}</div>
        <div style="font-weight:600;">${state.header.student}</div>
        <div style="font-weight:600;">${state.header.teacher}</div>
        <div style="font-weight:600;">${state.header.subject}</div>
        <div style="font-weight:600;">${state.header.info}</div>
      </div>
    </div>
  `;
  const titleHtml=`<div style="text-align:center; font-weight:bold; font-size:18px; margin-bottom:16px;">${state.examTitle}</div>`;
  let questionsHtml='';
  state.questions.forEach((q,i)=>{
    const linesHtml=Array(q.lines).fill('<div style="border-bottom:1px solid #000; height:20px; margin-top:8px;"></div>').join('');
    const imageHtml=q.image?`<div style="text-align:center; margin:8px 0;"><img src="${q.image}" style="width:${q.imageSize}%; max-width:100%;"></div>`:'';
    questionsHtml+=`<div style="margin-bottom:16px;"><strong>${i+1}.</strong> ${q.text}${imageHtml}${linesHtml}</div>`;
  });
  target.innerHTML=headerHtml+titleHtml+questionsHtml;
}

function exportPDF(){
  if(state.questions.length===0){ showMessage('Nenhuma questão para exportar'); return; }
  renderPrintableContent();
  const element=document.getElementById('print-area'); element.style.display='block';
  html2pdf().set({
    margin: [10,10,10,10],
    filename:`${state.examTitle.replace(/[^\w\- ]/g,'')}.pdf`,
    image:{type:'jpeg', quality:0.98},
    html2canvas:{scale:2},
    jsPDF:{unit:'mm', format:'a4', orientation:'portrait'}
  }).from(element).save().then(()=>{ element.style.display='none'; showMessage('PDF gerado com sucesso!'); });
}

// Botões
document.getElementById('export-pdf').add
