<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gerador de Provas — Ajuste Fit-One-Page</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- html2pdf -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root{
      --base-font-size: 12pt; /* será ajustado dinamicamente */
      --header-font-size: 13pt;
      --response-line-height: 1.4em;
      --question-gap: 0.6rem;
    }
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#f1f5f9; color:#0f172a; margin:0; }
    .container { max-width:1100px; margin:1.5rem auto; padding:1rem; }
    .card { background:#fff; border-radius:10px; box-shadow:0 6px 20px rgba(2,6,23,0.06); padding:1rem; }
    .sidebar { width:320px; }
    .flex-row { display:flex; gap:1rem; }
    /* A4 preview */
    .pdf-page {
      width:210mm;
      min-height:297mm;
      padding:18mm;
      box-sizing:border-box;
      background:#fff;
      margin:0 auto 1.25rem;
      font-size:var(--base-font-size);
      line-height:1.35;
      position:relative;
      color:#0f172a;
      transition: transform 160ms ease;
    }
    /* Cabeçalho maior (apenas aumentar fontes) */
    .header-info { font-size: var(--header-font-size); line-height:1.45; }
    .header-info strong { font-weight:700; }
    /* Logo ao lado */
    .header-row { display:flex; gap:1rem; align-items:flex-start; border-bottom:1px solid #11182722; padding-bottom:0.5rem; margin-bottom:0.8rem; }
    .logo-box img { max-height:72px; max-width:160px; object-fit:contain; display:block; }
    /* Container de questões: começamos com 2 colunas, ajustamos via JS */
    #question-list {
      column-gap: 14px;
      column-fill: auto;
      /* column-count será ajustado via JS conforme necessário */
      -webkit-column-break-inside: avoid;
      -moz-column-break-inside: avoid;
      column-break-inside: avoid;
    }
    .question-card {
      display:inline-block; /* importante para columns */
      width:100%;
      background:transparent;
      margin-bottom: var(--question-gap);
      break-inside: avoid;
      -webkit-column-break-inside: avoid;
      -moz-column-break-inside: avoid;
      padding:0.15rem 0;
      font-size:inherit;
    }
    .question-text { display:block; }
    .response-line { border-bottom:1px solid #94a3b8; height: calc(var(--response-line-height)); margin-top:0.35rem; }
    /* controles visuais (sidebar etc.) */
    .controls { display:flex; gap:0.6rem; flex-direction:column; }
    .small-btn { background:#0ea5e9; color:white; padding:0.6rem; border-radius:8px; font-weight:600; text-align:center; cursor:pointer; }
    /* mask for generating */
    .generating { pointer-events:none; opacity:0.6; }
    /* hide controls when printing/generating - handled in JS class toggle */
    .hide-on-export { display:block; }
    .hide-on-export.exporting { display:none; }
    /* responsive */
    @media (max-width: 1024px) {
      .sidebar { width:100%; order:2; }
      .main { order:1; }
      .pdf-page { margin: 1rem 0; width:100%; min-height:auto; padding:12mm;}
    }
  </style>
</head>
<body>

  <div class="container flex-row">
    <!-- SIDEBAR -->
    <div class="sidebar card hide-on-export" id="sidebar">
      <h2 class="text-xl font-bold mb-2">Controles</h2>

      <label class="block text-sm font-medium mt-2">Escola</label>
      <input id="input-school" class="w-full p-2 border rounded mt-1" value="Nome da Escola">

      <label class="block text-sm font-medium mt-2">Professor(a)</label>
      <input id="input-teacher" class="w-full p-2 border rounded mt-1" value="Professor(a):">

      <label class="block text-sm font-medium mt-2">Aluno(a)</label>
      <input id="input-student" class="w-full p-2 border rounded mt-1" value="Aluno(a):">

      <label class="block text-sm font-medium mt-2">Componente</label>
      <input id="input-subject" class="w-full p-2 border rounded mt-1" value="Componente curricular:">

      <div class="flex gap-2 mt-3">
        <div class="flex-1">
          <label class="block text-sm font-medium">Série</label>
          <input id="input-grade" class="w-full p-2 border rounded mt-1" value="Série/Ano">
        </div>
        <div class="flex-1">
          <label class="block text-sm font-medium">Data</label>
          <input id="input-date" class="w-full p-2 border rounded mt-1" value="">
        </div>
      </div>

      <label class="block text-sm font-medium mt-3">Logo</label>
      <input id="input-logo" type="file" accept="image/*" class="w-full mt-1">

      <label class="block text-sm font-medium mt-3">Título da prova</label>
      <input id="input-title" class="w-full p-2 border rounded mt-1" value="Título da Prova">

      <label class="block text-sm font-medium mt-3">Colar questões (1 por linha)</label>
      <textarea id="paste-area" rows="4" class="w-full p-2 border rounded mt-1" placeholder="Cole uma questão por linha"></textarea>
      <button id="btn-paste" class="small-btn mt-2">Adicionar coladas</button>

      <button id="btn-add" class="small-btn mt-3">Adicionar questão manual</button>
      <button id="btn-generate" class="small-btn mt-3">Gerar PDF (versão aluno)</button>
      <button id="btn-generate-key" class="small-btn mt-2" style="background:#10b981">Gerar PDF (gabarito)</button>
      <button id="btn-clear" class="small-btn mt-2" style="background:#ef4444">Limpar tudo</button>

      <p class="text-xs text-gray-600 mt-3">Obs: o gerador tentará automaticamente reorganizar as questões (colunas, espaçamento e fonte) para caber **sempre** em UMA folha A4.</p>
    </div>

    <!-- MAIN -->
    <div class="main" style="flex:1; margin-left:1rem">
      <div class="card">
        <h2 class="text-lg font-bold mb-2">Preview — Página (A4)</h2>
        <div id="preview-wrapper">
          <!-- Página A4 simulada -->
          <div id="pdf-page" class="pdf-page" aria-live="polite">
            <div id="header" class="header-row">
              <div class="logo-box" id="logo-box" style="min-width:160px;">
                <img id="logo-preview" src="" alt="logo" style="display:none;">
              </div>
              <div class="header-info" id="header-info">
                <div><strong>Escola:</strong> <span id="v-school">Nome da Escola</span></div>
                <div><strong>Professor(a):</strong> <span id="v-teacher">Professor(a):</span></div>
                <div><strong>Aluno(a):</strong> <span id="v-student">Aluno(a):</span></div>
                <div><strong>Componente:</strong> <span id="v-subject">Componente curricular:</span></div>
                <div style="margin-top:0.35rem"><strong>Série/Ano:</strong> <span id="v-grade">Série/Ano</span> &nbsp; <strong>Data:</strong> <span id="v-date"></span></div>
              </div>
            </div>

            <h3 id="page-title" class="text-center font-bold" style="margin-top:0.6rem; margin-bottom:0.6rem; font-size:1.05em;">Título da Prova</h3>

            <!-- Aqui as questões serão injetadas -->
            <div id="question-list" aria-live="polite"></div>

            <!-- Rodapé será adicionado no PDF pelo js -->
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/*
  Código principal:
  - mantém header editável via inputs
  - permite adicionar/colar questões
  - lógica "fit-to-one-page" antes de exportar:
      tenta combinações:
        1) ajustar columns (1..3)
        2) reduzir fonte (até limite)
        3) reduzir altura das linhas de resposta
      se ainda overflow => aplica scale transform (único caso final)
  - gera PDF com html2pdf()
*/

// Estado simples
let state = {
  logo: null,
  header: {
    school: 'Nome da Escola',
    teacher: 'Professor(a):',
    student: 'Aluno(a):',
    subject: 'Componente curricular:',
    grade: 'Série/Ano',
    date: (new Date()).toLocaleDateString('pt-BR'),
  },
  title: 'Título da Prova',
  questions: [] // {id,text,lines,image,imageSize}
};

// Helpers
const $ = id => document.getElementById(id);
function uid(){ return 'q_'+Math.random().toString(36).slice(2,9); }
function saveLocal(){ localStorage.setItem('gerador_state', JSON.stringify(state)); }
function loadLocal(){ try{ const s=localStorage.getItem('gerador_state'); if(s) state=JSON.parse(s); }catch(e){console.warn(e);} }
function setText(id, txt){ if($(id)) $(id).textContent = txt; }

// Inicializa inputs com state
function initInputs(){
  $('input-date').value = state.header.date; // if exist
  $('input-date')?.addEventListener && $('input-date').addEventListener('input', (e)=>{state.header.date=e.target.value; updatePreview(); saveLocal();});
}

// Atualiza preview do header e title
function updatePreview(){
  $('v-school').textContent = state.header.school;
  $('v-teacher').textContent = state.header.teacher;
  $('v-student').textContent = state.header.student;
  $('v-subject').textContent = state.header.subject;
  $('v-grade').textContent = state.header.grade;
  $('v-date').textContent = state.header.date;
  $('page-title').textContent = state.title;
  // logo
  if(state.logo){
    $('logo-preview').src = state.logo;
    $('logo-preview').style.display = 'block';
  } else {
    $('logo-preview').style.display = 'none';
  }
}

// Renderiza questões em #question-list
function renderQuestions(){
  const container = $('question-list');
  container.innerHTML = '';
  if(state.questions.length === 0){
    container.innerHTML = '<p style="opacity:0.6; font-style:italic;">Nenhuma questão adicionada</p>';
    return;
  }
  state.questions.forEach((q, idx)=>{
    const wrapper = document.createElement('div');
    wrapper.className = 'question-card';
    wrapper.setAttribute('data-id', q.id);
    // Not using heavy controls, only visual
    let html = `<div><strong>${idx+1}.</strong> <span class="question-text">${q.text || ''}</span></div>`;
    if(q.image){
      html += `<div style="text-align:center; margin-top:6px;"><img src="${q.image}" style="width:${q.imageSize}%; max-width:100%;"></div>`;
    }
    // linhas
    html += `<div style="margin-top:6px;">`;
    for(let i=0;i<q.lines;i++){
      html += `<div class="response-line" style="height:calc(var(--response-line-height));"></div>`;
    }
    html += `</div>`;
    wrapper.innerHTML = html;
    container.appendChild(wrapper);
  });
}

// Adiciona questões coladas (1 por linha)
$('btn-paste').addEventListener('click', ()=>{
  const raw = $('paste-area').value.trim();
  if(!raw) return;
  raw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean).forEach(line=>{
    state.questions.push({ id: uid(), text: line, lines: 3, image:null, imageSize:100 });
  });
  $('paste-area').value='';
  saveLocal(); renderQuestions();
});

// Popular inputs e sincronizar
$('input-school').addEventListener('input', (e)=>{ state.header.school = e.target.value; updatePreview(); saveLocal(); });
$('input-teacher').addEventListener('input', (e)=>{ state.header.teacher = e.target.value; updatePreview(); saveLocal(); });
$('input-student').addEventListener('input', (e)=>{ state.header.student = e.target.value; updatePreview(); saveLocal(); });
$('input-subject').addEventListener('input', (e)=>{ state.header.subject = e.target.value; updatePreview(); saveLocal(); });
$('input-grade').addEventListener('input', (e)=>{ state.header.grade = e.target.value; updatePreview(); saveLocal(); });
$('input-date').addEventListener('input', (e)=>{ state.header.date = e.target.value; updatePreview(); saveLocal(); });
$('input-title').addEventListener('input', (e)=>{ state.title = e.target.value; updatePreview(); saveLocal(); });

// Logo upload
$('input-logo').addEventListener('change', async (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    state.logo = reader.result;
    updatePreview(); saveLocal();
  }
  reader.readAsDataURL(f);
});

// Add manual
$('btn-add').addEventListener('click', ()=>{
  state.questions.push({ id: uid(), text: '', lines:4, image:null, imageSize:100 });
  saveLocal(); renderQuestions();
  // focus the last created question text (not editable here in preview)
});

// Clear
$('btn-clear').addEventListener('click', ()=>{
  if(!confirm('Limpar tudo?')) return;
  state = { logo:null, header:{school:'Nome da Escola', teacher:'Professor(a):', student:'Aluno(a):', subject:'Componente curricular:', grade:'Série/Ano', date:(new Date()).toLocaleDateString('pt-BR')}, title:'Título da Prova', questions:[] };
  saveLocal(); updatePreview(); renderQuestions();
});

// Restore from local
loadLocal();
updatePreview();
renderQuestions();

// ---------- FIT-TO-ONE-PAGE logic ----------
/*
 Strategy:
 1) compute target inner A4 available height in px
 2) iterate possible column counts [2,3,1] (prefer 2), and for each:
    - try decreasing base font-size from 12pt down to min (8pt) step 0.5
    - try decreasing response-line height from 1.4em down to 1.0em
    - if content fits, break and keep settings
 3) if after all tries still not fit => compute scale factor and apply transform scale to #pdf-page
*/
async function fitPageToOne(){
  const page = $('pdf-page');
  // reset styles
  page.style.transform = 'none';
  page.style.fontSize = ''; // uses var
  document.documentElement.style.setProperty('--response-line-height', '1.4em');
  $('question-list').style.columnCount = 2; // start

  // A4 inner dims considering margins (we use page padding as margin)
  const computed = getComputedStyle(page);
  // compute inner available height in px:
  const paddingTop = parseFloat(computed.paddingTop);
  const paddingBottom = parseFloat(computed.paddingBottom);
  const pageClientWidth = page.clientWidth;
  const a4InnerWidth_mm = 210 - ( (paddingTop+paddingBottom) * 0 / 1 ); // not used directly
  // map mm to px using page client width vs 210mm (approx)
  const pxPerMm = pageClientWidth / 210; // approximate
  const a4InnerHeight_mm = 297 - ( (paddingTop+paddingBottom) / pxPerMm ); // approx correct
  const targetHeightPx = (297 - ((paddingTop+paddingBottom)/pxPerMm)) * pxPerMm; // simplifies to ~ page.clientHeight minus padding — we'll use directly:
  const availableHeightPx = page.clientHeight; // visible height inside the page container

  // We'll compare page.scrollHeight to page.clientHeight
  const maxCols = [2,3,1]; // priority: 2, then 3, then 1
  let success=false;
  let chosen = {cols:2, fontPt: parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--base-font-size')) || 12, responseLine:1.4, scale:1};

  // convert pt to px roughly: 1pt = 1.3333px
  const ptToPx = (pt)=> (pt*1.3333333);

  // start tries
  for(let cols of maxCols){
    $('question-list').style.columnCount = cols;
    // font sizes from 12 down to 8 (in 0.5pt steps)
    for(let fontPt=12; fontPt>=8; fontPt-=0.5){
      page.style.fontSize = fontPt + 'pt';
      // try response line heights
      for(let resp=1.4; resp>=1.0; resp-=0.1){
        document.documentElement.style.setProperty('--response-line-height', resp+'em');
        // small tweak: reduce gap between questions gradually
        const gapVal = Math.max(0.3, 0.6 - (12 - fontPt)*0.04);
        document.documentElement.style.setProperty('--question-gap', gapVal+'rem');

        await new Promise(r => requestAnimationFrame(r)); // let layout update
        const contentH = page.scrollHeight;
        const availH = page.clientHeight;
        // if fits entirely
        if(contentH <= availH + 0.5){ // small tolerance
          success=true;
          chosen = { cols, fontPt, responseLine: resp, scale:1 };
          break;
        }
      }
      if(success) break;
    }
    if(success) break;
  }

  if(!success){
    // If still doesn't fit, compute scale factor and apply
    const contentH = page.scrollHeight;
    const availH = page.clientHeight;
    const scale = availH / contentH;
    // enforce lower bound scale to 0.5
    const finalScale = Math.max(0.5, Math.min(1, scale));
    page.style.transformOrigin = 'top left';
    page.style.transform = `scale(${finalScale})`;
    chosen.scale = finalScale;
    success = true;
  } else {
    // ensure transform none
    page.style.transform = 'none';
  }

  // return what we chose (for debug or for logging)
  return chosen;
}

// Generate PDF (aluno/gabarito)
async function generatePdf(isKey=false){
  const page = $('pdf-page');

  // hide sidebar controls visually
  document.getElementById('sidebar').classList.add('exporting');
  // mark page as exporting (so css can hide controls if any)
  page.classList.add('generating');

  // First: attempt to fit without scaling transform if possible
  const result = await fitPageToOne();

  // Next: temporarily set gabarito mode if required (show answers) - here we don't have answer fields in preview, but kept for integration
  // If you had .answer fields you would toggle a class e.g. page.classList.toggle('show-answers', isKey)

  // Wait a paint
  await new Promise(r => setTimeout(r, 80));

  // Prepare filename
  const filename = `Prova_${(state.title||'Prova').replace(/\s+/g,'_')}_${(new Date()).toLocaleDateString('pt-BR').replace(/\//g,'-')}.pdf`;

  // html2pdf options
  const opt = {
    margin:       [10,10,10,10],
    filename:     filename,
    image:        { type: 'jpeg', quality: 0.98 },
    html2canvas:  { scale: 2, useCORS: true },
    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
    pagebreak:    { mode: ['css', 'legacy'] }
  };

  try {
    // call html2pdf on the page element
    await html2pdf().set(opt).from(page).save();
  } catch(err){
    console.error('Erro ao gerar PDF', err);
    alert('Erro ao gerar PDF. Veja console.');
  } finally {
    // cleanup: remove exporting state and transform
    page.classList.remove('generating');
    document.getElementById('sidebar').classList.remove('exporting');
    page.style.transform = 'none';
  }
}

// Hook generate buttons
$('btn-generate').addEventListener('click', ()=> generatePdf(false));
$('btn-generate-key').addEventListener('click', ()=> generatePdf(true));

// For demo: add sample 10 questões de matemática (com 4 linhas cada) to test
function addSample10(){
  state.questions = [];
  const sample = [
    'Calcule o valor de x na equação: 2x + 5 = 17.',
    'Resolva a expressão: 3^2 + 4^2.',
    'Um triângulo tem lados medindo 5 cm, 12 cm e 13 cm. Determine se é retângulo.',
    'Simplifique a fração 36/48.',
    'Qual é o valor de 25% de 240?',
    'Resolva: x^2 - 5x + 6 = 0.',
    'Determine a área de um círculo com raio r = 7 cm (pi=3,14).',
    'Se y = 3x + 4, encontre y quando x = 5.',
    'Ônibus com 48 passageiros — 1/3 desce; quantos permanecem?',
    'Calcule a média aritmética de 12,18,24,30,36.'
  ];
  sample.forEach(s=>{
    state.questions.push({ id: uid(), text: s, lines:4, image:null, imageSize:100 });
  });
  saveLocal();
  renderQuestions();
  updatePreview();
}

// quickly attach add sample for convenience (not required)
const sampleBtn = document.createElement('button');
sampleBtn.textContent = 'Adicionar 10 questões exemplo';
sampleBtn.className = 'small-btn mt-3';
sampleBtn.onclick = addSample10;
document.querySelector('.sidebar').appendChild(sampleBtn);

// initial date
if(!$('input-date').value) $('input-date').value = state.header.date;

</script>
</body>
</html>
