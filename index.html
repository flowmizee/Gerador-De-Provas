<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Extrator de Contatos (Google Maps)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        .table-action-btn { opacity: 0.6; transition: opacity .2s, transform .2s; }
        .table-action-btn:hover { opacity: 1; transform: scale(1.1); }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 p-4 md:p-8 min-h-screen">

  <!-- Toast Notification (para feedback, sem usar alert()) -->
  <div id="toast" class="fixed top-5 right-5 bg-cyan-600 text-white py-2 px-5 rounded-lg shadow-lg hidden transition-all duration-300 z-50">
    <span id="toast-message"></span>
  </div>

  <div class="max-w-7xl mx-auto">
    <!-- Cabeçalho -->
    <header class="mb-8">
      <h1 class="text-3xl md:text-4xl font-bold text-cyan-400 mb-2">Extrator de Contatos</h1>
      <p class="text-lg text-slate-400">Cole os dados brutos do Google Maps, organize e exporte como CSV.</p>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- Painel de Entrada -->
      <div class="bg-slate-800 p-6 rounded-xl shadow-2xl">
        <h2 class="text-2xl font-semibold mb-6 text-white flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3 text-cyan-400"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4L18.5 2.5z"></path></svg>
          Painel de Controle
        </h2>

        <form id="contact-form" class="space-y-5">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
            <div>
              <label for="tipo" class="block text-sm font-medium text-slate-300 mb-2">Tipo de Estabelecimento</label>
              <input type="text" id="tipo" name="tipo" placeholder="Ex: Restaurante, Padaria..." class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition">
            </div>
            <div>
              <label for="cidade" class="block text-sm font-medium text-slate-300 mb-2">Cidade</label>
              <input type="text" id="cidade" name="cidade" placeholder="Ex: Angical do Piauí" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition">
            </div>
          </div>

          <div>
            <label for="raw-data" class="block text-sm font-medium text-slate-300 mb-2">Dados Brutos (Cole aqui)</label>
            <textarea id="raw-data" name="raw-data" rows="10" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition"
              placeholder="Cole o bloco de texto copiado do Google Maps aqui...
Pode colar vários estabelecimentos de uma vez.
O app tentará separá-los usando 'Sobre esses dados' como divisor.
Também aceita linhas simples no formato: Rancho Burger: +55 86 99934-5970"></textarea>
          </div>

          <button type="submit" id="process-btn" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg flex items-center justify-center transition duration-300 ease-in-out transform hover:-translate-y-1">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
            Processar e Adicionar à Lista
          </button>
        </form>
      </div>

      <!-- Tabela de Saída -->
      <div class="bg-slate-800 p-6 rounded-xl shadow-2xl">
        <h2 class="text-2xl font-semibold mb-6 text-white flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3 text-cyan-400"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
          Contatos Extraídos
        </h2>

        <div id="table-wrapper" class="overflow-x-auto max-h-[400px] rounded-lg border border-slate-700">
          <table id="contacts-table" class="w-full text-left">
            <thead class="bg-slate-700 sticky top-0">
              <tr>
                <th class="p-3 text-sm font-semibold text-slate-300 uppercase">Nome</th>
                <th class="p-3 text-sm font-semibold text-slate-300 uppercase">Número</th>
                <th class="p-3 text-sm font-semibold text-slate-300 uppercase">Tipo</th>
                <th class="p-3 text-sm font-semibold text-slate-300 uppercase">Cidade</th>
                <th class="p-3 text-sm font-semibold text-slate-300 uppercase text-center">Ação</th>
              </tr>
            </thead>
            <tbody id="contacts-tbody" class="divide-y divide-slate-700">
              <tr id="empty-row">
                <td colspan="5" class="p-8 text-center text-slate-500">Nenhum contato adicionado ainda.</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="mt-6 flex flex-col sm:flex-row gap-4">
          <button id="export-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg flex items-center justify-center transition duration-300 ease-in-out transform hover:-translate-y-1 disabled:opacity-50 disabled:transform-none" disabled>
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
            Exportar CSV
          </button>

          <button id="clear-btn" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg flex items-center justify-center transition duration-300 ease-in-out transform hover:-translate-y-1 disabled:opacity-50 disabled:transform-none" disabled>
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
            Limpar Lista
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // DOM
      const form = document.getElementById('contact-form');
      const rawDataInput = document.getElementById('raw-data');
      const tipoInput = document.getElementById('tipo');
      const cidadeInput = document.getElementById('cidade');
      const tableBody = document.getElementById('contacts-tbody');
      const emptyRow = document.getElementById('empty-row');
      const exportBtn = document.getElementById('export-btn');
      const clearBtn = document.getElementById('clear-btn');
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toast-message');

      // Estado
      let extractedContacts = [];
      let toastTimeout = null;

      // Regex para telefones (flexível para vários formatos: +55 86 99934-5970, 86 99934-5970, 99934-5970, etc.)
      const phoneRegex = /(?:\+?55\s?)?(?:\(?\d{2,4}\)?\s?)?(?:\d{4,5}[-.\s]?\d{4}|\d{3,4}[\s-]?\d{4})/g;

      const junkRegex = /^(Abrir app|Seu local||||Fotos|Foto|Street View|Resumo de avaliações|R\.|Av\.|Avenida|Travessa|Alameda|Praça|Largo|Vila|Bairro|Centro|Zona|Rod\.|Rodovia|BR-|Estrada)$/i;
      const ratingRegex = /^(\d([,.]\d)?|\d{2})$/;

      function showToast(message, type = 'success') {
        clearTimeout(toastTimeout);
        toastMessage.textContent = message;
        if (type === 'error') {
          toast.classList.remove('bg-cyan-600'); toast.classList.add('bg-red-600');
        } else {
          toast.classList.remove('bg-red-600'); toast.classList.add('bg-cyan-600');
        }
        toast.classList.remove('hidden');
        toastTimeout = setTimeout(() => toast.classList.add('hidden'), 3000);
      }

      function renderTable() {
        tableBody.innerHTML = '';
        if (extractedContacts.length === 0) {
          tableBody.appendChild(emptyRow);
          exportBtn.disabled = true;
          clearBtn.disabled = true;
        } else {
          extractedContacts.forEach((contact, index) => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-slate-700/50 transition duration-150';
            tr.innerHTML = `
              <td class="p-3 text-sm text-white">${contact.name}</td>
              <td class="p-3 text-sm text-slate-300">${contact.number}</td>
              <td class="p-3 text-sm text-slate-300">${contact.type}</td>
              <td class="p-3 text-sm text-slate-300">${contact.city}</td>
              <td class="p-3 text-center">
                <button class="delete-btn table-action-btn text-red-400" data-index="${index}" title="Remover contato">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                </button>
              </td>`;
            tableBody.appendChild(tr);
          });
          exportBtn.disabled = false;
          clearBtn.disabled = false;
        }
      }

      function formatPhoneNumber(rawNumber) {
        const digits = String(rawNumber).replace(/\D/g, '');
        // Formata de forma inteligente conforme quantidade de dígitos
        if (digits.length >= 11 && digits.startsWith('55')) {
          // +55 AA 9XXXX-XXXX or +55 AA XXXX-XXXX
          const country = digits.substring(0,2);
          const ddd = digits.substring(2,4);
          if (digits.length === 13) {
            return `+${country} ${ddd} ${digits.substring(4,9)}-${digits.substring(9)}`;
          } else if (digits.length === 12) {
            return `+${country} ${ddd} ${digits.substring(4,8)}-${digits.substring(8)}`;
          } else {
            // fallback generic
            return `+${country} ${ddd} ${digits.substring(4)}`;
          }
        } else if (digits.length === 11) {
          // assume 9XXXX-XXXX with DDD
          return `+55 ${digits.substring(0,2)} ${digits.substring(2,7)}-${digits.substring(7)}`;
        } else if (digits.length === 10) {
          return `+55 ${digits.substring(0,2)} ${digits.substring(2,6)}-${digits.substring(6)}`;
        } else if (digits.length === 9) {
          return `${digits.substring(0,5)}-${digits.substring(5)}`;
        } else if (digits.length === 8) {
          return `${digits.substring(0,4)}-${digits.substring(4)}`;
        } else if (digits.length > 0) {
          return digits;
        } else {
          return 'Não encontrado';
        }
      }

      /**
       * parseData: tenta extrair nome e número de um bloco complexo (Google Maps style)
       */
      function parseData(text) {
        let name = 'Não encontrado';
        let number = 'Não encontrado';
        const lines = text.split('\n').map(l => l.trim()).filter(line => line !== '');

        // procura linha com "avalia" (avaliações/avaliação) para localizar o nome acima
        const avalIndex = lines.findIndex(l => l.toLowerCase().includes('avalia'));
        if (avalIndex > 0) {
          for (let i = avalIndex - 1; i >= 0; i--) {
            const candidate = lines[i].trim();
            if (candidate.length > 1 &&
                !junkRegex.test(candidate) &&
                !ratingRegex.test(candidate) &&
                candidate.toLowerCase() !== tipoInput.value.toLowerCase() &&
                !candidate.toLowerCase().includes('rotas') &&
                !candidate.toLowerCase().includes('iniciar') &&
                !candidate.toLowerCase().includes('ligar') &&
                !candidate.toLowerCase().includes('salvar') &&
                !candidate.toLowerCase().includes('compartilhar')) {
              name = candidate;
              break;
            }
          }
        }

        const phoneMatch = text.match(phoneRegex);
        if (phoneMatch && phoneMatch.length > 0) {
          number = formatPhoneNumber(phoneMatch[0]);
        }

        return { name, number };
      }

      /**
       * parseSimpleLines: aceita linhas simples como:
       * "Rancho Burger: +55 86 99934-5970" ou "Pastel na hora -lanchonete: +55 86 99480-3074"
       * Retorna quantos contatos foram adicionados.
       */
      function parseSimpleLines(rawText, tipo, cidade) {
        const lines = rawText.split('\n').map(l => l.trim()).filter(l => l !== '');
        let added = 0;

        for (const line of lines) {
          // tenta achar telefone na linha
          const m = line.match(phoneRegex);
          if (!m || m.length === 0) continue;

          // usa a primeira ocorrência como telefone
          const phoneRaw = m[0];
          // pega índice do telefone pra extrair o nome que vem antes
          const idx = line.indexOf(phoneRaw);
          let namePart = '';
          if (idx > 0) {
            namePart = line.substring(0, idx).trim();
          } else {
            // se telefone aparece no começo, tenta extrair texto anterior ao separador ":" ou "-"
            const beforeSep = line.split(':')[0].split('-')[0].trim();
            namePart = beforeSep.length < 3 ? '' : beforeSep;
          }

          // remove separadores finais comuns
          namePart = namePart.replace(/[:\-\–\—\s]+$/g, '').trim();

          // se nome ainda vazio, tenta extrair até o primeiro ":" antes do telefone
          if (!namePart) {
            const alt = line.split(':')[0].trim();
            if (alt && alt.length > 1) namePart = alt;
          }

          if (!namePart) continue;

          const formatted = formatPhoneNumber(phoneRaw);

          // evita duplicatas (baseado em número formatado ou nome igual)
          const exists = extractedContacts.some(c => (c.number && c.number === formatted) || (c.name && c.name.toLowerCase() === namePart.toLowerCase()));
          if (!exists) {
            extractedContacts.push({
              name: namePart,
              number: formatted,
              type: tipo,
              city: cidade
            });
            added++;
          }
        }

        return added;
      }

      function handleFormSubmit(e) {
        e.preventDefault();
        const rawText = rawDataInput.value.trim();
        const tipo = tipoInput.value.trim();
        const cidade = cidadeInput.value.trim();

        if (!rawText) { showToast('Por favor, cole os dados brutos.', 'error'); rawDataInput.focus(); return; }
        if (!tipo) { showToast('Por favor, informe o Tipo.', 'error'); tipoInput.focus(); return; }
        if (!cidade) { showToast('Por favor, informe a Cidade.', 'error'); cidadeInput.focus(); return; }

        let contatosAdicionados = 0;

        // 1) tenta linhas simples (Nome: telefone, Nome - telefone, etc.)
        contatosAdicionados += parseSimpleLines(rawText, tipo, cidade);

        // 2) processa blocos maiores (separados por "Sobre esses dados")
        const blocosDeTexto = rawText.split('Sobre esses dados');
        for (const bloco of blocosDeTexto) {
          if (bloco.trim().length < 10) continue;
          const { name, number } = parseData(bloco);

          // evita duplicatas
          const formattedNumber = (number && number !== 'Não encontrado') ? number : null;
          const foundDuplicate = extractedContacts.some(c => (formattedNumber && c.number === formattedNumber) || (name !== 'Não encontrado' && c.name && c.name.toLowerCase() === name.toLowerCase()));

          if (!foundDuplicate && (name !== 'Não encontrado' || number !== 'Não encontrado')) {
            extractedContacts.push({
              name: name,
              number: number,
              type: tipo,
              city: cidade
            });
            contatosAdicionados++;
          }
        }

        if (contatosAdicionados > 0) {
          renderTable();
          showToast(`${contatosAdicionados} contatos adicionados com sucesso!`, 'success');
          rawDataInput.value = '';
        } else {
          showToast('Não foi possível encontrar nenhum contato válido no texto.', 'error');
        }
      }

      function handleExportCSV() {
        if (extractedContacts.length === 0) { showToast('Não há dados para exportar.', 'error'); return; }

        const headers = ['Nome','Numero','Tipo','Cidade'];
        let csvContent = headers.join(',') + '\n';
        for (const contact of extractedContacts) {
          const row = [
            `"${(contact.name||'').replace(/"/g,'""')}"`,
            `"${(contact.number||'').replace(/"/g,'""')}"`,
            `"${(contact.type||'').replace(/"/g,'""')}"`,
            `"${(contact.city||'').replace(/"/g,'""')}"`
          ];
          csvContent += row.join(',') + '\n';
        }

        const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'contatos_maps.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast('CSV exportado com sucesso!', 'success');
      }

      function handleClearList() {
        extractedContacts = [];
        renderTable();
        showToast('Lista de contatos limpa.', 'success');
      }

      function handleTableClick(e) {
        const deleteButton = e.target.closest('.delete-btn');
        if (!deleteButton) return;
        const index = parseInt(deleteButton.getAttribute('data-index'), 10);
        if (!isNaN(index)) {
          extractedContacts.splice(index, 1);
          renderTable();
          showToast('Contato removido.', 'success');
        }
      }

      // listeners
      form.addEventListener('submit', handleFormSubmit);
      exportBtn.addEventListener('click', handleExportCSV);
      clearBtn.addEventListener('click', handleClearList);
      tableBody.addEventListener('click', handleTableClick);

      // inicializa
      renderTable();
    });
  </script>
</body>
</html>
