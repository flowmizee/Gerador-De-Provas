<!--
README RÁPIDO: Gerador de Provas (único arquivo HTML)
Como usar:
1. Abra este arquivo no navegador (duplo clique). Tudo funciona sem backend.
2. Cabeçalho: faça upload/arraste a logo para a área à esquerda. Ajuste a altura do logo com o slider. Edite campos (clique e digite). Escolha alinhamento do cabeçalho (esquerda/central/direita).
3. Questões: cole várias questões na área "Colar questões" e clique em "Analisar e gerar". Você também pode adicionar questões manualmente.
   - Em cada questão: editar texto, definir linhas de resposta (1-5), arrastar/soltar imagem direto na questão ou usar o botão de upload, ajustar tamanho da imagem, duplicar, remover e mover para cima/baixo.
4. Visualização: use a aba "Preview/A4" para ver como ficará impresso. Clique em "Exportar PDF" para salvar (usa html2pdf.js via CDN). Há opção "Exportar Gabarito" para gerar um PDF com as respostas marcadas.
5. Tudo é salvo automaticamente no localStorage. Use "Limpar prova" para resetar.
Extras:
- Tema Claro/Escuro
- Detecção de alternativas (A, B, C...) ao detectar padrões no texto
- Gabarito: marque as alternativas corretas na edição da questão (se for de múltipla escolha)

OBS: O código está comentado em português e modularizado no próprio arquivo. Sem dependências externas além do CDN html2pdf.js.
--><!doctype html>

<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Gerador de Provas — Flowmize</title>
  <!-- html2pdf CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  <style>
    :root{
      --bg:#f5f7fb; --card:#ffffff; --accent:#0b63d6; --text:#122028; --muted:#586a74;
      --print-line:1.5px;
    }
    [data-theme='dark']{
      --bg:#0f1720; --card:#0b1116; --accent:#38bdf8; --text:#e6eef6; --muted:#9fb6c9;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; background:var(--bg); color:var(--text);}
    .app{min-height:100vh;display:flex;gap:18px;padding:18px}
    /* Sidebar */
    .sidebar{width:360px;max-width:40%;background:linear-gradient(180deg, rgba(255,255,255,0.4), rgba(255,255,255,0.2));border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(2,6,23,0.08)}
    .controls h2{margin:0 0 8px 0;font-size:18px}
    label{display:block;font-size:13px;color:var(--muted);margin-top:12px}
    input[type='text'], select, textarea{width:100%;padding:8px 10px;border-radius:8px;border:1px solid #d5e1ea;background:transparent;font-size:14px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:#fff;cursor:pointer}
    .btn.ghost{background:transparent;color:var(--text);border:1px solid rgba(0,0,0,0.08)}
    .row{display:flex;gap:8px;align-items:center}
    .muted{color:var(--muted);font-size:13px}
    .logo-drop{height:96px;border-radius:8px;border:2px dashed rgba(18,32,40,0.08);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:6px;background:linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.2))}
    .logo-drop img{max-height:90px;max-width:100%;object-fit:contain}
    .field-inline{display:flex;flex-direction:column;gap:6px}
    .small{font-size:12px}/* Main preview area */
.main{flex:1;display:flex;flex-direction:column;gap:12px}
.toolbar{display:flex;gap:8px;align-items:center}
.preview-wrap{flex:1;display:flex;gap:12px}
.editor{width:420px;max-width:42%;background:var(--card);border-radius:12px;padding:12px;overflow:auto}
.preview{flex:1;background:transparent;display:flex;justify-content:center;align-items:flex-start;padding:12px;overflow:auto}

/* A4 preview box */
.a4{
  background:white;border-radius:6px;padding:20mm;box-shadow:0 6px 30px rgba(2,6,23,0.12);width:210mm;min-height:297mm;max-width:100%;
  box-sizing:border-box;margin:12px 0
}
@media (max-width:1000px){.sidebar{display:none}.editor{width:100%;max-width:100%}.app{padding:12px}.preview-wrap{flex-direction:column}}

/* Cabeçalho - layout em linha */
.prov-cab{display:flex;gap:14px;align-items:center;padding:10px;border-radius:8px;border:1px solid rgba(2,6,23,0.06);background:linear-gradient(180deg, rgba(245,247,250,0.6), rgba(255,255,255,0.4))}
.cab-left{width:140px;display:flex;align-items:center;justify-content:center}
.cab-right{flex:1;display:flex;flex-direction:column;gap:6px}
.cab-info{display:flex;flex-direction:column;gap:4px}
.cab-info .inline-edit{padding:4px 6px;border-radius:6px}
.cab-actions{display:flex;gap:6px;align-items:center}
.align-btn{padding:6px;border-radius:6px;border:1px solid rgba(0,0,0,0.06);cursor:pointer}

/* Questões */
.question{border-top:1px dashed rgba(0,0,0,0.06);padding:12px;display:flex;gap:8px;align-items:flex-start}
.q-left{width:36px;text-align:right;font-weight:600}
.q-body{flex:1}
.q-controls{display:flex;gap:6px;align-items:center}
.q-text{min-height:48px;padding:6px;border-radius:6px}
.answer-lines{margin-top:8px}
.answer-line{border-bottom:var(--print-line) solid #000;height:20px;margin:10px 0}
.q-image{max-width:180px;border-radius:6px;padding:6px;border:1px solid rgba(0,0,0,0.06);display:flex;flex-direction:column;gap:6px}
.q-image img{max-width:100%;height:auto;display:block}

/* footer controls */
.footer-actions{display:flex;gap:8px;align-items:center;justify-content:flex-end}

/* Print styles */
@media print{
  body{background:white}
  .app, .sidebar, .editor, .toolbar, .footer-actions, .theme-toggle{display:none}
  .a4{box-shadow:none;padding:12mm}
}

/* Accessibility focus */
[contenteditable]:focus{outline:2px solid rgba(11,99,214,0.18)}

  </style>
</head>
<body>
  <div class="app" id="app">
    <aside class="sidebar">
      <div class="controls">
        <h2>Gerador de Provas</h2>
        <div class="muted">Configurações do cabeçalho</div>
        <label class="small">Logo (arrastar/soltar ou clicar)</label>
        <div class="logo-drop" id="logoDrop" tabindex="0">
          <div id="logoPreviewWrap">
            <div class="muted">Arraste a logo aqui</div>
          </div>
        </div>
        <label class="small">Altura do logo (px)</label>
        <input type="range" id="logoHeight" min="40" max="140" value="90"><label class="small">Alinhamento do cabeçalho</label>
    <div class="row">
      <button class="align-btn" data-align="left">Esquerda</button>
      <button class="align-btn" data-align="center">Central</button>
      <button class="align-btn" data-align="right">Direita</button>
    </div>

    <label class="small">Campos do cabeçalho (clique para editar)</label>
    <div class="field-inline">
      <div class="cab-edit small"><div contenteditable id="schName" class="inline-edit">Nome da Escola</div></div>
      <div class="cab-edit small"><div contenteditable id="studentName" class="inline-edit">Aluno(a)</div></div>
      <div class="cab-edit small"><div contenteditable id="teacherName" class="inline-edit">Professor(a)</div></div>
      <div class="cab-edit small"><div contenteditable id="subjectName" class="inline-edit">Componente curricular</div></div>
      <div class="cab-edit small"><div style="display:flex;gap:8px"><div contenteditable id="annoTurma" class="inline-edit">Ano/Turma</div><div contenteditable id="dateField" class="inline-edit">Data</div></div></div>
    </div>

    <label class="small">Colar questões (várias) — reconhece numeração</label>
    <textarea id="bulkQuestions" rows="6" placeholder="Cole aqui várias questões. Ex: 1. Qual ...\n2 - Outra pergunta..." ></textarea>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="btn" id="parseBtn">Analisar e gerar</button>
      <button class="btn ghost" id="addQbtn">Adicionar questão</button>
    </div>

    <label class="small">Exemplos</label>
    <div class="muted small">Carregue exemplos prontos para testar.</div>
    <div style="display:flex;gap:8px;margin-top:6px">
      <button class="btn ghost" id="loadExample1">Exemplo: Simples</button>
      <button class="btn ghost" id="loadExample2">Exemplo: Múltipla escolha</button>
    </div>

    <label class="small">Tema</label>
    <div style="display:flex;gap:8px;margin-top:6px">
      <button class="btn ghost" id="toggleTheme">Alternar Tema</button>
    </div>

    <div style="margin-top:12px" class="footer-actions">
      <button class="btn" id="exportPdf">Exportar PDF</button>
      <button class="btn ghost" id="exportGabarito">Exportar Gabarito</button>
      <button class="btn ghost" id="clearAll">Limpar prova</button>
    </div>

    <div style="margin-top:14px" class="muted small">Salvo automaticamente no seu navegador (localStorage).</div>
  </div>
</aside>

<main class="main">
  <div class="toolbar">
    <div class="muted">Modo edição / preview A4</div>
  </div>
  <div class="preview-wrap">
    <section class="editor" id="editor">
      <h3 style="margin-top:0">Editor de Questões</h3>
      <div id="questionsList"></div>
    </section>

    <section class="preview" aria-label="Preview de impressão">
      <div class="a4" id="a4preview">
        <!-- Cabeçalho -->
        <div id="printHeader" class="prov-cab" data-align="left">
          <div class="cab-left">
            <div id="logoArea"></div>
          </div>
          <div class="cab-right">
            <div class="cab-info">
              <div contenteditable id="ph_schName" class="inline-edit'>Nome da Escola</div>
              <div style="display:flex;gap:8px"><div contenteditable id="ph_studentName" class="inline-edit">Aluno(a)</div><div contenteditable id="ph_teacherName" class="inline-edit">Professor(a)</div></div>
              <div contenteditable id="ph_subjectName" class="inline-edit">Componente curricular</div>
              <div style="display:flex;gap:8px"><div contenteditable id="ph_annoTurma" class="inline-edit">Ano/Turma</div><div contenteditable id="ph_dateField" class="inline-edit">Data</div></div>
            </div>
          </div>
        </div>

        <div id="printBody" style="margin-top:18px">
          <div id="printQuestions"></div>
        </div>
      </div>
    </section>
  </div>
</main>

  </div>  <script>
  // ======= Gerador de Provas - JavaScript =======
  // Código em português, modularizado em funções e com persistência em localStorage.

  const STORAGE_KEY = 'gerador_provas_v1';
  const stateDefault = {
    header:{logo:null,logoHeight:90,align:'left',schName:'Nome da Escola',studentName:'Aluno(a)',teacherName:'Professor(a)',subjectName:'Componente curricular',annoTurma:'Ano/Turma',dateField:new Date().toLocaleDateString()},
    questions:[] ,
    theme:'light'
  };

  let state = loadState();

  // ---------- Helpers ----------
  function saveState(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }
  function loadState(){
    try{const s=JSON.parse(localStorage.getItem(STORAGE_KEY)); return Object.assign({}, stateDefault, s || {});
    }catch(e){return JSON.parse(JSON.stringify(stateDefault));}
  }

  // ---------- DOM refs ----------
  const logoDrop = document.getElementById('logoDrop');
  const logoPreviewWrap = document.getElementById('logoPreviewWrap');
  const logoHeight = document.getElementById('logoHeight');
  const alignBtns = document.querySelectorAll('.align-btn');

  const schName = document.getElementById('schName');
  const studentName = document.getElementById('studentName');
  const teacherName = document.getElementById('teacherName');
  const subjectName = document.getElementById('subjectName');
  const annoTurma = document.getElementById('annoTurma');
  const dateField = document.getElementById('dateField');

  const ph_schName = document.getElementById('ph_schName');
  const ph_studentName = document.getElementById('ph_studentName');
  const ph_teacherName = document.getElementById('ph_teacherName');
  const ph_subjectName = document.getElementById('ph_subjectName');
  const ph_annoTurma = document.getElementById('ph_annoTurma');
  const ph_dateField = document.getElementById('ph_dateField');
  const logoArea = document.getElementById('logoArea');

  const bulkQuestions = document.getElementById('bulkQuestions');
  const parseBtn = document.getElementById('parseBtn');
  const addQbtn = document.getElementById('addQbtn');
  const questionsList = document.getElementById('questionsList');
  const printQuestions = document.getElementById('printQuestions');

  const exportPdfBtn = document.getElementById('exportPdf');
  const exportGabaritoBtn = document.getElementById('exportGabarito');
  const clearAllBtn = document.getElementById('clearAll');
  const toggleThemeBtn = document.getElementById('toggleTheme');
  const loadExample1Btn = document.getElementById('loadExample1');
  const loadExample2Btn = document.getElementById('loadExample2');

  // ---------- Inicialização ----------
  function init(){
    applyTheme();
    bindHeader();
    renderLogo();
    renderQuestionsEditor();
    renderPreview();
    bindDragDropLogo();
    setupButtons();
    // auto-save debounce
    setInterval(saveState,1500);
  }

  // ---------- Header bindings ----------
  function bindHeader(){
    logoHeight.value = state.header.logoHeight || 90;
    logoHeight.addEventListener('input', e=>{state.header.logoHeight=+e.target.value; renderLogo(); saveState();});

    alignBtns.forEach(b=>b.addEventListener('click', ()=>{state.header.align=b.dataset.align; document.getElementById('printHeader').style.justifyContent = (state.header.align==='right' ? 'flex-end' : (state.header.align==='center' ? 'center' : 'flex-start')); saveState(); renderPreview();}))

    // sync contenteditable fields
    [schName,studentName,teacherName,subjectName,annoTurma,dateField].forEach(el=>{
      el.addEventListener('input',()=>{state.header[getId(el)] = el.innerText; syncPreviewHeader(); saveState();});
      el.addEventListener('blur',()=>{saveState();});
    });

    // preview header contenteditable (sync back)
    [ph_schName,ph_studentName,ph_teacherName,ph_subjectName,ph_annoTurma,ph_dateField].forEach(el=>{
      el.addEventListener('input',()=>{const map={ph_schName:'schName',ph_studentName:'studentName',ph_teacherName:'teacherName',ph_subjectName:'subjectName',ph_annoTurma:'annoTurma',ph_dateField:'dateField'}; state.header[map[el.id]] = el.innerText; syncEditorHeader(); saveState();});
    });
  }
  function getId(el){if(el.id==='schName')return 'schName'; if(el.id==='studentName')return 'studentName'; if(el.id==='teacherName')return 'teacherName'; if(el.id==='subjectName')return 'subjectName'; if(el.id==='annoTurma')return 'annoTurma'; if(el.id==='dateField')return 'dateField'; return el.id}

  function syncPreviewHeader(){
    ph_schName.innerText = state.header.schName || '';
    ph_studentName.innerText = state.header.studentName || '';
    ph_teacherName.innerText = state.header.teacherName || '';
    ph_subjectName.innerText = state.header.subjectName || '';
    ph_annoTurma.innerText = state.header.annoTurma || '';
    ph_dateField.innerText = state.header.dateField || '';
    renderLogo();
  }
  function syncEditorHeader(){
    schName.innerText = state.header.schName || '';
    studentName.innerText = state.header.studentName || '';
    teacherName.innerText = state.header.teacherName || '';
    subjectName.innerText = state.header.subjectName || '';
    annoTurma.innerText = state.header.annoTurma || '';
    dateField.innerText = state.header.dateField || '';
    renderLogo();
  }

  // ---------- Logo drag & drop ----------
  function bindDragDropLogo(){
    ;['dragenter','dragover'].forEach(ev=>logoDrop.addEventListener(ev,e=>{e.preventDefault(); logoDrop.style.borderColor='rgba(11,99,214,0.6)'}));
    ;['dragleave','drop'].forEach(ev=>logoDrop.addEventListener(ev,e=>{e.preventDefault(); logoDrop.style.borderColor='rgba(2,6,23,0.08)'}));
    logoDrop.addEventListener('drop', e=>{
      const f = e.dataTransfer.files && e.dataTransfer.files[0]; if(f) handleLogoFile(f);
    });
    logoDrop.addEventListener('click', ()=>{
      const inp = document.createElement('input'); inp.type='file'; inp.accept='image/*'; inp.onchange = ()=>{ if(inp.files[0]) handleLogoFile(inp.files[0]);}; inp.click();
    });
  }
  function handleLogoFile(file){
    if(!file.type.startsWith('image/')){alert('Arquivo deve ser imagem.');return}
    if(file.size>2*1024*1024){alert('Imagem muito grande (máx 2MB).');return}
    const r = new FileReader(); r.onload = ()=>{ state.header.logo = r.result; renderLogo(); saveState(); }; r.readAsDataURL(file);
  }
  function renderLogo(){
    logoArea.innerHTML = '';
    logoPreviewWrap.innerHTML = '';
    if(state.header.logo){
      const img1 = document.createElement('img'); img1.src = state.header.logo; img1.style.height = state.header.logoHeight + 'px'; img1.alt='logo'; logoArea.appendChild(img1);
      const img2 = document.createElement('img'); img2.src = state.header.logo; img2.style.height = Math.min(90, state.header.logoHeight) + 'px'; logoPreviewWrap.appendChild(img2);
      // add remove button
      const rem = document.createElement('button'); rem.className='btn ghost'; rem.textContent='Remover'; rem.style.marginTop='6px'; rem.onclick=()=>{state.header.logo=null; renderLogo(); saveState();}; logoPreviewWrap.appendChild(rem);
      document.getElementById('printHeader').style.justifyContent = (state.header.align==='right' ? 'flex-end' : (state.header.align==='center' ? 'center' : 'flex-start'));
    } else {
      logoPreviewWrap.innerHTML = '<div class="muted">Arraste a logo aqui</div>';
      logoArea.innerHTML = '<div class="muted" style="font-size:12px">Logo</div>';
    }
  }

  // ---------- Questões: parse / render / CRUD ----------
  function parseBulkText(text){
    // Separar por linhas, detectar padrões de numeração no início
    const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    const qs=[]; let current=null;
    const regex = /^(\d+)[\).\-\s]+(.*)$/;
    for(const ln of lines){
      const m = ln.match(regex);
      if(m){ if(current) qs.push(current); current = {text:m[2],lines:3,image:null,choices:null,answer:null}; }
      else { if(current) current.text += '\n'+ln; else current = {text:ln,lines:3,image:null,choices:null,answer:null}; }
    }
    if(current) qs.push(current);
    return qs;
  }

  function setupButtons(){
    parseBtn.addEventListener('click',()=>{
      const parsed = parseBulkText(bulkQuestions.value);
      if(parsed.length===0){alert('Nenhuma questão detectada. Certifique-se de que há numeração no texto ou use "Adicionar questão".'); return}
      state.questions = state.questions.concat(parsed);
      renderQuestionsEditor(); saveState(); renderPreview();
    });

    addQbtn.addEventListener('click', ()=>{ state.questions.push({text:'Nova questão',lines:3,image:null,choices:null,answer:null}); renderQuestionsEditor(); saveState(); renderPreview(); });

    loadExample1Btn.addEventListener('click', ()=>{
      state.questions = [{text:'Qual é a capital do Brasil?',lines:2,image:null,choices:null,answer:null},{text:'Resolva: 2+2 = ?',lines:2,image:null,choices:null,answer:null}]; renderQuestionsEditor(); saveState(); renderPreview();
    });
    loadExample2Btn.addEventListener('click', ()=>{
      state.questions = [{text:'1. Qual a cor do céu?\nA) Verde\nB) Azul\nC) Amarelo\nD) Vermelho',lines:0,image:null,choices:['A','B','C','D'],answer:1},{text:'2. Quem descobriu o Brasil?\nA) Cristóvão Colombo\nB) Pedro Álvares Cabral\nC) Vasco da Gama\nD) Dom Pedro',lines:0,image:null,choices:['A','B','C','D'],answer:1}]; renderQuestionsEditor(); saveState(); renderPreview();
    });

    exportPdfBtn.addEventListener('click', ()=>{ exportPDF(false); });
    exportGabaritoBtn.addEventListener('click', ()=>{ exportPDF(true); });
    clearAllBtn.addEventListener('click', ()=>{ if(confirm('Limpar tudo? Esta ação remove o conteúdo salvo localmente.')){ state = JSON.parse(JSON.stringify(stateDefault)); saveState(); syncEditorHeader(); renderQuestionsEditor(); renderPreview(); renderLogo(); } });
    toggleThemeBtn.addEventListener('click', ()=>{ state.theme = state.theme==='light'?'dark':'light'; applyTheme(); saveState(); });
  }

  function renderQuestionsEditor(){
    questionsList.innerHTML='';
    state.questions.forEach((q,idx)=>{
      const el = document.createElement('div'); el.className='question';
      const left = document.createElement('div'); left.className='q-left'; left.innerText = (idx+1)+'.';
      const body = document.createElement('div'); body.className='q-body';
      const qtext = document.createElement('div'); qtext.className='q-text'; qtext.contentEditable = true; qtext.innerText = q.text; qtext.addEventListener('input', ()=>{ state.questions[idx].text = qtext.innerText; detectChoices(idx); saveState(); renderPreview(); });
      body.appendChild(qtext);

      // controls row
      const controls = document.createElement('div'); controls.className='q-controls';
      const linesLabel = document.createElement('label'); linesLabel.className='small'; linesLabel.innerText='Linhas:';
      const linesSel = document.createElement('select'); for(let i=0;i<=5;i++){ const o = document.createElement('option'); o.value=i; o.innerText = i; if(q.lines===i)o.selected=true; linesSel.appendChild(o);} linesSel.addEventListener('change', ()=>{ state.questions[idx].lines=+linesSel.value; saveState(); renderPreview(); });
      controls.appendChild(linesLabel); controls.appendChild(linesSel);

      // image drop area per question
      const imgWrap = document.createElement('div'); imgWrap.className='q-image'; imgWrap.style.minWidth='120px';
      imgWrap.innerHTML = '<div class="muted small">Arraste/solte imagem aqui</div>';
      imgWrap.addEventListener('dragover', e=>{e.preventDefault(); imgWrap.style.borderColor='rgba(11,99,214,0.5)'});
      imgWrap.addEventListener('dragleave', e=>{e.preventDefault(); imgWrap.style.borderColor='' });
      imgWrap.addEventListener('drop', e=>{ e.preventDefault(); const f = e.dataTransfer.files && e.dataTransfer.files[0]; if(f){ handleQuestionImageFile(f, idx); } });

      const uploadBtn = document.createElement('button'); uploadBtn.className='btn ghost small'; uploadBtn.textContent='Upload'; uploadBtn.onclick = ()=>{ const inp = document.createElement('input'); inp.type='file'; inp.accept='image/*'; inp.onchange = ()=>{ if(inp.files[0]) handleQuestionImageFile(inp.files[0], idx); }; inp.click(); };
      controls.appendChild(uploadBtn);

      const imgSizeLabel = document.createElement('label'); imgSizeLabel.className='small'; imgSizeLabel.innerText='Tamanho:';
      const imgSlider = document.createElement('input'); imgSlider.type='range'; imgSlider.min=40; imgSlider.max=400; imgSlider.value = (q.image && q.image.width) ? q.image.width : 180;
      imgSlider.addEventListener('input', ()=>{ if(state.questions[idx].image){ state.questions[idx].image.width = +imgSlider.value; saveState(); renderPreview(); } });
      controls.appendChild(imgSizeLabel); controls.appendChild(imgSlider);

      // duplicate / remove / reorder
      const dupBtn = document.createElement('button'); dupBtn.className='btn ghost small'; dupBtn.textContent='Duplicar'; dupBtn.onclick = ()=>{ const clone = JSON.parse(JSON.stringify(state.questions[idx])); state.questions.splice(idx+1,0,clone); renderQuestionsEditor(); renderPreview(); saveState(); };
      const upBtn = document.createElement('button'); upBtn.className='btn ghost small'; upBtn.textContent='↑'; upBtn.onclick = ()=>{ if(idx>0){ const tmp=state.questions[idx-1]; state.questions[idx-1]=state.questions[idx]; state.questions[idx]=tmp; renderQuestionsEditor(); renderPreview(); saveState(); }};
      const downBtn = document.createElement('button'); downBtn.className='btn ghost small'; downBtn.textContent='↓'; downBtn.onclick = ()=>{ if(idx<state.questions.length-1){ const tmp=state.questions[idx+1]; state.questions[idx+1]=state.questions[idx]; state.questions[idx]=tmp; renderQuestionsEditor(); renderPreview(); saveState(); }};
      const delBtn = document.createElement('button'); delBtn.className='btn ghost small'; delBtn.textContent='Remover'; delBtn.onclick = ()=>{ if(confirm('Remover esta questão?')){ state.questions.splice(idx,1); renderQuestionsEditor(); renderPreview(); saveState(); }};

      controls.appendChild(dupBtn); controls.appendChild(upBtn); controls.appendChild(downBtn); controls.appendChild(delBtn);

      body.appendChild(controls);

      // add to element
      el.appendChild(left);
      el.appendChild(body);
      el.appendChild(imgWrap);
      questionsList.appendChild(el);

      // render image if exists
      if(q.image && q.image.data){ imgWrap.innerHTML = ''; const im = document.createElement('img'); im.src = q.image.data; im.style.width = (q.image.width || 180) + 'px'; imgWrap.appendChild(im); const rem = document.createElement('button'); rem.className='btn ghost small'; rem.textContent='Remover imagem'; rem.onclick=()=>{ state.questions[idx].image=null; renderQuestionsEditor(); renderPreview(); saveState(); }; imgWrap.appendChild(rem);}    

      // detect choices
      detectChoices(idx);
    });
  }

  function handleQuestionImageFile(file, qidx){
    if(!file.type.startsWith('image/')){alert('Arquivo deve ser imagem.');return}
    if(file.size>3*1024*1024){alert('Imagem muito grande (máx 3MB).');return}
    const r = new FileReader(); r.onload = ()=>{ state.questions[qidx].image = {data:r.result, width:180}; renderQuestionsEditor(); renderPreview(); saveState(); }; r.readAsDataURL(file);
  }

  function detectChoices(idx){
    // tenta detectar padrões A) B) C) nas linhas
    const text = state.questions[idx].text || '';
    const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    const choices = []; const choicesRegex = /^([A-Z])\)\s*(.*)$/i; let found=false;
    for(const ln of lines){ const m = ln.match(choicesRegex); if(m){ found=true; choices.push(m[2]); }}
    if(found){ state.questions[idx].choices = choices; // default answer if not set
      if(typeof state.questions[idx].answer!=='number') state.questions[idx].answer = null;
    } else { state.questions[idx].choices = null; state.questions[idx].answer = null; }
  }

  // ---------- Preview rendering (A4) ----------
  function renderPreview(){
    syncPreviewHeader();
    printQuestions.innerHTML='';
    state.questions.forEach((q,idx)=>{
      const qwrap = document.createElement('div'); qwrap.style.marginBottom='14px';
      const qtitle = document.createElement('div'); qtitle.style.fontWeight='600'; qtitle.innerText = (idx+1)+'. ';
      const qtext = document.createElement('div'); qtext.style.whiteSpace='pre-wrap'; qtext.innerText = q.text;
      qwrap.appendChild(qtitle); qwrap.appendChild(qtext);
      // imagem
      if(q.image && q.image.data){ const iim = document.createElement('img'); iim.src=q.image.data; iim.style.maxWidth='100%'; iim.style.width = (q.image.width||180)+'px'; iim.style.display='block'; iim.style.marginTop='8px'; qwrap.appendChild(iim); }
      // choices
      if(q.choices){ const ul = document.createElement('div'); ul.style.marginTop='8px'; q.choices.forEach((c,ci)=>{ const ch = document.createElement('div'); ch.innerText = String.fromCharCode(65+ci)+') '+c; ul.appendChild(ch); }); qwrap.appendChild(ul); }
      // linhas
      if(q.lines && q.lines>0){ const linesDiv = document.createElement('div'); linesDiv.className='answer-lines'; for(let i=0;i<q.lines;i++){ const l = document.createElement('div'); l.className='answer-line'; l.style.height = '20px'; linesDiv.appendChild(l);} qwrap.appendChild(linesDiv); }
      printQuestions.appendChild(qwrap);
    });
  }

  // ---------- Export PDF / Gabarito ----------
  function exportPDF(isGabarito){
    // Clonar preview para manipular para PDF
    const clone = document.getElementById('a4preview').cloneNode(true);
    // se gabarito: replace questions area with respostas
    if(isGabarito){
      const qEls = clone.querySelectorAll('#printQuestions > div');
      qEls.forEach((el,idx)=>{
        const ans = state.questions[idx] && state.questions[idx].answer;
        const resp = document.createElement('div'); resp.style.marginTop='8px'; resp.style.fontWeight='600'; resp.innerText = 'Gabarito: ' + ( (ans===null || ans===undefined) ? '-' : (typeof ans==='number' ? (String.fromCharCode(65+ans)) : ans) );
        el.appendChild(resp);
      });
    }
    // Options html2pdf
    const opt = {
      margin: [10,10,10,10], filename: `${(state.header.schName||'Prova').replace(/\s+/g,'_')}_${new Date().toISOString().slice(0,10)}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale:2, useCORS:true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    html2pdf().set(opt).from(clone).save();
  }

  // ---------- Apply theme ----------
  function applyTheme(){ document.documentElement.setAttribute('data-theme', state.theme || 'light'); }

  // ---------- Utilities ----------
  function renderPreviewDebounced(){ renderPreview(); }

  // ---------- Start ----------
  init();
  // render initial values
  syncEditorHeader(); renderQuestionsEditor(); renderPreview();

  </script></body>
</html>
