<!DOCTYPE html>
<html lang="pt-BR" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Provas</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        .dark {
            @apply bg-gray-900 text-gray-100;
        }

        .dark .bg-white {
            @apply bg-gray-800;
        }

        .dark .bg-gray-50 {
            @apply bg-gray-700;
        }

        .dark .text-gray-900 {
            @apply text-gray-100;
        }
        
        .dark .border-gray-200 {
            @apply border-gray-700;
        }
        
        .dark input, .dark textarea {
            @apply bg-gray-700 text-gray-100 border-gray-600 placeholder-gray-400;
        }

        .dark .drag-highlight {
            @apply border-blue-400 bg-gray-700;
        }

        [contenteditable]:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }

        .fillable-line {
            display: inline-block;
            vertical-align: middle;
            border-bottom: 1px solid currentColor;
            margin-left: 0.5rem;
            min-width: 150px; /* Ajustado para a visualização na tela */
            padding: 2px 6px;
        }

        .short-line {
            min-width: 50px;
        }

        .date-line {
            display: inline-block;
            vertical-align: middle;
        }

        .date-line .line {
            border-bottom: 1px solid currentColor;
            display: inline-block;
            width: 25px;
        }
        
        .date-line .separator {
            padding: 0 2px;
        }

        .question-line {
            border-bottom: 2px solid #ccc;
            min-height: 1.2rem;
            line-height: 1.2rem;
            margin-top: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .print-preview {
            display: none;
        }

        .image-drop-area {
            pointer-events: auto; /* aceitável para drop */
        }

        /* Estilos para impressão */
        @media print {
            body {
                @apply bg-white text-gray-900;
            }
            body, html {
                margin: 0;
                padding: 0;
                width: 210mm; /* A4 width */
                min-height: 297mm; /* A4 height */
            }
            .print-preview {
                display: block !important;
                margin: 0;
                padding: 0;
                width: 210mm;
                min-height: 297mm;
                box-shadow: none;
            }
            #app {
                display: none;
            }
            .no-print {
                display: none !important;
            }

            .page-break {
                page-break-after: always;
            }

            .question-line {
                border-bottom: 2px solid #000;
                min-height: 1.2rem;
                line-height: 1.2rem;
                margin-top: 0.75rem;
                margin-bottom: 0.75rem;
            }

            .answer-key-correct {
                @apply bg-green-200 text-green-900 font-bold p-1 rounded-md;
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 transition-colors duration-300">
<!-- Main Application UI -->
<div id="app" class="p-6 md:p-10 max-w-4xl mx-auto">
    <div class="flex justify-end mb-4">
        <button id="theme-toggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 transition-colors duration-300">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700 dark:text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
            </svg>
        </button>
    </div>

    <!-- Header Section -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8 border border-gray-200">
        <div class="flex flex-col md:flex-row items-center md:items-start justify-between">
            <!-- Logo -->
            <div class="w-full md:w-1/4 flex-shrink-0 mb-4 md:mb-0">
                <div id="logo-container" class="cursor-pointer relative w-24 h-24 mx-auto md:mx-0 p-2 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center overflow-hidden">
                    <input type="file" id="logo-upload" class="hidden" accept="image/*">
                    <img id="logo-preview" class="w-full h-full object-contain" src="" alt="Logo" style="display: none;">
                    <span id="logo-placeholder" class="text-center text-xs text-gray-500">Arraste ou clique para adicionar a logo</span>
                </div>
            </div>
            
            <!-- Header Info -->
            <div id="header-info" class="w-full md:w-3/4 flex-grow space-y-2 text-right">
                <div class="flex items-center space-x-2 justify-end">
                    <span class="text-sm font-semibold text-gray-600">Alinhamento:</span>
                    <button id="align-left" class="p-1 rounded hover:bg-gray-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm1 3a1 1 0 100 2h12a1 1 0 100-2H4zm-1 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg></button>
                    <button id="align-center" class="p-1 rounded hover:bg-gray-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M4 4a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zm-1 7a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3-4a1 1 0 100 2h8a1 1 0 100-2H6zm0 7a1 1 0 100 2h8a1 1 0 100-2H6z" /></svg></button>
                    <button id="align-right" class="p-1 rounded hover:bg-gray-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16 4a1 1 0 01-1 1H3a1 1 0 110-2h12a1 1 0 011 1zm0 4a1 1 0 01-1 1H3a1 1 0 110-2h12a1 1 0 011 1zm-1 3a1 1 0 100 2H3a1 1 0 100-2h12zm-1 4a1 1 0 01-1 1H3a1 1 0 110-2h12a1 1 0 011 1z" clip-rule="evenodd" /></svg></button>
                </div>
                <div id="header-text-container" class="space-y-1">
                    <div class="header-field text-lg font-bold" data-key="schoolName" contenteditable="true">Nome da Escola</div>
                    <div class="header-field text-lg font-bold">Aluno(a): <span class="fillable-line" contenteditable="true" data-key="student-name"></span></div>
                    <div class="header-field text-lg font-bold" data-key="teacher" contenteditable="true">Professor(a):</div>
                    <div class="header-field text-lg font-bold" data-key="subject" contenteditable="true">Componente curricular:</div>
                    <div class="header-field text-lg font-bold" data-key="info">Ano/Turma: <span class="fillable-line short-line"></span> Data: <span class="date-line"><span class="line"></span><span class="separator">/</span><span class="line"></span><span class="separator">/</span><span class="line"></span></span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Exam Title -->
    <div id="exam-title" class="text-xl font-bold text-center mb-6" contenteditable="true">Título da Prova</div>

    <!-- Question Paste Area -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8 border border-gray-200">
        <h2 class="text-xl font-bold mb-4">Analisar Questões</h2>
        <p class="text-sm text-gray-500 mb-2">Cole o texto da sua prova aqui para que ele seja processado automaticamente.</p>
        <textarea id="question-input" rows="10" class="w-full p-4 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-y" placeholder="Cole suas questões aqui..."></textarea>
        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mt-4">
            <button id="process-questions" class="flex-grow bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200">
                Analisar e Gerar
            </button>
            <button id="add-manual" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition-colors duration-200">
                Adicionar Questão Manual
            </button>
        </div>
    </div>

    <!-- Question List -->
    <div id="question-list" class="space-y-6">
        <!-- Questions will be dynamically added here -->
    </div>
    
    <!-- Controls and PDF Export -->
    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 mt-8">
        <button id="export-pdf" class="flex-grow bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200">
            Gerar Prova PDF
        </button>
        <button id="clear-exam" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200">
            Limpar Prova
        </button>
    </div>

    <!-- Message Box -->
    <div id="message-box" class="fixed bottom-4 right-4 z-50 p-4 rounded-lg shadow-lg text-white font-semibold transition-opacity duration-300 opacity-0 pointer-events-none"></div>
</div>

<!-- Hidden A4 Print Preview Area -->
<div id="print-area" class="w-[210mm] min-h-[297mm] p-8 mx-auto bg-white shadow-xl">
    <!-- Content will be rendered here for PDF export -->
</div>

<script>
    // --- Estrutura de dados e estado do aplicativo ---
    const state = {
        header: {
            logo: '',
            alignment: 'text-right',
            schoolName: 'Nome da Escola',
            teacher: 'Professor(a):',
            subject: 'Componente curricular:',
            studentText: ''
        },
        examTitle: 'Título da Prova',
        questions: [],
        theme: 'light'
    };

    let autoSaveTimeout = null;

    // --- Utilitários ---
    function showMessage(message, type = 'info') {
        const msgBox = document.getElementById('message-box');
        msgBox.textContent = message;
        msgBox.className = 'fixed bottom-4 right-4 z-50 p-4 rounded-lg shadow-lg text-white font-semibold transition-opacity duration-300 opacity-0 pointer-events-none';
        
        switch (type) {
            case 'success':
                msgBox.classList.add('bg-green-500');
                break;
            case 'error':
                msgBox.classList.add('bg-red-500');
                break;
            case 'info':
            default:
                msgBox.classList.add('bg-blue-500');
                break;
        }
        
        msgBox.classList.remove('opacity-0', 'pointer-events-none');
        setTimeout(() => {
            msgBox.classList.add('opacity-0', 'pointer-events-none');
        }, 3000);
    }

    function saveState() {
        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(() => {
            localStorage.setItem('examGeneratorState', JSON.stringify(state));
            console.log('Estado salvo automaticamente.');
        }, 500);
    }

    function loadState() {
        const savedState = localStorage.getItem('examGeneratorState');
        if (savedState) {
            const parsedState = JSON.parse(savedState);
            Object.assign(state, parsedState);
            renderHeader();
            renderQuestions();
            renderExamTitle();
            document.documentElement.classList.toggle('dark', state.theme === 'dark');
        } else {
            addExampleData();
        }
    }

    function addExampleData() {
        state.header.schoolName = 'Nome da Escola';
        state.header.alignment = 'text-right';
        state.header.teacher = 'Professor(a):';
        state.header.subject = 'Componente curricular:';
        state.examTitle = 'Título da Prova';
        state.questions = [
            {
                id: crypto.randomUUID(),
                text: '1. O que é o ponto de fusão?',
                image: '',
                imageSize: 100,
                lines: 2
            },
            {
                id: crypto.randomUUID(),
                text: '2. Qual a principal característica do bioma Amazônia?',
                image: '',
                imageSize: 100,
                lines: 3
            }
        ];
        saveState();
        renderHeader();
        renderQuestions();
        renderExamTitle();
    }

    // pequena função para escapar HTML antes de inserir onde necessário
    function escapeHtml(str) {
        if (!str) return '';
        return str.replace(/[&<>"']/g, function (m) {
            return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];
        });
    }

    // --- Renderização ---

    function renderHeader() {
        const logoPreviewEl = document.getElementById('logo-preview');
        const logoPlaceholderEl = document.getElementById('logo-placeholder');

        // Alinhamento
        document.getElementById('header-info').className = `w-full md:w-3/4 flex-grow space-y-2 ${state.header.alignment}`;

        // Atualiza botões de alinhamento visualmente
        document.querySelectorAll('#header-info button').forEach(btn => btn.classList.remove('bg-gray-300'));
        const alignBtnId = `align-${state.header.alignment.replace('text-', '')}`;
        const alignBtn = document.getElementById(alignBtnId);
        if (alignBtn) alignBtn.classList.add('bg-gray-300');

        // Renderiza os campos sem apagar elementos internos (como span.fillable-line)
        const schoolEl = document.querySelector('[data-key="schoolName"]');
        if (schoolEl) schoolEl.textContent = state.header.schoolName || 'Nome da Escola';

        const teacherEl = document.querySelector('[data-key="teacher"]');
        if (teacherEl) teacherEl.textContent = state.header.teacher || 'Professor(a):';

        const subjectEl = document.querySelector('[data-key="subject"]');
        if (subjectEl) subjectEl.textContent = state.header.subject || 'Componente curricular:';

        // Student (preencher o span editável)
        const studentNameEl = document.querySelector('[data-key="student-name"]');
        if (studentNameEl) {
            studentNameEl.textContent = state.header.studentText || '';
        }

        // Logo
        if (state.header.logo) {
            logoPreviewEl.src = state.header.logo;
            logoPreviewEl.style.display = 'block';
            logoPlaceholderEl.style.display = 'none';
        } else {
            logoPreviewEl.style.display = 'none';
            logoPlaceholderEl.style.display = 'block';
        }
    }

    function renderExamTitle() {
        const titleEl = document.getElementById('exam-title');
        if (titleEl) {
            titleEl.textContent = state.examTitle;
        }
    }

    function renderQuestions() {
        const questionListEl = document.getElementById('question-list');
        questionListEl.innerHTML = '';
        
        state.questions.forEach((q, index) => {
            const questionNumber = index + 1;
            const element = document.createElement('div');
            element.id = `question-${q.id}`;
            element.className = 'bg-white rounded-lg shadow-md p-6 border border-gray-200 relative';
            element.draggable = true;
            element.setAttribute('data-id', q.id);
            element.innerHTML = `
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 space-y-2 sm:space-y-0">
                    <span class="text-xl font-bold mr-4 text-blue-600">${questionNumber}.</span>
                    <div class="flex-grow space-x-2 no-print">
                        <button class="action-btn duplicate-btn p-2 rounded-full hover:bg-gray-200" data-id="${q.id}" title="Duplicar">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v4a1 1 0 001 1h4a1 1 0 001-1V7m-5 7a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4zm-4 7a1 1 0 01-1 1h-2a1 1 0 01-1-1v-4a1 1 0 011-1h2a1 1 0 011 1v4zm-1-8a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 01-1 1h-2a1 1 0 01-1-1v-4z" /></svg>
                        </button>
                        <button class="action-btn remove-btn p-2 rounded-full hover:bg-gray-200" data-id="${q.id}" title="Remover">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                        <button class="action-btn move-up-btn p-2 rounded-full hover:bg-gray-200" data-id="${q.id}" title="Mover para cima">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" /></svg>
                        </button>
                        <button class="action-btn move-down-btn p-2 rounded-full hover:bg-gray-200" data-id="${q.id}" title="Mover para baixo">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" /></svg>
                        </button>
                    </div>
                </div>
                
                <div class="question-text text-base leading-relaxed mb-4" contenteditable="true" data-id="${q.id}">${escapeHtml(q.text)}</div>
                
                ${q.image ? `
                    <div class="relative mb-4">
                        <img src="${q.image}" class="max-w-full h-auto rounded-lg shadow-md" style="width: ${q.imageSize}%;" />
                        <div class="flex items-center space-x-2 mt-2 no-print">
                            <input type="range" class="image-size-slider flex-grow" data-id="${q.id}" min="10" max="100" value="${q.imageSize}" />
                            <button class="remove-image-btn p-1 rounded-full bg-red-500 text-white" data-id="${q.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                            </button>
                        </div>
                    </div>
                ` : ''}

                <div class="no-print">
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Número de linhas de resposta: <span class="lines-label">${q.lines}</span>
                    </label>
                    <input type="range" class="response-lines-slider w-full" data-id="${q.id}" min="0" max="10" value="${q.lines}">
                </div>

                <!-- Lines for answer -->
                ${Array(q.lines).fill().map(() => `<div class="question-line"></div>`).join('')}
                
                <!-- Drag and Drop Overlay for Images -->
                <div class="image-drop-area cursor-pointer absolute inset-0 rounded-lg border-2 border-dashed border-transparent flex items-center justify-center transition-colors duration-200" data-id="${q.id}">
                    <span class="text-sm text-gray-500 opacity-0 transition-opacity duration-200">Solte a imagem aqui</span>
                </div>
            `;
            questionListEl.appendChild(element);
        });
        setupQuestionListeners();
    }

    // --- Listeners das questões e UI ---
    function setupQuestionListeners() {
        document.querySelectorAll('.question-text').forEach(el => {
            el.removeEventListener('input', questionTextHandler);
            el.addEventListener('input', questionTextHandler);
        });

        function questionTextHandler(e) {
            const id = e.target.dataset.id;
            const question = state.questions.find(q => q.id === id);
            if (question) {
                question.text = e.target.textContent;
                saveState();
            }
        }

        document.querySelectorAll('.response-lines-slider').forEach(el => {
            el.removeEventListener('input', responseLinesHandler);
            el.addEventListener('input', responseLinesHandler);
        });

        function responseLinesHandler(e) {
            const id = e.target.dataset.id;
            const question = state.questions.find(q => q.id === id);
            if (question) {
                question.lines = parseInt(e.target.value, 10);
                const label = e.target.previousElementSibling;
                if (label) {
                    const spanLabel = label.querySelector('.lines-label');
                    if (spanLabel) spanLabel.textContent = question.lines;
                }
                renderQuestions(); // Re-render to show lines
                saveState();
            }
        }

        document.querySelectorAll('.image-size-slider').forEach(el => {
            el.removeEventListener('input', imageSizeHandler);
            el.addEventListener('input', imageSizeHandler);
        });

        function imageSizeHandler(e) {
            const id = e.target.dataset.id;
            const question = state.questions.find(q => q.id === id);
            if (question) {
                question.imageSize = parseInt(e.target.value, 10);
                const img = document.querySelector(`#question-${id} img`);
                if (img) img.style.width = `${question.imageSize}%`;
                saveState();
            }
        }

        document.querySelectorAll('.remove-image-btn').forEach(el => {
            el.removeEventListener('click', removeImageHandler);
            el.addEventListener('click', removeImageHandler);
        });

        function removeImageHandler(e) {
            const id = e.currentTarget.dataset.id;
            const question = state.questions.find(q => q.id === id);
            if (question) {
                question.image = '';
                question.imageSize = 100;
                saveState();
                renderQuestions();
            }
        }
        
        document.querySelectorAll('.duplicate-btn').forEach(el => {
            el.removeEventListener('click', duplicateHandler);
            el.addEventListener('click', duplicateHandler);
        });

        function duplicateHandler(e) {
            const id = e.currentTarget.dataset.id;
            const index = state.questions.findIndex(q => q.id === id);
            if (index !== -1) {
                const original = state.questions[index];
                const newQuestion = {...original, id: crypto.randomUUID()};
                state.questions.splice(index + 1, 0, newQuestion);
                saveState();
                renderQuestions();
                showMessage('Questão duplicada.', 'success');
            }
        }
        
        document.querySelectorAll('.remove-btn').forEach(el => {
            el.removeEventListener('click', removeHandler);
            el.addEventListener('click', removeHandler);
        });

        function removeHandler(e) {
            const id = e.currentTarget.dataset.id;
            state.questions = state.questions.filter(q => q.id !== id);
            saveState();
            renderQuestions();
            showMessage('Questão removida.', 'info');
        }

        document.querySelectorAll('.move-up-btn').forEach(el => {
            el.removeEventListener('click', moveUpHandler);
            el.addEventListener('click', moveUpHandler);
        });

        function moveUpHandler(e) {
            const id = e.currentTarget.dataset.id;
            const index = state.questions.findIndex(q => q.id === id);
            if (index > 0) {
                const [q] = state.questions.splice(index, 1);
                state.questions.splice(index - 1, 0, q);
                saveState();
                renderQuestions();
            }
        }

        document.querySelectorAll('.move-down-btn').forEach(el => {
            el.removeEventListener('click', moveDownHandler);
            el.addEventListener('click', moveDownHandler);
        });

        function moveDownHandler(e) {
            const id = e.currentTarget.dataset.id;
            const index = state.questions.findIndex(q => q.id === id);
            if (index < state.questions.length - 1) {
                const [q] = state.questions.splice(index, 1);
                state.questions.splice(index + 1, 0, q);
                saveState();
                renderQuestions();
            }
        });
    }

    // --- Processamento de texto colado ---
    function processPastedText() {
        const text = document.getElementById('question-input').value.trim();
        if (!text) {
            showMessage('Nenhum texto para analisar.', 'error');
            return;
        }

        // Tenta separar por numeração; se falhar, separa por blocos (duas quebras de linha)
        let questions = text.split(/^(?:\d+\.\s*|\d+\)\s*|\d+\-\s*)/gm).filter(q => q.trim().length > 0);
        if (questions.length <= 1) {
            questions = text.split(/\n{2,}/).map(s => s.trim()).filter(s => s.length > 0);
        }
        
        state.questions = questions.map(qText => ({
            id: crypto.randomUUID(),
            text: qText.trim(),
            image: '',
            imageSize: 100,
            lines: 3
        }));

        document.getElementById('question-input').value = '';
        saveState();
        renderQuestions();
        showMessage(`Geradas ${state.questions.length} questões.`, 'success');
    }

    // --- Render para impressão e exportação PDF ---
    function renderPrintableContent() {
        const targetEl = document.getElementById('print-area');
        
        // Ler diretamente dos elementos editáveis para garantir que o PDF contenha o que está na tela
        const schoolName = document.querySelector('[data-key="schoolName"]').textContent.trim();
        const teacher = document.querySelector('[data-key="teacher"]').textContent.trim();
        const subject = document.querySelector('[data-key="subject"]').textContent.trim();
        const student = state.header.studentText || document.querySelector('[data-key="student-name"]').textContent.trim();
        const examTitle = document.getElementById('exam-title').textContent.trim();

        const logoHtml = state.header.logo ? `<div class="flex-shrink-0"><img src="${state.header.logo}" class="h-20 w-auto object-contain mr-4"></div>` : '';

        // Cabeçalho completo
        const headerHtml = `
            <div style="display:flex;align-items:center;justify-content:space-between;padding-bottom:8px;margin-bottom:12px;border-bottom:1px solid #999;">
                ${logoHtml}
                <div style="text-align:${state.header.alignment === 'text-right' ? 'right' : state.header.alignment === 'text-left' ? 'left' : 'center'};flex-grow:1;">
                    <div style="font-weight:700;font-size:16px;margin-bottom:4px;">${escapeHtml(schoolName)}</div>
                    <div style="font-weight:700;margin-bottom:4px;">Aluno(a): <span style="border-bottom:1px solid #000;display:inline-block;width:350px;padding:2px 6px;">${escapeHtml(student)}</span></div>
                    <div style="font-weight:700;margin-bottom:4px;">${escapeHtml(teacher)}</div>
                    <div style="font-weight:700;margin-bottom:4px;">${escapeHtml(subject)}</div>
                    <div style="font-weight:700;">Ano/Turma: <span style="border-bottom:1px solid #000;display:inline-block;width:100px;"></span> Data: <span style="border-bottom:1px solid #000;display:inline-block;width:35px;"></span>/<span style="border-bottom:1px solid #000;display:inline-block;width:35px;"></span>/<span style="border-bottom:1px solid #000;display:inline-block;width:35px;"></span></div>
                </div>
            </div>
        `;

        const titleHtml = `<div style="text-align:center;font-weight:700;font-size:18px;margin-bottom:12px;">${escapeHtml(examTitle)}</div>`;
        
        let questionsHtml = '';
        state.questions.forEach((q, index) => {
            const questionNumber = index + 1;
            questionsHtml += `
                <div style="margin-bottom:18px;">
                    <p style="margin:0 0 8px 0;font-size:14px;line-height:1.4;">
                        <strong style="margin-right:8px;">${questionNumber}.</strong>${escapeHtml(q.text)}
                    </p>
                    ${q.image ? `<div style="text-align:center;margin:10px 0;"><img src="${q.image}" style="width:${q.imageSize}%;max-width:100%;display:inline-block;"></div>` : ''}
                    ${Array(q.lines).fill().map(() => `<div style="border-bottom:2px solid #000;min-height:18px;margin-top:6px;margin-bottom:6px;"></div>`).join('')}
                </div>
            `;
        });
        
        targetEl.innerHTML = headerHtml + titleHtml + questionsHtml;
    }

    function exportPDF() {
        if (state.questions.length === 0) {
            showMessage('Nenhuma questão para exportar.', 'error');
            return;
        }

        renderPrintableContent();
        const element = document.getElementById('print-area');
        const filename = `${state.examTitle || 'Prova'}_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.pdf`;
        
        html2pdf().from(element).set({
            margin: 10,
            filename: filename,
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        }).save();
    }

    function clearExam() {
        localStorage.removeItem('examGeneratorState');
        state.header.logo = '';
        state.questions = [];
        addExampleData();
        showMessage('Prova limpa com sucesso.', 'success');
    }

    // --- Event Listeners iniciais ---
    document.addEventListener('DOMContentLoaded', loadState);

    // Listeners do cabeçalho (inputs editáveis)
    document.querySelector('[data-key="schoolName"]').addEventListener('input', (e) => {
        state.header.schoolName = e.target.textContent.trim();
        saveState();
    });
    document.querySelector('[data-key="teacher"]').addEventListener('input', (e) => {
        state.header.teacher = e.target.textContent.trim();
        saveState();
    });
    document.querySelector('[data-key="subject"]').addEventListener('input', (e) => {
        state.header.subject = e.target.textContent.trim();
        saveState();
    });

    // Student name (editable span)
    document.querySelector('[data-key="student-name"]').addEventListener('input', (e) => {
        state.header.studentText = e.target.textContent.trim();
        saveState();
    });
    
    // Listener do título da prova
    document.getElementById('exam-title').addEventListener('input', (e) => {
        state.examTitle = e.target.textContent;
        saveState();
    });

    // Logo handlers: clique para abrir e upload
    document.getElementById('logo-container').addEventListener('click', () => {
        document.getElementById('logo-upload').click();
    });

    document.getElementById('logo-upload').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                state.header.logo = event.target.result;
                saveState();
                renderHeader();
            };
            reader.readAsDataURL(file);
        }
    });

    // Drag over / leave visuals para logo
    document.getElementById('logo-container').addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
        e.currentTarget.classList.add('border-blue-500');
    });

    document.getElementById('logo-container').addEventListener('dragleave', (e) => {
        e.preventDefault();
        e.stopPropagation();
        e.currentTarget.classList.remove('border-blue-500');
    });

    // Drop no logo - correção: usa e.currentTarget e grava em state.header.logo
    document.getElementById('logo-container').addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const container = e.currentTarget;
        container.classList.remove('border-blue-500');

        const file = e.dataTransfer.files && e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (event) => {
                state.header.logo = event.target.result;
                saveState();
                renderHeader();
                showMessage('Logo adicionada com sucesso!', 'success');
            };
            reader.readAsDataURL(file);
        } else {
            showMessage('Por favor, solte um arquivo de imagem.', 'error');
        }
    });

    // Alinhamento
    document.getElementById('align-left').addEventListener('click', () => {
        state.header.alignment = 'text-left';
        saveState();
        renderHeader();
    });

    document.getElementById('align-center').addEventListener('click', () => {
        state.header.alignment = 'text-center';
        saveState();
        renderHeader();
    });

    document.getElementById('align-right').addEventListener('click', () => {
        state.header.alignment = 'text-right';
        saveState();
        renderHeader();
    });

    // Botões principais
    document.getElementById('process-questions').addEventListener('click', processPastedText);
    document.getElementById('add-manual').addEventListener('click', () => {
        state.questions.push({
            id: crypto.randomUUID(),
            text: 'Nova questão...',
            image: '',
            imageSize: 100,
            lines: 3
        });
        saveState();
        renderQuestions();
        showMessage('Nova questão adicionada.', 'success');
    });

    document.getElementById('export-pdf').addEventListener('click', exportPDF);
    document.getElementById('clear-exam').addEventListener('click', clearExam);

    // Drag & Drop para imagens dentro das questões - corrigido: identifica [data-id] da questão
    document.getElementById('question-list').addEventListener('dragover', (e) => {
        const questionEl = e.target.closest('[data-id]');
        if (questionEl) {
            e.preventDefault();
            e.stopPropagation();
            questionEl.classList.add('drag-highlight');
        }
    });
    document.getElementById('question-list').addEventListener('dragleave', (e) => {
        const questionEl = e.target.closest('[data-id]');
        if (questionEl) {
            e.preventDefault();
            e.stopPropagation();
            questionEl.classList.remove('drag-highlight');
        }
    });

    document.getElementById('question-list').addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const questionEl = e.target.closest('[data-id]');
        if (!questionEl) {
            showMessage('Não foi possível identificar a questão alvo.', 'error');
            return;
        }
        questionEl.classList.remove('drag-highlight');
        const id = questionEl.getAttribute('data-id');

        const file = e.dataTransfer.files && e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (event) => {
                const question = state.questions.find(q => q.id === id);
                if (question) {
                    question.image = event.target.result;
                    saveState();
                    renderQuestions();
                    showMessage('Imagem adicionada com sucesso!', 'success');
                }
            };
            reader.readAsDataURL(file);
        } else {
            showMessage('Por favor, solte um arquivo de imagem.', 'error');
        }
    });

    // Tema
    document.getElementById('theme-toggle').addEventListener('click', () => {
        document.documentElement.classList.toggle('dark');
        state.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
        saveState();
    });

</script>

</body>
</html>
