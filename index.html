<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gerador de Provas — Ajustado (1 página A4)</title>

  <!-- Tailwind CDN (apenas utilitário) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- html2pdf (gera PDF) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root{--bg:#f8fafc;--card:#fff;--text:#111827;--muted:#6b7280;--border:#e5e7eb;}
    html.dark{--bg:#0f172a;--card:#111827;--text:#f3f4f6;--muted:#9ca3af;--border:#374151;}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--text); margin:0}
    .container{max-width:1100px;margin:1rem auto;padding:1rem}
    .card{background:var(--card);border:1px solid var(--border);border-radius:.6rem;padding:1rem;box-shadow:0 6px 18px rgba(16,24,40,.04)}
    [contenteditable]:focus{outline:none;box-shadow:0 0 0 3px rgba(59,130,246,.12);border-radius:4px}
    .image-drop{border:2px dashed #d1d5db;padding:10px;border-radius:8px;text-align:center;cursor:pointer}
    .image-drop.drag-over{border-color:#3b82f6;background:rgba(59,130,246,0.04)}
    .btn{display:inline-block;padding:.5rem .75rem;border-radius:.5rem;cursor:pointer}
    .small{font-size:.875rem}
    /* A4 preview */
    .pdf-page{width:210mm;min-height:297mm;background:#fff;padding:18mm;box-sizing:border-box;margin:0 auto;position:relative;font-size:13px;line-height:1.35}
    /* Cabeçalho: logo à esquerda, infos maiores à direita empilhadas */
    .header-preview{display:flex;gap:1rem;align-items:flex-start;border-bottom:2px solid #111;padding-bottom:10px;margin-bottom:10px}
    .logo-box img{max-height:88px;max-width:170px;display:block}
    .header-info{font-size:14px;line-height:1.4}
    .header-info .line{margin-bottom:3px}
    /* Container de questões usa columns (1 ou 2) controlado por JS */
    #question-list{column-gap:20px}
    .question-card{break-inside:avoid;page-break-inside:avoid;margin-bottom:8px;padding:6px;border-radius:6px}
    .question-text{min-height:18px}
    .response-line{border-bottom:2px solid #000;height:20px;margin-top:8px}
    /* controls ocultos no PDF */
    .no-print{display:block}
    @media print{.no-print{display:none !important}}
    /* mobile tweaks */
    @media (max-width:768px){.header-info{font-size:13px}}
    /* indicador drag */
    .drag-over-indicator{height:4px;background:#3b82f6;margin-bottom:6px}
  </style>
</head>
<body>

<div class="container">
  <div class="card no-print">
    <div class="flex justify-between items-center mb-3">
      <h1 class="text-xl font-bold">Gerador de Provas — Forçar 1 página A4</h1>
      <div class="flex gap-2 items-center">
        <button id="btn-clear" class="btn bg-red-500 text-white">Limpar</button>
        <button id="btn-export" class="btn bg-green-600 text-white">Gerar PDF (1 página)</button>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="small block mb-1">Logo (arraste / clique)</label>
        <div id="logo-drop" class="image-drop">
          <input id="logo-file" type="file" accept="image/*" style="display:none">
          <div id="logo-placeholder">Arraste ou clique para adicionar logo</div>
          <div id="logo-preview-box" style="display:none;margin-top:8px;">
            <img id="logo-preview" src="" alt="Logo" style="max-height:88px">
            <div><button id="logo-remove" class="btn bg-gray-200 mt-2">Remover</button></div>
          </div>
        </div>

        <div class="mt-4">
          <label class="small block mb-1">Cabeçalho (edite)</label>
          <input id="inp-school" class="card w-full mb-2" placeholder="Nome da Escola" value="Nome da Escola">
          <input id="inp-teacher" class="card w-full mb-2" placeholder="Professor(a)" value="Professor(a)">
          <input id="inp-student" class="card w-full mb-2" placeholder="Aluno(a)" value="Aluno(a):">
          <input id="inp-subject" class="card w-full mb-2" placeholder="Componente curricular" value="Componente curricular:">
          <div class="flex gap-2">
            <input id="inp-grade" class="card w-1/2" placeholder="Série/Turma" value="Série/Turma">
            <input id="inp-date" class="card w-1/2" placeholder="Data" value="">
          </div>
        </div>
      </div>

      <div>
        <label class="small block mb-1">Título da Prova</label>
        <div id="inp-title" contenteditable="true" class="card" style="min-height:44px">Título da Prova</div>

        <div class="mt-3">
          <label class="small block mb-1">Adicionar/colar questões (uma por linha)</label>
          <textarea id="paste-area" rows="5" class="card w-full" placeholder="Cole aqui — cada linha vira uma questão"></textarea>
          <div class="flex gap-2 mt-2">
            <button id="btn-add-paste" class="btn bg-blue-600 text-white">Adicionar coladas</button>
            <button id="btn-add-manual" class="btn bg-gray-200">Adicionar questão manual</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- preview A4 -->
  <div class="card mt-4">
    <div id="a4" class="pdf-page" role="document" aria-label="Preview A4">
      <header class="header-preview" id="header-preview">
        <div class="logo-box" id="logo-box"><img id="logo-img-preview" src="" alt="Logo" style="display:none"></div>
        <div class="header-info" id="header-info">
          <div class="line"><strong>Escola:</strong> <span id="p-school">Nome da Escola</span></div>
          <div class="line"><strong>Professor(a):</strong> <span id="p-teacher">Professor(a)</span></div>
          <div class="line"><strong>Aluno(a):</strong> <span id="p-student">Aluno(a):</span></div>
          <div class="line"><strong>Componente:</strong> <span id="p-subject">Componente curricular:</span></div>
          <div class="line"><strong>Série/Ano:</strong> <span id="p-grade">Série/Turma</span> &nbsp;&nbsp; <strong>Data:</strong> <span id="p-date"></span></div>
        </div>
      </header>

      <h2 id="preview-title" class="text-center" style="font-weight:700;font-size:18px;margin:8px 0 12px 0">Título da Prova</h2>

      <section id="question-list" style="column-count:1"></section>
    </div>
  </div>
</div>

<script>
/* ===========================
   Utils / State
   =========================== */
const state = {
  logo: null,
  header: {
    school: 'Nome da Escola',
    teacher: 'Professor(a)',
    student: 'Aluno(a):',
    subject: 'Componente curricular:',
    grade: 'Série/Turma',
    date: new Date().toLocaleDateString('pt-BR')
  },
  title: 'Título da Prova',
  questions: [] // {id, text, lines, image (dataURL), imageSize}
};

function save(){ try{ localStorage.setItem('exam_v2_state', JSON.stringify(state)); }catch(e){} }
function load(){
  try{ const s = localStorage.getItem('exam_v2_state'); if(s) Object.assign(state, JSON.parse(s)); }catch(e){}
}
function uid(){ return 'q_'+Date.now()+'_'+Math.random().toString(36).slice(2,7); }

/* mm -> px helper */
function mmToPx(mm){
  const el = document.createElement('div');
  el.style.width = mm + 'mm';
  el.style.position = 'absolute';
  el.style.left = '-9999px';
  document.body.appendChild(el);
  const px = el.getBoundingClientRect().width;
  document.body.removeChild(el);
  return px;
}

/* small wait */
function nextFrame(){ return new Promise(res => requestAnimationFrame(()=>setTimeout(res,10))); }

/* ===========================
   Elements
   =========================== */
const logoDrop = document.getElementById('logo-drop');
const logoFile = document.getElementById('logo-file');
const logoPreviewBox = document.getElementById('logo-preview-box');
const logoPreview = document.getElementById('logo-preview');
const logoRemove = document.getElementById('logo-remove');

const inpSchool = document.getElementById('inp-school');
const inpTeacher = document.getElementById('inp-teacher');
const inpStudent = document.getElementById('inp-student');
const inpSubject = document.getElementById('inp-subject');
const inpGrade = document.getElementById('inp-grade');
const inpDate = document.getElementById('inp-date');

const inpTitle = document.getElementById('inp-title');
const pasteArea = document.getElementById('paste-area');
const btnAddPaste = document.getElementById('btn-add-paste');
const btnAddManual = document.getElementById('btn-add-manual');

const btnExport = document.getElementById('btn-export');
const btnClear = document.getElementById('btn-clear');

const pSchool = document.getElementById('p-school');
const pTeacher = document.getElementById('p-teacher');
const pStudent = document.getElementById('p-student');
const pSubject = document.getElementById('p-subject');
const pGrade = document.getElementById('p-grade');
const pDate = document.getElementById('p-date');
const logoImgPreview = document.getElementById('logo-img-preview');
const previewTitle = document.getElementById('preview-title');

const questionList = document.getElementById('question-list');
const a4 = document.getElementById('a4');

/* ===========================
   Init / Restore
   =========================== */
load();
if(!state.header.date) state.header.date = new Date().toLocaleDateString('pt-BR');
if(!state.questions) state.questions = [];
// if empty for testing, you can uncomment to add sample:
// if(state.questions.length===0){ for(let i=1;i<=10;i++) state.questions.push({id:uid(), text: `${i}. Questão de exemplo ${i}`, lines:4, image:null, imageSize:100}); }

inpSchool.value = state.header.school;
inpTeacher.value = state.header.teacher;
inpStudent.value = state.header.student;
inpSubject.value = state.header.subject;
inpGrade.value = state.header.grade;
inpDate.value = state.header.date;
inpTitle.textContent = state.title;
if(state.logo){ setLogo(state.logo); }
renderAll();

/* ===========================
   Logo handlers
   =========================== */
logoDrop.addEventListener('click', ()=> logoFile.click());
logoDrop.addEventListener('dragover', e=>{ e.preventDefault(); logoDrop.classList.add('drag-over'); });
logoDrop.addEventListener('dragleave', ()=> logoDrop.classList.remove('drag-over'));
logoDrop.addEventListener('drop', async (e)=>{ e.preventDefault(); logoDrop.classList.remove('drag-over'); const f = e.dataTransfer.files && e.dataTransfer.files[0]; if(f && f.type.startsWith('image/')) setLogo(await fileToDataURL(f)); });
logoFile.addEventListener('change', async (e)=>{ const f = e.target.files[0]; if(f) setLogo(await fileToDataURL(f)); });
logoRemove.addEventListener('click', ()=>{ state.logo = null; save(); logoPreviewBox.style.display='none'; logoPreview.src=''; logoImgPreview.style.display='none'; renderHeaderPreview(); });

async function fileToDataURL(file){ return new Promise((res,rej)=>{ const r = new FileReader(); r.onload = ()=>res(r.result); r.onerror = rej; r.readAsDataURL(file); }); }
function setLogo(dataurl){ state.logo = dataurl; save(); logoPreviewBox.style.display='block'; logoPreview.src = dataurl; logoImgPreview.src = dataurl; logoImgPreview.style.display='block'; renderHeaderPreview(); }

/* ===========================
   Header bindings
   =========================== */
[inpSchool, inpTeacher, inpStudent, inpSubject, inpGrade, inpDate].forEach(inp=>{
  inp.addEventListener('input', e=>{
    const id = e.target.id.replace('inp-','');
    state.header[id] = e.target.value;
    save();
    renderHeaderPreview();
  });
});
inpTitle.addEventListener('input', (e)=>{ state.title = e.target.textContent; save(); renderHeaderPreview(); });

function renderHeaderPreview(){
  pSchool.textContent = state.header.school;
  pTeacher.textContent = state.header.teacher;
  pStudent.textContent = state.header.student;
  pSubject.textContent = state.header.subject;
  pGrade.textContent = state.header.grade;
  pDate.textContent = state.header.date;
  previewTitle.textContent = state.title || 'Título da Prova';
}

/* ===========================
   Questions: add / paste / render
   =========================== */
btnAddManual.addEventListener('click', ()=>{
  state.questions.push({ id: uid(), text: 'Nova questão...', lines: 3, image: null, imageSize: 100 });
  save(); renderQuestions();
  setTimeout(()=>{ const el = document.querySelector(`[data-id="${state.questions[state.questions.length-1].id}"] .question-text`); if(el) el.focus(); },50);
});

btnAddPaste.addEventListener('click', ()=>{
  const raw = pasteArea.value.trim();
  if(!raw) return alert('Cole alguma questão antes.');
  const lines = raw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  lines.forEach(l => state.questions.push({ id: uid(), text: l, lines: 3, image: null, imageSize: 100 }));
  pasteArea.value = '';
  save(); renderQuestions();
});

function renderAll(){ renderHeaderPreview(); renderQuestions(); }

function renderQuestions(){
  questionList.innerHTML = '';
  if(state.questions.length === 0) {
    questionList.innerHTML = `<p style="color:var(--muted)">Nenhuma questão adicionada.</p>`;
    return;
  }

  // By default we'll set 1 column; the export logic will try 1/2 and shrink as needed.
  questionList.style.columnCount = 1;

  state.questions.forEach((q, idx)=>{
    const node = document.createElement('div');
    node.className = 'question-card';
    node.dataset.id = q.id;
    node.innerHTML = `
      <div style="display:flex;gap:8px">
        <div style="flex:0 0 28px;font-weight:700;color:#2563eb">${idx+1}.</div>
        <div style="flex:1">
          <div class="question-text" contenteditable="true" data-id="${q.id}" style="padding:2px">${q.text}</div>
          ${q.image ? `<div style="margin-top:6px"><img src="${q.image}" class="qimg" style="width:${q.imageSize}%"></div>` : ''}
          <div class="response-lines" data-id="${q.id}" style="margin-top:8px">${Array(q.lines).fill('<div class="response-line"></div>').join('')}</div>
          <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
            <label class="small">Linhas <input type="range" min="0" max="10" value="${q.lines}" data-id="${q.id}" class="lines-slider"></label>
            <label class="small">Imagem <input type="file" accept="image/*" data-id="${q.id}" class="img-input"></label>
            <button data-id="${q.id}" class="btn bg-gray-200 del-btn">Remover</button>
          </div>
        </div>
      </div>
    `;
    questionList.appendChild(node);
  });

  // bind editable text
  questionList.querySelectorAll('.question-text').forEach(el=>{
    el.addEventListener('input', e=>{
      const id = e.target.dataset.id;
      const q = state.questions.find(x=>x.id===id);
      if(q){ q.text = e.target.innerText; save(); }
    });
    el.addEventListener('blur', ()=> save());
  });

  // lines slider
  questionList.querySelectorAll('.lines-slider').forEach(sl=>{
    sl.addEventListener('input', e=>{
      const id = e.target.dataset.id;
      const q = state.questions.find(x=>x.id===id);
      if(q){ q.lines = parseInt(e.target.value,10); save(); renderQuestions(); } // re-render to update lines
    });
  });

  // image upload per question
  questionList.querySelectorAll('.img-input').forEach(inp=>{
    inp.addEventListener('change', async (e)=>{
      const f = e.target.files[0];
      if(!f) return;
      if(!f.type.startsWith('image/')) return alert('Envie uma imagem válida.');
      const id = e.target.dataset.id;
      const data = await fileToDataURL(f);
      const q = state.questions.find(x=>x.id===id);
      if(q){ q.image = data; q.imageSize = 90; save(); renderQuestions(); }
    });
  });

  // delete
  questionList.querySelectorAll('.del-btn').forEach(btn=>{
    btn.addEventListener('click', e=>{
      const id = e.target.dataset.id;
      if(!confirm('Remover questão?')) return;
      state.questions = state.questions.filter(q=>q.id !== id);
      save(); renderQuestions();
    });
  });
}

/* ===========================
   Export PDF: Fit-to-single-page algorithm
   Strategy:
     1) Clone preview element (A4) to offscreen.
     2) Try layout with 1 column, base font.
     3) If overflow, try 2 columns.
     4) If still overflow, progressively reduce font size to minFont.
     5) If still overflow, reduce line height / response-line height a bit.
     6) If still overflow, apply final scale (transform: scale) so content height matches A4 inner height.
   This guarantees single A4 output.
   =========================== */

btnExport.addEventListener('click', () => exportSinglePagePDF());

async function exportSinglePagePDF(){
  if(state.questions.length === 0) return alert('Adicione questões antes de gerar o PDF.');

  // Clone preview node
  const source = a4;
  const clone = source.cloneNode(true);
  // place offscreen
  clone.style.position = 'absolute';
  clone.style.left = '-9999px';
  clone.style.top = '0';
  clone.style.zIndex = 9999;
  // ensure background white
  clone.style.background = '#fff';
  document.body.appendChild(clone);

  // inner margins for A4 (mm)
  const marginTop_mm = 10, marginBottom_mm = 10, marginLeft_mm = 10, marginRight_mm = 10;
  const a4Width_mm = 210, a4Height_mm = 297;
  const innerW_mm = a4Width_mm - marginLeft_mm - marginRight_mm;
  const innerH_mm = a4Height_mm - marginTop_mm - marginBottom_mm;

  const innerW_px = mmToPx(innerW_mm);
  const innerH_px = mmToPx(innerH_mm);

  // force clone width to inner width px to standardize measurement
  clone.style.width = innerW_px + 'px';
  // remove extra padding from clone so we measure content area properly
  clone.style.padding = '0';
  clone.style.boxSizing = 'border-box';

  // find question-list inside clone
  const cloneQuestionList = clone.querySelector('#question-list');

  // base settings
  let baseFontPx = 14;         // starting font px (for body inside clone)
  const minFontPx = 9;         // minimum acceptable font (readability)
  let currentFontPx = baseFontPx;

  // adjust response line height factor relative to font
  let responseLineHeightPx = Math.round(currentFontPx * 1.45);

  // helper to apply typography and line heights
  function applyTypography(px){
    clone.style.fontSize = px + 'px';
    // adjust response-line heights
    clone.querySelectorAll('.response-line').forEach(rl => { rl.style.height = Math.max(8, Math.round(px * 1.45)) + 'px'; });
    // adjust spacing small touches
    clone.querySelectorAll('.question-card').forEach(qc => { qc.style.marginBottom = Math.max(4, Math.round(px / 3)) + 'px'; });
  }

  // helper check overflow
  function contentHeight(){ return clone.scrollHeight; }
  function contentWidth(){ return clone.getBoundingClientRect().width; }

  // initial set: 1 column
  cloneQuestionList.style.columnCount = 1;
  applyTypography(currentFontPx);
  await nextFrame();

  let fits = (contentHeight() <= innerH_px);

  // try 2 columns if not fit
  if(!fits){
    cloneQuestionList.style.columnCount = 2;
    await nextFrame();
    fits = (contentHeight() <= innerH_px);
  }

  // reduce font progressively while toggling columns to try to fit
  while(!fits && currentFontPx > minFontPx){
    currentFontPx -= 1;
    applyTypography(currentFontPx);
    // alternate columns to test both layouts
    cloneQuestionList.style.columnCount = (cloneQuestionList.style.columnCount === '2') ? '1' : '2';
    await nextFrame();
    fits = (contentHeight() <= innerH_px);
    if(fits) break;
  }

  // if still not fit, reduce spacing a bit (compact response lines and card margins)
  if(!fits){
    // tighten response lines and margins gradually
    let tightenSteps = 4;
    while(!fits && tightenSteps-- > 0){
      clone.querySelectorAll('.response-line').forEach(rl => {
        const cur = parseFloat(getComputedStyle(rl).height) || responseLineHeightPx;
        rl.style.height = Math.max(6, cur - 2) + 'px';
      });
      clone.querySelectorAll('.question-card').forEach(qc => {
        const mb = parseFloat(getComputedStyle(qc).marginBottom) || 8;
        qc.style.marginBottom = Math.max(2, mb - 1) + 'px';
      });
      await nextFrame();
      fits = (contentHeight() <= innerH_px);
    }
  }

  // final fallback: scale (shrink-to-fit)
  let finalScale = 1;
  if(!fits){
    const hFactor = innerH_px / contentHeight();
    const wFactor = innerW_px / contentWidth();
    finalScale = Math.min(hFactor, wFactor, 1);
    // apply transform scale to clone
    clone.style.transformOrigin = 'top left';
    clone.style.transform = `scale(${finalScale})`;
    // To ensure html2pdf captures scaled result correctly, increase html2canvas scale slightly
  }

  // Prepare html2pdf options
  const filename = `${(state.title || 'Prova').replace(/[^\w\s-]/g,'').replace(/\s+/g,'_')}_${new Date().toLocaleDateString('pt-BR').replace(/\//g,'-')}.pdf`;
  const opt = {
    margin: [marginTop_mm, marginLeft_mm, marginBottom_mm, marginRight_mm], // mm
    filename: filename,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: Math.min(2, window.devicePixelRatio || 1.5), useCORS: true, allowTaint: true },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
    pagebreak: { mode: ['css', 'legacy'] }
  };

  try{
    await html2pdf().set(opt).from(clone).save();
  }catch(err){
    console.error('Erro ao gerar PDF', err);
    alert('Erro ao gerar PDF. Veja console.');
  }finally{
    // cleanup
    clone.remove();
  }
}

/* ===========================
   Helpers for interactions
   =========================== */
function fileToDataURL(file){ return new Promise((res,rej)=>{ const r = new FileReader(); r.onload = ()=>res(r.result); r.onerror = rej; r.readAsDataURL(file); }); }

/* ===========================
   Simple clear
   =========================== */
btnClear.addEventListener('click', ()=>{
  if(!confirm('Limpar tudo?')) return;
  state.logo = null;
  state.header = { school:'Nome da Escola', teacher:'Professor(a)', student:'Aluno(a):', subject:'Componente curricular:', grade:'Série/Turma', date: new Date().toLocaleDateString('pt-BR') };
  state.title = 'Título da Prova';
  state.questions = [];
  save(); location.reload();
});

/* ===========================
   Persist inputs -> state
   =========================== */
inpSchool.addEventListener('input', e=>{ state.header.school = e.target.value; save(); renderHeaderPreview(); });
inpTeacher.addEventListener('input', e=>{ state.header.teacher = e.target.value; save(); renderHeaderPreview(); });
inpStudent.addEventListener('input', e=>{ state.header.student = e.target.value; save(); renderHeaderPreview(); });
inpSubject.addEventListener('input', e=>{ state.header.subject = e.target.value; save(); renderHeaderPreview(); });
inpGrade.addEventListener('input', e=>{ state.header.grade = e.target.value; save(); renderHeaderPreview(); });
inpDate.addEventListener('input', e=>{ state.header.date = e.target.value; save(); renderHeaderPreview(); });
inpTitle.addEventListener('input', e=>{ state.title = e.target.textContent; save(); renderHeaderPreview(); });

/* ===========================
   Render header + questions init
   =========================== */
function renderAll(){ renderHeaderPreview(); renderQuestions(); }
function renderHeaderPreview(){
  pSchool.textContent = state.header.school;
  pTeacher.textContent = state.header.teacher;
  pStudent.textContent = state.header.student;
  pSubject.textContent = state.header.subject;
  pGrade.textContent = state.header.grade;
  pDate.textContent = state.header.date;
  previewTitle.textContent = state.title || 'Título da Prova';
  if(state.logo){ logoImgPreview.src = state.logo; logoImgPreview.style.display = 'block'; logoPreviewBox.style.display='block'; logoPreview.src = state.logo; } else { logoImgPreview.style.display='none'; logoPreviewBox.style.display='none'; }
}

/* ensure changes saved on unload */
window.addEventListener('beforeunload', ()=> save());

/* initial render of questions */
renderQuestions();

</script>
</body>
</html>
```0
