<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extrator de Contatos (Google Maps)</title>
    <!-- Carrega o Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Define a fonte Inter (padrão do Tailwind) -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for a more sophisticated look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; /* slate-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #334155; /* slate-700 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #475569; /* slate-600 */
        }
        /* Style for the table actions */
        .table-action-btn {
            opacity: 0.6;
            transition: opacity 0.2s, transform 0.2s;
        }
        .table-action-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 p-4 md:p-8 min-h-screen">

    <!-- Toast Notification (para feedback, sem usar alert()) -->
    <div id="toast" class="fixed top-5 right-5 bg-cyan-600 text-white py-2 px-5 rounded-lg shadow-lg hidden transition-all duration-300 z-50">
        <span id="toast-message"></span>
    </div>

    <div class="max-w-7xl mx-auto">
        
        <!-- Cabeçalho -->
        <header class="mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-cyan-400 mb-2">Extrator de Contatos</h1>
            <p class="text-lg text-slate-400">Cole os dados brutos do Google Maps, organize e exporte como CSV.</p>
        </header>

        <!-- Container Principal (Grid Responsivo) -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

            <!-- Coluna 1: Painel de Entrada -->
            <div class="bg-slate-800 p-6 rounded-xl shadow-2xl">
                <h2 class="text-2xl font-semibold mb-6 text-white flex items-center">
                    <!-- Ícone SVG para "Entrada" -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3 text-cyan-400"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4L18.5 2.5z"></path></svg>
                    Painel de Controle
                </h2>
                
                <form id="contact-form" class="space-y-5">
                    <!-- Inputs de Contexto -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div>
                            <label for="tipo" class="block text-sm font-medium text-slate-300 mb-2">Tipo de Estabelecimento</label>
                            <input type="text" id="tipo" name="tipo" placeholder="Ex: Restaurante, Padaria..." class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition">
                        </div>
                        <div>
                            <label for="cidade" class="block text-sm font-medium text-slate-300 mb-2">Cidade</label>
                            <input type="text" id="cidade" name="cidade" placeholder="Ex: Alvorada do Gurguéia" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition">
                        </div>
                    </div>
                    
                    <!-- Área de Texto para Dados Brutos -->
                    <div>
                        <label for="raw-data" class="block text-sm font-medium text-slate-300 mb-2">Dados Brutos (Cole aqui)</label>
                        <textarea id="raw-data" name="raw-data" rows="10" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition" placeholder="Cole o bloco de texto copiado do Google Maps aqui...&#10;Ex:&#10;Padaria Doce Pão&#10;Padaria&#10;Av. Central, 123&#10;+55 89 98107-2388"></textarea>
                    </div>

                    <!-- Botão de Processar -->
                    <button type="submit" id="process-btn" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg flex items-center justify-center transition duration-300 ease-in-out transform hover:-translate-y-1">
                        <!-- Ícone SVG para "Processar" -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
                        Processar e Adicionar à Lista
                    </button>
                </form>
            </div>

            <!-- Coluna 2: Tabela de Saída -->
            <div class="bg-slate-800 p-6 rounded-xl shadow-2xl">
                <h2 class="text-2xl font-semibold mb-6 text-white flex items-center">
                    <!-- Ícone SVG para "Lista" -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3 text-cyan-400"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
                    Contatos Extraídos
                </h2>

                <!-- Wrapper da Tabela para rolagem em telas pequenas -->
                <div id="table-wrapper" class="overflow-x-auto max-h-[400px] rounded-lg border border-slate-700">
                    <table id="contacts-table" class="w-full text-left">
                        <thead class="bg-slate-700 sticky top-0">
                            <tr>
                                <th class="p-3 text-sm font-semibold text-slate-300 uppercase">Nome</th>
                                <th class="p-3 text-sm font-semibold text-slate-300 uppercase">Número</th>
                                <th class="p-3 text-sm font-semibold text-slate-300 uppercase">Tipo</th>
                                <th class="p-3 text-sm font-semibold text-slate-300 uppercase">Cidade</th>
                                <th class="p-3 text-sm font-semibold text-slate-300 uppercase text-center">Ação</th>
                            </tr>
                        </thead>
                        <tbody id="contacts-tbody" class="divide-y divide-slate-700">
                            <!-- Linhas serão inseridas pelo JavaScript -->
                            <tr id="empty-row" class="">
                                <td colspan="5" class="p-8 text-center text-slate-500">Nenhum contato adicionado ainda.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Botões de Ação da Tabela -->
                <div class="mt-6 flex flex-col sm:flex-row gap-4">
                    <button id="export-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg flex items-center justify-center transition duration-300 ease-in-out transform hover:-translate-y-1 disabled:opacity-50 disabled:transform-none" disabled>
                        <!-- Ícone SVG para "Exportar" -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        Exportar CSV
                    </button>
                    <button id="clear-btn" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg flex items-center justify-center transition duration-300 ease-in-out transform hover:-translate-y-1 disabled:opacity-50 disabled:transform-none" disabled>
                        <!-- Ícone SVG para "Limpar" -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        Limpar Lista
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Script Principal -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- Seletores do DOM ---
            const form = document.getElementById('contact-form');
            const rawDataInput = document.getElementById('raw-data');
            const tipoInput = document.getElementById('tipo');
            const cidadeInput = document.getElementById('cidade');
            const tableBody = document.getElementById('contacts-tbody');
            const emptyRow = document.getElementById('empty-row');
            const exportBtn = document.getElementById('export-btn');
            const clearBtn = document.getElementById('clear-btn');
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');

            // --- Estado da Aplicação ---
            let extractedContacts = [];
            let toastTimeout;

            // --- Expressões Regulares (RegEx) ---
            // RegEx para números de telefone brasileiros (bem abrangente)
            // Cobre +55 (89) 98107-2388, (89) 98107-2388, 89 98107-2388, 98107-2388, 0800, etc.
            const phoneRegex = /(?:\+?55\s?)?(?:\(?\d{2,4}\)?\s?)?(\d{4,5}[-.\s]?\d{4}|\d{3,4}[\s-]?\d{4})/g;

            // --- Funções ---

            /**
             * Mostra uma notificação toast (sem usar alert())
             * @param {string} message - A mensagem para exibir.
             * @param {string} type - 'success' (verde/cyan) ou 'error' (vermelho).
             */
            function showToast(message, type = 'success') {
                clearTimeout(toastTimeout);
                toastMessage.textContent = message;

                if (type === 'error') {
                    toast.classList.remove('bg-cyan-600');
                    toast.classList.add('bg-red-600');
                } else {
                    toast.classList.remove('bg-red-600');
                    toast.classList.add('bg-cyan-600');
                }

                toast.classList.remove('hidden');
                toastTimeout = setTimeout(() => {
                    toast.classList.add('hidden');
                }, 3000);
            }

            /**
             * Renderiza a tabela de contatos a partir do estado `extractedContacts`.
             */
            function renderTable() {
                // Limpa o corpo da tabela
                tableBody.innerHTML = '';

                if (extractedContacts.length === 0) {
                    tableBody.appendChild(emptyRow);
                    exportBtn.disabled = true;
                    clearBtn.disabled = true;
                } else {
                    extractedContacts.forEach((contact, index) => {
                        const tr = document.createElement('tr');
                        tr.className = 'hover:bg-slate-700/50 transition duration-150';
                        
                        tr.innerHTML = `
                            <td class="p-3 text-sm text-white">${contact.name}</td>
                            <td class="p-3 text-sm text-slate-300">${contact.number}</td>
                            <td class="p-3 text-sm text-slate-300">${contact.type}</td>
                            <td class="p-3 text-sm text-slate-300">${contact.city}</td>
                            <td class="p-3 text-center">
                                <button class="delete-btn table-action-btn text-red-400" data-index="${index}" title="Remover contato">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                </button>
                            </td>
                        `;
                        tableBody.appendChild(tr);
                    });
                    exportBtn.disabled = false;
                    clearBtn.disabled = false;
                }
            }

            /**
             * Tenta extrair o nome e o telefone do texto bruto.
             * @param {string} text - O texto colado pelo usuário.
             * @returns {object} - Um objeto com { name, number }.
             */
            function parseData(text) {
                let name = 'Não encontrado';
                let number = 'Não encontrado';

                // 1. Tentar encontrar o Nome
                // Remove linhas em branco
                const lines = text.split('\n').filter(line => line.trim() !== '');
                if (lines.length > 0) {
                    // Assume que a primeira linha é o nome
                    name = lines[0].trim();
                    
                    // Se a primeira linha parecer uma categoria (ex: "Padaria"), tenta a segunda
                    // Compara com o input "tipo" ou se é muito curta
                    if (lines.length > 1 && (name.toLowerCase() === tipoInput.value.toLowerCase() || name.length < 3)) {
                        name = lines[1].trim();
                    }
                }
                
                // 2. Tentar encontrar o Telefone
                const phoneMatch = text.match(phoneRegex);
                
                if (phoneMatch) {
                    // Pega a primeira ocorrência do número de telefone
                    const rawNumber = phoneMatch[0];
                    // Limpa o número, removendo tudo exceto dígitos
                    let digits = rawNumber.replace(/\D/g, '');

                    // Tenta formatar o número para o padrão +55 XX XXXXX-XXXX
                    
                    if (digits.length === 13 && digits.startsWith('55')) {
                        // Formato: +55 89 98107-2388 (Celular 9 dígitos)
                        number = `+${digits.substring(0, 2)} ${digits.substring(2, 4)} ${digits.substring(4, 9)}-${digits.substring(9)}`;
                    } else if (digits.length === 12 && digits.startsWith('55')) {
                        // Formato: +55 89 8107-2388 (Fixo 8 dígitos)
                        number = `+${digits.substring(0, 2)} ${digits.substring(2, 4)} ${digits.substring(4, 8)}-${digits.substring(8)}`;
                    } else if (digits.length === 11 && digits.startsWith('0800')) {
                        // Formato: 0800 123 4567
                        number = `${digits.substring(0, 4)} ${digits.substring(4, 7)} ${digits.substring(7)}`;
                    } else if (digits.length === 11) {
                        // Formato: 89 98107-2388 (Celular 9 dígitos, sem 55)
                        // Adiciona o +55
                        digits = '55' + digits;
                        number = `+${digits.substring(0, 2)} ${digits.substring(2, 4)} ${digits.substring(4, 9)}-${digits.substring(9)}`;
                    } else if (digits.length === 10) {
                        // Formato: 89 8107-2388 (Fixo 8 dígitos, sem 55)
                        // Adiciona o +55
                        digits = '55' + digits;
                        number = `+${digits.substring(0, 2)} ${digits.substring(2, 4)} ${digits.substring(4, 8)}-${digits.substring(8)}`;
                    } else if (digits.length === 9) {
                        // Formato: 98107-2388 (Celular 9 dígitos, sem DDD)
                        // Formata, mas não pode adicionar DDD ou +55
                        number = `${digits.substring(0, 5)}-${digits.substring(5)}`;
                    } else if (digits.length === 8) {
                        // Formato: 8107-2388 (Fixo 8 dígitos, sem DDD)
                        // Formata
                        number = `${digits.substring(0, 4)}-${digits.substring(4)}`;
                    } else {
                        // Se não se encaixar em nenhum padrão, usa o número "limpo"
                        number = digits || 'Não encontrado';
                    }
                }

                return { name, number };
            }

            /**
             * Lida com o envio do formulário (botão "Processar").
             */
            function handleFormSubmit(e) {
                e.preventDefault();
                
                const rawText = rawDataInput.value.trim();
                const tipo = tipoInput.value.trim();
                const cidade = cidadeInput.value.trim();

                // Validação
                if (!rawText) {
                    showToast('Por favor, cole os dados brutos.', 'error');
                    rawDataInput.focus();
                    return;
                }
                if (!tipo) {
                    showToast('Por favor, informe o Tipo.', 'error');
                    tipoInput.focus();
                    return;
                }
                if (!cidade) {
                    showToast('Por favor, informe a Cidade.', 'error');
                    cidadeInput.focus();
                    return;
                }

                // Processa os dados
                const { name, number } = parseData(rawText);

                // Adiciona ao estado
                extractedContacts.push({
                    name: name,
                    number: number,
                    type: tipo,
                    city: cidade
                });

                // Atualiza a UI
                renderTable();
                showToast('Contato adicionado com sucesso!', 'success');

                // Limpa o campo de dados brutos para a próxima entrada
                rawDataInput.value = '';
            }

            /**
             * Lida com o clique no botão "Exportar CSV".
             */
            function handleExportCSV() {
                if (extractedContacts.length === 0) {
                    showToast('Não há dados para exportar.', 'error');
                    return;
                }

                // Define o cabeçalho do CSV
                const headers = ['Nome', 'Numero', 'Tipo', 'Cidade'];
                let csvContent = headers.join(',') + '\n';

                // Adiciona as linhas
                extractedContacts.forEach(contact => {
                    const row = [
                        `"${contact.name.replace(/"/g, '""')}"`,
                        `"${contact.number.replace(/"/g, '""')}"`, // O número já está formatado
                        `"${contact.type.replace(/"/g, '""')}"`,
                        `"${contact.city.replace(/"/g, '""')}"`
                    ];
                    csvContent += row.join(',') + '\n';
                });

                // Cria o arquivo para download
                // \uFEFF é o "BOM" (Byte Order Mark) para garantir que o Excel abra o UTF-8 corretamente
                const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', 'contatos_maps.csv');
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast('CSV exportado com sucesso!', 'success');
            }

            /**
             * Lida com o clique no botão "Limpar Lista".
             */
            function handleClearList() {
                // (Não usamos confirm() por segurança, mas poderíamos adicionar um modal customizado)
                extractedContacts = [];
                renderTable();
                showToast('Lista de contatos limpa.', 'success');
            }

            /**
             * Lida com cliques na tabela (para exclusão de linhas).
             */
            function handleTableClick(e) {
                const deleteButton = e.target.closest('.delete-btn');
                
                if (deleteButton) {
                    const index = parseInt(deleteButton.getAttribute('data-index'), 10);
                    
                    // Remove o item do estado
                    extractedContacts.splice(index, 1);
                    
                    // Re-renderiza a tabela
                    renderTable();
                    showToast('Contato removido.', 'success');
                }
            }

            // --- Adiciona os Event Listeners ---
            form.addEventListener('submit', handleFormSubmit);
            exportBtn.addEventListener('click', handleExportCSV);
            clearBtn.addEventListener('click', handleClearList);
            tableBody.addEventListener('click', handleTableClick);

            // Inicializa a tabela no estado vazio
            renderTable();
        });
    </script>

</body>
</html>
