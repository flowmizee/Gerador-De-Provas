<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Extrator de Contatos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Pequeno ajuste para o cabeçalho sticky da tabela */
    #contacts-table thead th { backdrop-filter: blur(4px); }

    /* Estilo personalizado para o botão de lixeira */
    .delete-btn {
      border: 1px solid #ef4444;
      transition: all 0.2s ease;
    }
    .delete-btn:hover {
      background-color: #ef4444;
      transform: scale(1.05);
    }
  </style>
</head>
<body class="bg-slate-900 text-slate-200 min-h-screen p-6">

  <!-- Toast Notification (para feedback, sem usar alert()) -->
  <div id="toast" class="fixed top-5 right-5 bg-cyan-600 text-white py-2 px-5 rounded-lg shadow-lg hidden transition-all duration-300 z-50">
    <span id="toast-message"></span>
  </div>

  <div class="max-w-7xl mx-auto">
    <!-- Cabeçalho -->
    <header class="mb-8">
      <h1 class="text-3xl md:text-4xl font-bold text-cyan-400 mb-2">Extrator de Contatos</h1>
      <p class="text-lg text-slate-400">Cole os dados brutos do Google Maps, organize e exporte como CSV.</p>
    </header>

    <!-- Container Principal (Grid Responsivo) -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

      <!-- Coluna 1: Painel de Entrada -->
      <div class="bg-slate-800 p-6 rounded-xl shadow-2xl">
        <h2 class="text-2xl font-semibold mb-6 text-white flex items-center">
          <!-- Ícone SVG para "Entrada" -->
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3 text-cyan-400">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4L18.5 2.5z"></path>
          </svg>
          Painel de Controle
        </h2>

        <form id="contact-form" class="space-y-5">
          <!-- Inputs de Contexto -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
            <div>
              <label for="tipo" class="block text-sm font-medium text-slate-300 mb-2">Tipo de Estabelecimento</label>
              <input type="text" id="tipo" name="tipo" placeholder="Ex: Restaurante, Padaria..." class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition">
            </div>
            <div>
              <label for="cidade" class="block text-sm font-medium text-slate-300 mb-2">Cidade</label>
              <input type="text" id="cidade" name="cidade" placeholder="Ex: Angical do Piauí" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition">
            </div>
          </div>

          <!-- Área de Texto para Dados Brutos -->
          <div>
            <label for="raw-data" class="block text-sm font-medium text-slate-300 mb-2">Dados Brutos (Cole aqui)</label>
            <textarea id="raw-data" name="raw-data" rows="10" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition" placeholder="Cole aqui os dados copiados (Google Maps ou Lista de Contatos)...
Pode colar vários estabelecimentos de uma vez."></textarea>
          </div>

          <!-- Botão de Processar -->
          <button type="submit" id="process-btn" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg flex items-center justify-center transition duration-300 ease-in-out transform hover:-translate-y-1">
            <!-- Ícone SVG para "Processar" -->
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
              <polyline points="23 4 23 10 17 10"></polyline>
              <polyline points="1 20 1 14 7 14"></polyline>
              <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
            </svg>
            Processar e Adicionar à Lista
          </button>
        </form>
      </div>

      <!-- Coluna 2: Tabela de Saída -->
      <div class="bg-slate-800 p-6 rounded-xl shadow-2xl">
        <h2 class="text-2xl font-semibold mb-6 text-white flex items-center">
          <!-- Ícone SVG para "Lista" -->
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3 text-cyan-400">
            <line x1="8" y1="6" x2="21" y2="6"></line>
            <line x1="8" y1="12" x2="21" y2="12"></line>
            <line x1="8" y1="18" x2="21" y2="18"></line>
            <line x1="3" y1="6" x2="3.01" y2="6"></line>
            <line x1="3" y1="12" x2="3.01" y2="12"></line>
            <line x1="3" y1="18" x2="3.01" y2="18"></line>
          </svg>
          Contatos Extraídos
        </h2>

        <!-- Wrapper da Tabela para rolagem em telas pequenas -->
        <div id="table-wrapper" class="overflow-x-auto max-h-[400px] rounded-lg border border-slate-700">
          <table id="contacts-table" class="w-full text-left">
            <thead class="bg-slate-700 sticky top-0">
              <tr>
                <th class="p-3 text-sm font-semibold text-slate-300 uppercase">Nome</th>
                <th class="p-3 text-sm font-semibold text-slate-300 uppercase">Número</th>
                <th class="p-3 text-sm font-semibold text-slate-300 uppercase">Tipo</th>
                <th class="p-3 text-sm font-semibold text-slate-300 uppercase">Cidade</th>
                <th class="p-3 text-sm font-semibold text-slate-300 uppercase text-center">Ação</th>
              </tr>
            </thead>
            <tbody id="contacts-tbody" class="divide-y divide-slate-700">
              <!-- Linhas serão inseridas pelo JavaScript -->
              <tr id="empty-row">
                <td colspan="5" class="p-8 text-center text-slate-500">Nenhum contato adicionado ainda.</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Botões de Ação da Tabela -->
        <div class="mt-6 flex flex-col sm:flex-row gap-4">
          <button id="export-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg flex items-center justify-center transition duration-300 ease-in-out transform hover:-translate-y-1 disabled:opacity-50 disabled:transform-none" disabled>
            <!-- Ícone SVG para "Exportar" -->
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Exportar CSV
          </button>
          <button id="clear-btn" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg flex items-center justify-center transition duration-300 ease-in-out transform hover:-translate-y-1 disabled:opacity-50 disabled:transform-none" disabled>
            <!-- Ícone SVG para "Limpar" -->
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
              <line x1="10" y1="11" x2="10" y2="17"></line>
              <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
            Limpar Lista
          </button>
        </div>
      </div>

    </div>
  </div>

  <!-- Script Principal -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- Seletores do DOM ---
      const form = document.getElementById('contact-form');
      const rawDataInput = document.getElementById('raw-data');
      const tipoInput = document.getElementById('tipo');
      const cidadeInput = document.getElementById('cidade');
      const tableBody = document.getElementById('contacts-tbody');
      const emptyRow = document.getElementById('empty-row');
      const exportBtn = document.getElementById('export-btn');
      const clearBtn = document.getElementById('clear-btn');
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toast-message');

      // --- Estado da Aplicação ---
      let extractedContacts = [];
      let toastTimeout;

      // --- Expressões Regulares (RegEx) ---
      const phoneRegex = /(?:\+?55[\s-]?)?(?:\(?\d{2}\)?[\s.-]*)?(?:9?\d{4}[\s.-]*\d{4}|\d{4}[\s.-]*\d{4})/g;

      const junkRegex = /^(Abrir app|Seu local||||Fotos|Foto|Street View|Resumo de avaliações|R\.|Av\.|Avenida|Travessa|Alameda|Praça|Largo|Vila|Bairro|Centro|Zona|Rod\.|Rodovia|BR-|Estrada|#)$/i;

      const ratingRegex = /^(\d{1,2}([,.]\d)?|\d{1,3}([,.]\d{1,2})?)$/;

      function showToast(message, type = 'success') {
        clearTimeout(toastTimeout);
        toastMessage.textContent = message;
        if (type === 'error') {
          toast.classList.remove('bg-cyan-600');
          toast.classList.add('bg-red-600');
        } else {
          toast.classList.remove('bg-red-600');
          toast.classList.add('bg-cyan-600');
        }
        toast.classList.remove('hidden');
        toastTimeout = setTimeout(() => {
          toast.classList.add('hidden');
        }, 3000);
      }

      function renderTable() {
        tableBody.innerHTML = '';
        if (extractedContacts.length === 0) {
          tableBody.appendChild(emptyRow);
          exportBtn.disabled = true;
          clearBtn.disabled = true;
        } else {
          extractedContacts.forEach((contact, index) => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-slate-700/50 transition duration-150';
            tr.innerHTML = `
              <td class="p-3 align-top">${escapeHtml(contact.name)}</td>
              <td class="p-3 align-top">${escapeHtml(contact.number)}</td>
              <td class="p-3 align-top">${escapeHtml(contact.type)}</td>
              <td class="p-3 align-top">${escapeHtml(contact.city)}</td>
              <td class="p-3 text-center align-top">
                <button class="delete-btn inline-flex items-center justify-center p-2 bg-transparent text-red-500 hover:text-white rounded-lg cursor-pointer" data-index="${index}" title="Excluir contato">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    <line x1="10" y1="11" x2="10" y2="17"></line>
                    <line x1="14" y1="11" x2="14" y2="17"></line>
                  </svg>
                </button>
              </td>
            `;
            tableBody.appendChild(tr);
          });
          exportBtn.disabled = false;
          clearBtn.disabled = false;
        }
      }

      function escapeHtml(str) {
        if (!str && str !== 0) return '';
        return String(str)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function formatPhoneNumber(rawNumber) {
        if (!rawNumber) return 'Não encontrado';
        let digits = rawNumber.replace(/\D/g, '');

        if (digits.length === 0) return 'Não encontrado';

        if (digits.startsWith('55') && digits.length >= 12) {
          const rest = digits.substring(2);
          if (rest.length === 11) {
            return '+' + digits.substring(0,2) + ' ' + rest.substring(0,2) + ' ' + rest.substring(2,7) + '-' + rest.substring(7);
          } else if (rest.length === 10) {
            return '+' + digits.substring(0,2) + ' ' + rest.substring(0,2) + ' ' + rest.substring(2,6) + '-' + rest.substring(6);
          }
        }

        if (digits.length === 11) {
          const with55 = '55' + digits;
          return '+' + with55.substring(0,2) + ' ' + with55.substring(2,4) + ' ' + with55.substring(4,9) + '-' + with55.substring(9);
        } else if (digits.length === 10) {
          const with55 = '55' + digits;
          return '+' + with55.substring(0,2) + ' ' + with55.substring(2,4) + ' ' + with55.substring(4,8) + '-' + with55.substring(8);
        } else if (digits.length === 9) {
          return digits.substring(0,5) + '-' + digits.substring(5);
        } else if (digits.length === 8) {
          return digits.substring(0,4) + '-' + digits.substring(4);
        } else if (digits.length > 0 && digits.length <= 7) {
          return digits;
        }

        return rawNumber.trim();
      }

      function parseShortLine(line) {
        const trimmed = line.trim();
        if (!trimmed) return null;

        const phoneMatch = trimmed.match(phoneRegex);
        if (!phoneMatch) return null;

        const sepMatch = trimmed.match(/^(.{1,120}?)\s*[:\-–]\s*(.+)$/);
        if (sepMatch) {
          const maybeName = sepMatch[1].trim();
          const maybePhonePart = sepMatch[2].trim();
          const phoneFound = maybePhonePart.match(phoneRegex);
          if (maybeName && phoneFound) {
            return { name: maybeName, number: phoneFound[0] };
          }
        }

        const firstPhone = phoneMatch[0];
        const idx = trimmed.indexOf(firstPhone);
        if (idx > 0) {
          const namePart = trimmed.substring(0, idx).replace(/[:\-–]+$/,'').trim();
          if (namePart.length >= 2) {
            return { name: namePart, number: firstPhone };
          }
        }

        return null;
      }

      function parseData(text, tipoCampo, cidadeCampo) {
        let name = 'Não encontrado';
        let number = 'Não encontrado';

        const normalizedText = text
          .replace(/\r/g, '\n')
          .replace(/\u00A0/g, ' ')
          .replace(/\n{2,}/g, '\n\n');

        const lines = normalizedText
          .split('\n')
          .map(l => l.trim())
          .filter(line => line !== '');

        // 0) Tenta primeiro o formato simples "Nome: telefone" dentro do bloco
        for (let l of lines) {
          const short = parseShortLine(l);
          if (short) {
            name = short.name;
            number = formatPhoneNumber(short.number);
            return { name, number };
          }
        }

        // 1) Nome: linha imediatamente anterior à primeira ocorrência de "avalia" dentro do bloco
        const avalIndex = lines.findIndex(l => l.toLowerCase().includes('avalia'));
        if (avalIndex > 0) {
          for (let i = avalIndex - 1; i >= 0; i--) {
            const candidate = lines[i].trim();

            if (
              candidate.length > 1 &&
              !junkRegex.test(candidate) &&
              !ratingRegex.test(candidate) &&
              candidate.toLowerCase() !== (tipoCampo || '').toLowerCase() &&
              !candidate.toLowerCase().includes('rotas') &&
              !candidate.toLowerCase().includes('iniciar') &&
              !candidate.toLowerCase().includes('ligar') &&
              !candidate.toLowerCase().includes('salvar') &&
              !candidate.toLowerCase().includes('compartilhar') &&
              !candidate.toLowerCase().includes('lugares também pesquisados')
            ) {
              name = candidate;
              break;
            }
          }
        }

        // 2) Telefone: primeira ocorrência válida no bloco
        const phoneMatch = normalizedText.match(phoneRegex);
        if (phoneMatch) {
          number = formatPhoneNumber(phoneMatch[0]);
        }

        // 3) Plano B pro nome: tenta primeira linha do bloco
        if (name === 'Não encontrado' && lines.length > 0) {
          const first = lines[0];
          if (first && !junkRegex.test(first) && !ratingRegex.test(first) && first.length > 1) {
            if (!phoneRegex.test(first)) {
              name = first;
            } else {
              const match = first.match(/^(.*?)\s*(?:\+?55|\(?\d{2}\)?)/);
              if (match && match[1] && match[1].trim().length > 1) {
                name = match[1].trim();
              }
            }
          }
        }

        return { name, number };
      }

      function handleFormSubmit(e) {
        e.preventDefault();
        const rawTextOriginal = rawDataInput.value;
        const rawText = rawTextOriginal.trim();
        const tipo = tipoInput.value.trim();
        const cidade = cidadeInput.value.trim();

        if (!rawText) {
          showToast('Por favor, cole os dados brutos.', 'error');
          rawDataInput.focus();
          return;
        }
        if (!tipo) {
          showToast('Por favor, informe o Tipo.', 'error');
          tipoInput.focus();
          return;
        }
        if (!cidade) {
          showToast('Por favor, informe a Cidade.', 'error');
          cidadeInput.focus();
          return;
        }

        const normalizedRaw = rawText
          .replace(/\r/g, '\n')
          .replace(/\u00A0/g, ' ')
          .replace(/\n{2,}/g, '\n\n');

        // SEM "modo global": SEMPRE divide por "Sobre esses dados"
        const blocosDeTexto = normalizedRaw.split('Sobre esses dados');
        let contatosAdicionados = 0;

        blocosDeTexto.forEach(bloco => {
          if (bloco.trim().length < 3) return;

          const normalizedBlock = bloco.replace(/\r/g, '\n').replace(/\u00A0/g, ' ');
          const linhas = normalizedBlock
            .split('\n')
            .map(l => l.trim())
            .filter(l => l !== '');

          const isMapsPage =
            normalizedBlock.toLowerCase().includes('avalia') ||
            normalizedBlock.toLowerCase().includes('resumo de avaliações');

          if (isMapsPage) {
            // 1 contato por página
            const parsed = parseData(normalizedBlock, tipo, cidade);
            if (parsed.name !== 'Não encontrado' || parsed.number !== 'Não encontrado') {
              extractedContacts.push({
                name: parsed.name,
                number: parsed.number,
                type: tipo,
                city: cidade
              });
              contatosAdicionados++;
            }
          } else {
            // Lista simples: Nome: telefone, etc.
            const linesWithPhone = linhas.filter(l => phoneRegex.test(l));

            if (linesWithPhone.length >= 1) {
              linhas.forEach(line => {
                const short = parseShortLine(line);
                if (short) {
                  const { name, number } = short;
                  if ((name && name !== 'Não encontrado') || (number && number !== 'Não encontrado')) {
                    extractedContacts.push({
                      name: name,
                      number: formatPhoneNumber(number),
                      type: tipo,
                      city: cidade
                    });
                    contatosAdicionados++;
                  }
                } else {
                  const parsed = parseData(line, tipo, cidade);
                  if (parsed.name !== 'Não encontrado' || parsed.number !== 'Não encontrado') {
                    extractedContacts.push({
                      name: parsed.name,
                      number: parsed.number,
                      type: tipo,
                      city: cidade
                    });
                    contatosAdicionados++;
                  }
                }
              });
            } else {
              const parsed = parseData(normalizedBlock, tipo, cidade);
              if (parsed.name !== 'Não encontrado' || parsed.number !== 'Não encontrado') {
                extractedContacts.push({
                  name: parsed.name,
                  number: parsed.number,
                  type: tipo,
                  city: cidade
                });
                contatosAdicionados++;
              }
            }
          }
        });

        if (contatosAdicionados > 0) {
          renderTable();
          showToast(`${contatosAdicionados} contatos adicionados com sucesso!`, 'success');
          rawDataInput.value = '';
        } else {
          showToast('Não foi possível encontrar nenhum contato válido no texto.', 'error');
        }
      }

      function handleExportCSV() {
        if (extractedContacts.length === 0) {
          showToast('Não há dados para exportar.', 'error');
          return;
        }
        const headers = ['Nome', 'Numero', 'Tipo', 'Cidade'];
        let csvContent = headers.join(',') + '\n';
        extractedContacts.forEach(contact => {
          const row = [contact.name, contact.number, contact.type, contact.city].map(v => '"' + String(v || '').replace(/"/g, '""') + '"');
          csvContent += row.join(',') + '\n';
        });

        const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'contatos_maps.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast('CSV exportado com sucesso!', 'success');
      }

      function handleClearList() {
        extractedContacts = [];
        renderTable();
        showToast('Lista de contatos limpa.', 'success');
      }

      function handleTableClick(e) {
        const deleteButton = e.target.closest('.delete-btn');
        if (deleteButton) {
          const index = parseInt(deleteButton.getAttribute('data-index'), 10);
          if (!isNaN(index)) {
            extractedContacts.splice(index, 1);
            renderTable();
            showToast('Contato removido.', 'success');
          }
        }
      }

      form.addEventListener('submit', handleFormSubmit);
      exportBtn.addEventListener('click', handleExportCSV);
      clearBtn.addEventListener('click', handleClearList);
      tableBody.addEventListener('click', handleTableClick);

      renderTable();
    });
  </script>

</body>
</html>
