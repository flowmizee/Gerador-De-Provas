<!DOCTYPE html>
<html lang="pt-BR" class="antialiased">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Gerador de Provas</title>

    <!-- Fonte e Tailwind (CDN) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* Reset / fontes */
        :root { --bg:#F8FAFC; --card:#FFFFFF; --muted:#6B7280; --accent:#0EA5A4; --text:#0F172A; }
        html,body { height:100%; margin:0; font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
        body { background:var(--bg); color:var(--text); transition:background-color .25s,color .25s; }

        /* Dark theme (manual CSS to avoid using @apply) */
        .dark { background:#0b1220; color:#e6eef6; }
        .dark .card { background:#071027; }
        .dark .muted { color:#94a3b8; }
        .dark .border-light { border-color:#273444; }
        .dark .logo-placeholder { color:#94a3b8; }

        /* Layout geral */
        .container { max-width:1100px; margin:20px auto; padding:18px; }
        .card { background:var(--card); border-radius:10px; padding:18px; box-shadow:0 8px 24px rgba(2,6,23,0.06); border:1px solid rgba(15,23,42,0.06); }
        .small { font-size:13px; color:var(--muted); }

        /* Header (logo + info) */
        #logo-container { cursor:pointer; width:120px; height:92px; border:2px dashed #CBD5E1; border-radius:8px; display:flex; align-items:center; justify-content:center; overflow:hidden; background:white; }
        #logo-container.drag { border-color:#60A5FA; background:#F1F5F9; }
        #logo-preview { width:100%; height:100%; object-fit:contain; display:block; }

        /* Header text */
        .header-field { font-size:18px; line-height:1.1; }
        .header-sub { font-size:15px; }

        /* Question area */
        #question-list { margin-top:12px; }
        .question-card { position:relative; border-radius:10px; border:1px solid rgba(15,23,42,0.04); padding:14px; background:var(--card); }
        .question-number { font-weight:700; color:#0EA5A4; margin-right:8px; font-size:18px; }

        /* Lines that appear in preview and export */
        .question-line {
            border-bottom: 1.5px solid #000;
            height: 28px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }

        /* Print area styling (A4) */
        #print-area, #gabarito-area {
            width:210mm;
            height:297mm;
            box-sizing:border-box;
            padding:16mm;
            background:#fff;
            overflow:hidden; /* Important: clip extra content so export is 1 page */
        }
        /* Paper header inside print */
        .paper-header { display:flex; gap:12px; align-items:flex-start; border-bottom:1px solid rgba(0,0,0,0.12); padding-bottom:8px; margin-bottom:12px; }
        .paper-logo { height:84px; width:auto; object-fit:contain; display:block; }

        /* small util */
        .no-print { }
        .hidden { display:none; }

        /* Message box */
        #message-box { min-width:180px; max-width:320px; }

        /* Responsive */
        @media(max-width:900px){
            #logo-container { width:96px; height:72px; margin-bottom:8px; }
            .header-field { font-size:16px; }
            #print-area, #gabarito-area { width:100%; height:auto; padding:16px; }
        }

        /* Print media (for direct print, but export uses the #print-area element) */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left:0; top:0; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 transition-colors duration-300">
    <div class="container">
        <!-- Main app -->
        <div id="app">

            <div class="flex justify-end mb-4">
                <button id="theme-toggle" class="p-2 rounded-full bg-gray-200 transition-colors duration-200" title="Tema claro/escuro">
                    <!-- moon icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                    </svg>
                </button>
            </div>

            <!-- Header card: logo + fields -->
            <div class="card mb-6">
                <div class="flex flex-col md:flex-row items-start gap-6">
                    <!-- Logo -->
                    <div class="flex-shrink-0">
                        <div id="logo-container" aria-label="Logo da escola (clique para enviar ou arraste a imagem)">
                            <input id="logo-upload" type="file" accept="image/*" class="hidden" />
                            <img id="logo-preview" src="" alt="Logo" style="display:none;">
                            <div id="logo-placeholder" class="logo-placeholder text-sm text-gray-500 text-center px-2">Arraste ou clique para adicionar a logo</div>
                        </div>
                        <div class="mt-2 text-xs small text-gray-500">Altura da logo ajusta-se automaticamente</div>
                    </div>

                    <!-- Header info -->
                    <div id="header-info" class="flex-1">
                        <div class="flex justify-end items-center gap-2 mb-3">
                            <span class="small text-gray-600">Alinhamento:</span>
                            <div class="flex items-center gap-1">
                                <button id="align-left" class="px-2 py-1 rounded hover:bg-gray-100 text-sm">Esq</button>
                                <button id="align-center" class="px-2 py-1 rounded hover:bg-gray-100 text-sm">Cen</button>
                                <button id="align-right" class="px-2 py-1 rounded hover:bg-gray-100 text-sm">Dir</button>
                            </div>
                        </div>

                        <div id="header-text-container" class="text-right">
                            <div class="header-field" data-key="schoolName" contenteditable="true">NOME DA ESCOLA</div>
                            <div class="header-sub header-field" data-key="student" contenteditable="true">ALUNO(A): ________________________________</div>
                            <div class="header-sub header-field" data-key="teacher" contenteditable="true">PROFESSOR(A): ________________________________</div>
                            <div class="header-sub header-field" data-key="subject" contenteditable="true">COMPONENTE CURRICULAR: __________________</div>
                            <div class="header-sub header-field" data-key="info" contenteditable="true">ANO/TURMA: _______  DATA: ___/___/____</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Paste / process area -->
            <div class="card mb-6">
                <h2 class="text-lg font-semibold mb-2">Analisar Questões</h2>
                <p class="small mb-3">Cole o texto das questões no campo abaixo. O sistema reconhecerá numeração como <code>1.</code>, <code>1)</code>, <code>1 -</code> e dividirá em questões.</p>
                <textarea id="question-input" rows="8" class="w-full border rounded p-3 focus:outline-none focus:ring-2 focus:ring-blue-400 resize-vertical" placeholder="Cole suas questões aqui..."></textarea>

                <div class="flex gap-3 mt-4">
                    <button id="process-questions" class="bg-blue-600 text-white px-4 py-2 rounded font-semibold">Analisar e Gerar</button>
                    <button id="add-manual" class="bg-gray-200 px-4 py-2 rounded">Adicionar Questão Manual</button>
                </div>
            </div>

            <!-- Question list -->
            <div id="question-list" class="space-y-4"></div>

            <!-- Controls -->
            <div class="flex gap-3 mt-6">
                <button id="export-pdf" class="bg-green-600 text-white px-6 py-3 rounded font-semibold">Gerar Prova PDF</button>
                <button id="export-gabarito" class="bg-yellow-500 text-black px-6 py-3 rounded font-semibold">Gerar Gabarito PDF</button>
                <button id="clear-exam" class="bg-red-500 text-white px-6 py-3 rounded font-semibold">Limpar Prova</button>
            </div>

            <!-- Message box -->
            <div id="message-box" class="fixed bottom-6 right-6 hidden"></div>
        </div>
    </div>

    <!-- Hidden A4 Print Preview Area (single page) -->
    <div id="print-area" class="hidden"></div>

    <!-- Hidden Answer Key Area -->
    <div id="gabarito-area" class="hidden"></div>

    <script>
        /* ---------- Estado inicial ---------- */
        const stateKey = 'examGeneratorState_v2';
        const state = {
            header: {
                logo: '',
                alignment: 'text-right',
                schoolName: 'NOME DA ESCOLA',
                student: 'ALUNO(A): ___________________________',
                teacher: 'PROFESSOR(A): _______________________',
                subject: 'COMPONENTE CURRICULAR: ____________',
                info: 'ANO/TURMA: ___  DATA: __/__/____'
            },
            questions: [],
            theme: 'light'
        };

        let saveTimeout = null;

        /* ---------- Helpers ---------- */
        function showMessage(msg, type = 'info') {
            const box = document.getElementById('message-box');
            box.textContent = msg;
            box.className = 'fixed bottom-6 right-6 p-3 rounded shadow-lg text-white font-semibold';
            if (type === 'success') box.style.background = '#10B981';
            else if (type === 'error') box.style.background = '#EF4444';
            else box.style.background = '#3B82F6';
            box.style.opacity = '1';
            box.style.display = 'block';
            setTimeout(() => {
                box.style.opacity = '0';
                setTimeout(()=> box.style.display = 'none', 300);
            }, 2600);
        }

        function saveState() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                try {
                    localStorage.setItem(stateKey, JSON.stringify(state));
                    console.log('Estado salvo');
                } catch (e) {
                    console.error('Erro salvando estado', e);
                }
            }, 350);
        }

        function loadState() {
            try {
                const raw = localStorage.getItem(stateKey);
                if (raw) {
                    const parsed = JSON.parse(raw);
                    Object.assign(state, parsed);
                } else {
                    // exemplo inicial
                    state.header.schoolName = 'Unidade Integrada José Joaquim de Araújo';
                    state.header.student = 'ALUNO(A): ___________________________';
                    state.header.teacher = 'PROFESSOR(A): RENIMAR ALMEIDA';
                    state.header.subject = 'COMPONENTE CURRICULAR: INGLÊS';
                    state.header.info = 'ANO/TURMA: ______  DATA: __/__/____';
                    state.questions = [
                        { id: crypto.randomUUID(), text: '1. Escreva seu nome completo.', image: '', imageSize: 100, lines: 1, isAnswerKey:false },
                        { id: crypto.randomUUID(), text: '2. Traduza para o inglês: "Bom dia".', image: '', imageSize: 100, lines: 2, isAnswerKey:false }
                    ];
                }
            } catch (e) { console.error('Erro ao carregar estado', e); }
        }

        /* ---------- Render Header ---------- */
        function renderHeader() {
            const headerContainer = document.getElementById('header-text-container');
            headerContainer.className = `${state.header.alignment}`;
            const keys = ['schoolName','student','teacher','subject','info'];
            keys.forEach(k => {
                const el = headerContainer.querySelector(`[data-key="${k}"]`);
                if (el) el.textContent = state.header[k];
            });

            // logo
            const logoPreview = document.getElementById('logo-preview');
            const logoPlaceholder = document.getElementById('logo-placeholder');
            if (state.header.logo) {
                logoPreview.src = state.header.logo;
                logoPreview.style.display = 'block';
                logoPlaceholder.style.display = 'none';
            } else {
                logoPreview.style.display = 'none';
                logoPlaceholder.style.display = 'block';
            }

            // highlight align buttons
            ['left','center','right'].forEach(pos => {
                const btn = document.getElementById(`align-${pos}`);
                btn.classList.remove('bg-gray-200');
                if (state.header.alignment === `text-${pos}`) btn.classList.add('bg-gray-200');
            });
        }

        /* ---------- Render Questions (editor) ---------- */
        function renderQuestions() {
            const list = document.getElementById('question-list');
            list.innerHTML = '';
            state.questions.forEach((q, idx) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'question-card card';
                wrapper.dataset.id = q.id;
                wrapper.id = `question-${q.id}`;

                // build html
                wrapper.innerHTML = `
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center">
                            <div class="question-number">${idx + 1}.</div>
                            <div contenteditable="true" class="question-text border border-transparent focus:border-blue-200 p-1" data-id="${q.id}">${escapeHtml(q.text)}</div>
                        </div>
                        <div class="flex gap-2">
                            <button class="duplicate-btn" title="Duplicar">Duplicar</button>
                            <button class="move-up-btn" title="Mover para cima">↑</button>
                            <button class="move-down-btn" title="Mover para baixo">↓</button>
                            <button class="remove-btn text-red-600" title="Remover">Remover</button>
                        </div>
                    </div>
                    ${ q.image ? `
                        <div class="mb-3">
                            <img src="${q.image}" style="width:${q.imageSize}%;" class="rounded shadow" alt="Imagem da questão" />
                            <div class="mt-2 flex items-center gap-2">
                                <input type="range" min="10" max="100" value="${q.imageSize}" data-id="${q.id}" class="image-size-slider"/>
                                <button class="remove-image-btn" data-id="${q.id}">Remover imagem</button>
                            </div>
                        </div>
                    ` : `
                        <div class="mb-3 text-sm text-gray-500">Arraste uma imagem sobre este cartão ou clique nele para enviar (opcional).</div>
                    `}
                    <div class="mb-1">Número de linhas: <span class="font-semibold">${q.lines}</span></div>
                    <input type="range" min="0" max="10" value="${q.lines}" data-id="${q.id}" class="response-lines-slider w-full"/>
                `;

                // allow dropping images on the card
                wrapper.addEventListener('dragover', (ev) => { ev.preventDefault(); wrapper.classList.add('drag'); });
                wrapper.addEventListener('dragleave', (ev) => { wrapper.classList.remove('drag'); });
                wrapper.addEventListener('drop', (ev) => {
                    ev.preventDefault(); wrapper.classList.remove('drag');
                    const f = ev.dataTransfer.files && ev.dataTransfer.files[0];
                    if (f && f.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            q.image = e.target.result;
                            q.imageSize = 100;
                            saveState();
                            renderQuestions();
                            showMessage('Imagem adicionada à questão', 'success');
                        };
                        reader.readAsDataURL(f);
                    } else {
                        showMessage('Solte uma imagem válida.', 'error');
                    }
                });

                list.appendChild(wrapper);
            });

            //listeners after render
            setupQuestionListeners();
        }

        /* ---------- Question Listeners ---------- */
        function setupQuestionListeners() {
            // text edits
            document.querySelectorAll('.question-text').forEach(el => {
                el.addEventListener('input', (e) => {
                    const id = e.target.dataset.id;
                    const q = state.questions.find(x => x.id === id);
                    if (q) { q.text = e.target.textContent; saveState(); }
                });
            });

            // response lines slider
            document.querySelectorAll('.response-lines-slider').forEach(el => {
                el.addEventListener('input', (e) => {
                    const id = e.target.dataset.id;
                    const q = state.questions.find(x => x.id === id);
                    if (q) {
                        q.lines = parseInt(e.target.value,10);
                        saveState();
                        renderQuestions(); // to update displayed number
                    }
                });
            });

            // image-size slider
            document.querySelectorAll('.image-size-slider').forEach(el => {
                el.addEventListener('input', (e) => {
                    const id = e.target.dataset.id;
                    const q = state.questions.find(x => x.id === id);
                    if (q) {
                        q.imageSize = parseInt(e.target.value,10);
                        saveState();
                        renderQuestions();
                    }
                });
            });

            // remove image
            document.querySelectorAll('.remove-image-btn').forEach(b => {
                b.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    const q = state.questions.find(x => x.id === id);
                    if (q) { q.image = ''; q.imageSize = 100; saveState(); renderQuestions(); }
                });
            });

            // duplicate
            document.querySelectorAll('.duplicate-btn').forEach(b => {
                b.addEventListener('click', (e) => {
                    const card = e.currentTarget.closest('.question-card');
                    const id = card.dataset.id;
                    const idx = state.questions.findIndex(x => x.id === id);
                    if (idx !== -1) {
                        const copy = JSON.parse(JSON.stringify(state.questions[idx]));
                        copy.id = crypto.randomUUID();
                        state.questions.splice(idx+1,0,copy);
                        saveState(); renderQuestions(); showMessage('Questão duplicada', 'success');
                    }
                });
            });

            // remove
            document.querySelectorAll('.remove-btn').forEach(b => {
                b.addEventListener('click', (e) => {
                    const card = e.currentTarget.closest('.question-card');
                    const id = card.dataset.id;
                    state.questions = state.questions.filter(x => x.id !== id);
                    saveState(); renderQuestions(); showMessage('Questão removida', 'info');
                });
            });

            // move up / down
            document.querySelectorAll('.move-up-btn').forEach(b => {
                b.addEventListener('click', (e) => {
                    const id = e.currentTarget.closest('.question-card').dataset.id;
                    const idx = state.questions.findIndex(x => x.id === id);
                    if (idx > 0) { const [q] = state.questions.splice(idx,1); state.questions.splice(idx-1,0,q); saveState(); renderQuestions(); }
                });
            });
            document.querySelectorAll('.move-down-btn').forEach(b => {
                b.addEventListener('click', (e) => {
                    const id = e.currentTarget.closest('.question-card').dataset.id;
                    const idx = state.questions.findIndex(x => x.id === id);
                    if (idx < state.questions.length - 1) { const [q] = state.questions.splice(idx,1); state.questions.splice(idx+1,0,q); saveState(); renderQuestions(); }
                });
            });

            // allow clicking on card to upload image
            document.querySelectorAll('.question-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    // only trigger if clicking on background (not on buttons)
                    if (e.target.closest('button')) return;
                    const id = card.dataset.id;
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*';
                    input.onchange = (ev) => {
                        const f = ev.target.files[0];
                        if (f && f.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onload = (r) => {
                                const q = state.questions.find(x => x.id === id);
                                if (q) { q.image = r.target.result; q.imageSize = 100; saveState(); renderQuestions(); showMessage('Imagem adicionada', 'success'); }
                            };
                            reader.readAsDataURL(f);
                        } else showMessage('Escolha uma imagem válida', 'error');
                    };
                    input.click();
                });
            });
        }

        /* ---------- Process pasted text -> questions ---------- */
        function processPastedText() {
            const text = document.getElementById('question-input').value.trim();
            if (!text) { showMessage('Nenhum texto encontrado.', 'error'); return; }

            // normalize line endings and ensure split by question numbers
            // We'll capture blocks that start with a number + dot / ) / -
            const lines = text.split(/\r?\n/);
            const joined = lines.join('\n');
            // Add a marker before each new question start
            const splitted = joined.split(/(?=\n?\s*\d+\s*(?:\.|\)|-))/g).map(s => s.trim()).filter(Boolean);

            const newQuestions = [];
            for (const block of splitted) {
                // remove a leading number and separator
                const m = block.match(/^\s*\d+\s*(?:\.|\)|-)?\s*(.*)$/s);
                const content = m ? m[1].trim() : block.trim();
                if (content) {
                    newQuestions.push({
                        id: crypto.randomUUID(),
                        text: content,
                        image: '',
                        imageSize: 100,
                        lines: 3,
                        isAnswerKey: false
                    });
                }
            }

            if (newQuestions.length === 0) { showMessage('Não foram detectadas questões no texto.', 'error'); return; }
            state.questions = state.questions.concat(newQuestions);
            document.getElementById('question-input').value = '';
            saveState();
            renderQuestions();
            showMessage(`Geradas ${newQuestions.length} questão(ões).`, 'success');
        }

        /* ---------- Render printable content (single A4 page) ---------- */
        function renderPrintableContent(isGabarito = false) {
            const target = isGabarito ? document.getElementById('gabarito-area') : document.getElementById('print-area');
            // reset
            target.innerHTML = '';
            // Build header
            const logoHtml = state.header.logo ? `<img src="${state.header.logo}" class="paper-logo" alt="logo">` : '';
            const headerHtml = `
                <div class="paper-header">
                    <div class="flex-shrink-0">${logoHtml}</div>
                    <div class="${state.header.alignment}" style="flex:1;">
                        <div style="font-weight:700; font-size:18px; margin-bottom:6px;">${escapeHtml(state.header.schoolName)}</div>
                        <div style="font-size:15px; margin-bottom:4px;">${escapeHtml(state.header.student)}</div>
                        <div style="font-size:15px; margin-bottom:4px;">${escapeHtml(state.header.teacher)}</div>
                        <div style="font-size:15px; margin-bottom:4px;">${escapeHtml(state.header.subject)}</div>
                        <div style="font-size:15px;">${escapeHtml(state.header.info)}</div>
                    </div>
                </div>
            `;
            let bodyHtml = '';
            // Add questions sequentially until clipped by the fixed #print-area height; we will add all but rely on overflow:hidden to clip.
            state.questions.forEach((q, i) => {
                const qNum = i + 1;
                const qText = escapeHtml(q.text);
                const imgHtml = q.image ? `<div style="text-align:center; margin:8px 0;"><img src="${q.image}" style="width:${q.imageSize}%; max-width:100%; display:inline-block;"></div>` : '';
                if (isGabarito) {
                    // For gabarito we show number and placeholder for the answer (if any)
                    bodyHtml += `<div style="margin-bottom:10px;"><strong>${qNum}.</strong> ${qText}<div style="margin-top:6px;">Resposta: ____________________________</div></div>`;
                } else {
                    bodyHtml += `
                        <div style="margin-bottom:8px;">
                            <div style="font-size:14px; margin-bottom:6px;"><strong>${qNum}.</strong> ${qText}</div>
                            ${imgHtml}
                            ${Array.from({length: Math.max(0, q.lines)}).map(()=>`<div class="question-line"></div>`).join('')}
                        </div>
                    `;
                }
            });

            target.innerHTML = `<div class="paper-content">${headerHtml}<div class="paper-body" style="margin-top:10px;">${bodyHtml}</div></div>`;
        }

        /* ---------- Export functions ---------- */
        function exportPDF() {
            renderPrintableContent(false);
            const element = document.getElementById('print-area');

            // ensure the element is visible to html2pdf
            element.classList.remove('hidden');

            const filename = `${(state.header.subject || 'Prova').replace(/\s+/g,'_')}_${new Date().toISOString().slice(0,10)}.pdf`;

            html2pdf().set({
                margin: 8,
                filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, logging: false },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            }).from(element).save().finally(() => {
                // hide again
                element.classList.add('hidden');
            });
        }

        function exportGabaritoPDF() {
            renderPrintableContent(true);
            const element = document.getElementById('gabarito-area');
            element.classList.remove('hidden');
            const filename = `Gabarito_${(state.header.subject || 'Gabarito').replace(/\s+/g,'_')}_${new Date().toISOString().slice(0,10)}.pdf`;

            html2pdf().set({
                margin: 8,
                filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, logging: false },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            }).from(element).save().finally(() => {
                element.classList.add('hidden');
            });
        }

        /* ---------- Utilities ---------- */
        function escapeHtml(text) {
            if (!text && text !== '') return '';
            return String(text)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        /* ---------- Event bindings ---------- */
        document.addEventListener('DOMContentLoaded', () => {
            loadState();
            renderHeader();
            renderQuestions();

            // header inline edits
            document.querySelectorAll('.header-field').forEach(el => {
                el.addEventListener('input', (e) => {
                    const key = e.target.dataset.key;
                    if (key) {
                        state.header[key] = e.target.textContent;
                        saveState();
                        renderHeader();
                    }
                });
            });

            // logo upload / drag & drop
            const logoContainer = document.getElementById('logo-container');
            const logoInput = document.getElementById('logo-upload');
            logoContainer.addEventListener('click', () => logoInput.click());
            logoInput.addEventListener('change', (e) => {
                const f = e.target.files[0];
                if (f && f.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        state.header.logo = ev.target.result;
                        saveState();
                        renderHeader();
                    };
                    reader.readAsDataURL(f);
                } else showMessage('Escolha uma imagem válida.', 'error');
            });
            logoContainer.addEventListener('dragover', (e) => { e.preventDefault(); logoContainer.classList.add('drag'); });
            logoContainer.addEventListener('dragleave', (e) => { logoContainer.classList.remove('drag'); });
            logoContainer.addEventListener('drop', (e) => {
                e.preventDefault(); logoContainer.classList.remove('drag');
                const f = e.dataTransfer.files && e.dataTransfer.files[0];
                if (f && f.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        state.header.logo = ev.target.result;
                        saveState();
                        renderHeader();
                    };
                    reader.readAsDataURL(f);
                } else showMessage('Solte um arquivo de imagem.', 'error');
            });

            // alignment buttons
            document.getElementById('align-left').addEventListener('click', () => { state.header.alignment = 'text-left'; saveState(); renderHeader(); });
            document.getElementById('align-center').addEventListener('click', () => { state.header.alignment = 'text-center'; saveState(); renderHeader(); });
            document.getElementById('align-right').addEventListener('click', () => { state.header.alignment = 'text-right'; saveState(); renderHeader(); });

            // process / add manual
            document.getElementById('process-questions').addEventListener('click', processPastedText);
            document.getElementById('add-manual').addEventListener('click', () => {
                state.questions.push({ id: crypto.randomUUID(), text: 'Nova questão...', image:'', imageSize:100, lines:3, isAnswerKey:false });
                saveState(); renderQuestions(); showMessage('Questão adicionada', 'success');
            });

            // export buttons
            document.getElementById('export-pdf').addEventListener('click', exportPDF);
            document.getElementById('export-gabarito').addEventListener('click', exportGabaritoPDF);

            // clear exam
            document.getElementById('clear-exam').addEventListener('click', () => {
                if (confirm('Tem certeza que deseja limpar todo o conteúdo da prova?')) {
                    localStorage.removeItem(stateKey);
                    state.questions = [];
                    state.header.logo = '';
                    saveState();
                    renderHeader(); renderQuestions();
                    showMessage('Prova limpa', 'success');
                }
            });

            // theme toggle
            document.getElementById('theme-toggle').addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                state.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
                saveState();
            });
        });
    </script>
</body>
</html>
