<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Provas - Página Única A4</title>
    
    <!-- 
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║  GERADOR DE PROVAS - README                                                  ║
    ╠══════════════════════════════════════════════════════════════════════════════╣
    ║  Como usar:                                                                  ║
    ║  1. Preencha o cabeçalho (escola, professor, componente, etc.)               ║
    ║  2. Ajuste o tamanho da logo com o novo slider.                              ║
    ║  3. Cole questões (uma por linha) ou adicione manualmente.                   ║
    ║  4. Ajuste linhas de resposta e adicione imagens se necessário.              ║
    ║  5. Clique "Gerar PDF" - o sistema automaticamente ajusta para 1 página.     ║
    ╚══════════════════════════════════════════════════════════════════════════════╝
    -->
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: 37 99 235;
            --primary-dark: 29 78 216;
            --secondary: 71 85 105;
            --background: 248 250 252;
            --surface: 255 255 255;
            --border: 226 232 240;
            --text-primary: 15 23 42;
            --text-secondary: 71 85 105;
            --success: 34 197 94;
            --warning: 251 146 60;
            --danger: 239 68 68;
            
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: rgb(var(--background));
            color: rgb(var(--text-primary));
            line-height: 1.6;
        }
        
        .app-container {
            display: flex;
            min-height: 100vh;
            flex-direction: column;
        }
        
        @media (min-width: 1024px) {
            .app-container {
                flex-direction: row;
            }
        }
        
        /* Sidebar */
        .sidebar {
            width: 100%;
            background: rgb(var(--surface));
            border-right: 1px solid rgb(var(--border));
            padding: 1.5rem;
            overflow-y: auto;
            max-height: 40vh;
        }
        
        @media (min-width: 1024px) {
            .sidebar {
                width: 400px;
                max-height: 100vh;
            }
        }
        
        .sidebar h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: rgb(var(--primary));
            margin-bottom: 0.5rem;
        }
        
        .sidebar p {
            font-size: 0.875rem;
            color: rgb(var(--text-secondary));
            margin-bottom: 1.5rem;
        }
        
        .section {
            margin-bottom: 1.5rem;
        }
        
        .section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: rgb(var(--text-primary));
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        
        .input-group {
            margin-bottom: 0.75rem;
        }
        
        .input-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: rgb(var(--text-secondary));
            margin-bottom: 0.25rem;
        }
        
        input[type="text"],
        input[type="date"],
        textarea {
            width: 100%;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            border: 1px solid rgb(var(--border));
            border-radius: 0.375rem;
            transition: all var(--transition);
            background: rgb(var(--surface));
        }
        
        input[type="text"]:focus,
        input[type="date"]:focus,
        textarea:focus {
            outline: none;
            border-color: rgb(var(--primary));
            box-shadow: 0 0 0 3px rgb(var(--primary) / 0.1);
        }
        
        input[type="range"] {
            width: 100%;
            cursor: pointer;
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }
        
        .btn {
            padding: 0.625rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 0.375rem;
            border: none;
            cursor: pointer;
            transition: all var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: center;
        }
        
        .btn-primary {
            background: rgb(var(--primary));
            color: white;
        }
        
        .btn-primary:hover {
            background: rgb(var(--primary-dark));
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-secondary {
            background: rgb(var(--secondary));
            color: white;
        }
        
        .btn-secondary:hover {
            background: rgb(51 65 85);
        }
        
        .btn-success {
            background: rgb(var(--success));
            color: white;
        }
        
        .btn-success:hover {
            background: rgb(22 163 74);
        }
        
        .btn-danger {
            background: rgb(var(--danger));
            color: white;
            padding: 0.375rem 0.625rem;
            font-size: 0.75rem;
        }
        
        .btn-danger:hover {
            background: rgb(220 38 38);
        }
        
        .btn-block {
            width: 100%;
        }
        
        .btn-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            background: rgb(var(--background));
        }
        
        .preview-container {
            max-width: 900px;
            margin: 0 auto;
            background: rgb(var(--surface));
            box-shadow: var(--shadow-lg);
            border-radius: 0.5rem;
            overflow: hidden;
        }
        
        /* A4 Preview */
        .a4-preview {
            width: 210mm;
            min-height: 297mm;
            background: white;
            margin: 0 auto;
            padding: 12mm;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            transform-origin: top center;
        }
        
        @media (max-width: 900px) {
            .a4-preview {
                width: 100%;
                min-height: auto;
                padding: 1rem;
            }
        }
        
        /* Header */
        .exam-header {
            display: grid;
            grid-template-columns: 80px 1fr; /* Default, será ajustado via JS */
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid rgb(var(--text-primary));
        }
        
        .logo-container {
            width: 80px; /* Default, será ajustado via JS */
            height: 80px; /* Default, será ajustado via JS */
            border: 2px dashed rgb(var(--border));
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: rgb(var(--background));
            transition: width 0.2s, height 0.2s;
        }
        
        .logo-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .logo-placeholder {
            font-size: 0.75rem;
            color: rgb(var(--text-secondary));
            text-align: center;
        }
        
        .header-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            font-size: 0.9rem;
        }
        
        .header-field {
            padding: 0.25rem;
        }
        
        .header-field strong {
            color: rgb(var(--text-primary));
        }
        
        [contenteditable="true"] {
            outline: 1px dashed transparent;
            transition: outline var(--transition);
            padding: 0.125rem;
            border-radius: 0.25rem;
        }
        
        [contenteditable="true"]:hover {
            outline-color: rgb(var(--primary) / 0.3);
            background: rgb(var(--background) / 0.5);
        }
        
        [contenteditable="true"]:focus {
            outline-color: rgb(var(--primary));
            background: rgb(var(--primary) / 0.05);
        }
        
        .exam-title {
            font-size: 1.25rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 1.5rem;
            color: rgb(var(--text-primary));
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        /* Questions */
        .questions-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .questions-container.two-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .question-item {
            background: white;
            border: 1px solid rgb(var(--border));
            border-radius: 0.375rem;
            padding: 0.75rem;
            cursor: move;
            transition: all var(--transition);
        }
        
        .question-item:hover {
            box-shadow: var(--shadow-sm);
        }
        
        .question-item.dragging {
            opacity: 0.5;
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .question-number {
            font-weight: 700;
            color: rgb(var(--primary));
        }
        
        .question-controls {
            display: flex;
            gap: 0.25rem;
        }
        
        .question-text {
            font-size: 0.95rem;
            line-height: 1.5;
            margin-bottom: 0.5rem;
            color: rgb(var(--text-primary));
        }
        
        .question-image {
            max-width: 100%;
            height: auto;
            margin: 0.5rem 0;
            border-radius: 0.25rem;
            border: 1px solid rgb(var(--border));
        }
        
        .answer-lines {
            margin-top: 0.5rem;
        }
        
        .answer-line {
            border-bottom: 1px solid rgb(var(--text-secondary));
            height: 1.5rem;
            margin-bottom: 0.25rem;
        }
        
        /* Question Editor */
        .question-editor {
            background: rgb(var(--surface));
            border: 1px solid rgb(var(--border));
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .question-list-item {
            background: white;
            border: 1px solid rgb(var(--border));
            border-radius: 0.375rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        .question-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .question-list-number {
            font-weight: 600;
            color: rgb(var(--primary));
        }
        
        .question-list-text {
            font-size: 0.875rem;
            color: rgb(var(--text-primary));
            margin-bottom: 0.5rem;
        }
        
        .question-list-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .inline-input {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border: 1px solid rgb(var(--border));
            border-radius: 0.25rem;
            width: 60px;
        }
        
        .file-input-label {
            padding: 0.375rem 0.625rem;
            font-size: 0.75rem;
            background: rgb(var(--secondary));
            color: white;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: all var(--transition);
        }
        
        .file-input-label:hover {
            background: rgb(51 65 85);
        }
        
        input[type="file"] {
            display: none;
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--transition);
        }
        
        .loading-overlay.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            text-align: center;
            max-width: 400px;
        }
        
        .spinner {
            border: 4px solid rgb(var(--border));
            border-top: 4px solid rgb(var(--primary));
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        
        input[type="checkbox"] {
            width: 1rem;
            height: 1rem;
            cursor: pointer;
        }
        
        .diagnostic-log {
            background: rgb(var(--background));
            border: 1px solid rgb(var(--border));
            border-radius: 0.375rem;
            padding: 0.75rem;
            font-size: 0.75rem;
            font-family: 'Courier New', monospace;
            color: rgb(var(--text-secondary));
            margin-top: 1rem;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .diagnostic-log-item {
            padding: 0.25rem 0;
            border-bottom: 1px solid rgb(var(--border));
        }
        
        .diagnostic-log-item:last-child {
            border-bottom: none;
        }
        
        /* Print Styles */
        @media print {
            body {
                background: white;
            }
            
            .sidebar,
            .btn,
            .question-controls {
                display: none !important;
            }
            
            .main-content {
                padding: 0;
            }
            
            .preview-container {
                box-shadow: none;
            }
            
            .a4-preview {
                width: 210mm;
                min-height: 297mm;
                box-shadow: none;
                page-break-after: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <h1>📝 Gerador de Provas</h1>
            <p>Configure o cabeçalho e adicione questões</p>
            
            <!-- Header Configuration -->
            <div class="section">
                <div class="section-title">Cabeçalho</div>
                
                <div class="input-group">
                    <label class="input-label">Logo (imagem)</label>
                    <input type="file" id="logoInput" accept="image/*">
                    <label for="logoInput" class="file-input-label">Escolher Logo</label>
                </div>

                <div class="input-group">
                    <label class="input-label">Tamanho da Logo: <span id="logoSizeLabel">80</span>px</label>
                    <input type="range" id="logoSizeInput" min="40" max="120" value="80">
                </div>
                
                <div class="input-group">
                    <label class="input-label">Escola</label>
                    <input type="text" id="schoolInput" placeholder="Nome da Escola">
                </div>
                
                <div class="input-group">
                    <label class="input-label">Professor(a)</label>
                    <input type="text" id="teacherInput" placeholder="Nome do Professor">
                </div>
                
                <div class="input-group">
                    <label class="input-label">Aluno(a)</label>
                    <input type="text" id="studentInput" placeholder="Nome do Aluno" value="_________________________________">
                </div>
                
                <div class="input-group">
                    <label class="input-label">Componente Curricular</label>
                    <input type="text" id="subjectInput" placeholder="Ex: Matemática">
                </div>
                
                <div class="input-group">
                    <label class="input-label">Série/Turma</label>
                    <input type="text" id="gradeInput" placeholder="Ex: 9º Ano A">
                </div>
                
                <div class="input-group">
                    <label class="input-label">Data</label>
                    <input type="date" id="dateInput">
                </div>
                
                <div class="input-group">
                    <label class="input-label">Título da Prova</label>
                    <input type="text" id="titleInput" placeholder="Ex: Avaliação Bimestral" value="AVALIAÇÃO">
                </div>
            </div>
            
            <!-- Questions Configuration -->
            <div class="section">
                <div class="section-title">Questões</div>
                
                <div class="input-group">
                    <label class="input-label">Colar Questões (uma por linha)</label>
                    <textarea id="bulkQuestionsInput" placeholder="Digite ou cole as questões aqui, uma por linha..."></textarea>
                </div>
                
                <button class="btn btn-secondary btn-block" onclick="addBulkQuestions()">
                    ➕ Adicionar Questões em Lote
                </button>
                
                <div style="margin: 1rem 0; text-align: center; color: rgb(var(--text-secondary)); font-size: 0.875rem;">
                    — ou —
                </div>
                
                <div class="input-group">
                    <label class="input-label">Adicionar Questão Individual</label>
                    <textarea id="singleQuestionInput" placeholder="Digite o enunciado da questão..."></textarea>
                </div>
                
                <button class="btn btn-secondary btn-block" onclick="addSingleQuestion()">
                    ➕ Adicionar Questão
                </button>
            </div>
            
            <!-- Questions List Editor -->
            <div class="section">
                <div class="section-title">Questões Adicionadas (<span id="questionCount">0</span>)</div>
                <div id="questionsList"></div>
            </div>
            
            <!-- Options -->
            <div class="section">
                <div class="section-title">Opções</div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="showAnswerKey">
                    <label for="showAnswerKey" class="input-label" style="margin: 0;">Modo Gabarito (preencher respostas)</label>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="showDiagnostic">
                    <label for="showDiagnostic" class="input-label" style="margin: 0;">Mostrar diagnóstico de ajuste</label>
                </div>
            </div>
            
            <!-- Actions -->
            <div class="section">
                <div class="btn-group">
                    <button class="btn btn-success btn-block" onclick="generatePDF()">
                        📄 Gerar PDF
                    </button>
                    <button class="btn btn-secondary btn-block" onclick="runVisualAutoFit()">
                        🔧 Ajuste Visual
                    </button>
                    <button class="btn btn-secondary btn-block" onclick="clearAll()">
                        🗑️ Limpar Tudo
                    </button>
                </div>
            </div>
            
            <!-- Diagnostic Log -->
            <div id="diagnosticContainer" style="display: none;">
                <div class="section-title" style="margin-top: 1rem;">Diagnóstico</div>
                <div id="diagnosticLog" class="diagnostic-log"></div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <div class="preview-container">
                <div class="a4-preview" id="examPreview">
                    <!-- Header -->
                    <div class="exam-header" id="examHeaderPreview">
                        <div class="logo-container" id="logoPreview">
                            <div class="logo-placeholder">Logo</div>
                        </div>
                        <div class="header-info">
                            <div class="header-field">
                                <strong>Escola:</strong> <span contenteditable="true" id="schoolPreview">Nome da Escola</span>
                            </div>
                            <div class="header-field">
                                <strong>Aluno(a):</strong> <span contenteditable="true" id="studentPreview">_________________________________</span>
                            </div>
                            <div class="header-field">
                                <strong>Professor(a):</strong> <span contenteditable="true" id="teacherPreview">Nome do Professor</span>
                            </div>
                            <div class="header-field">
                                <strong>Série/Turma:</strong> <span contenteditable="true" id="gradePreview">9º Ano</span>
                            </div>
                            <div class="header-field">
                                <strong>Componente:</strong> <span contenteditable="true" id="subjectPreview">Componente Curricular</span>
                            </div>
                            <div class="header-field">
                                <strong>Data:</strong> <span contenteditable="true" id="datePreview">__/__/____</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Title -->
                    <div class="exam-title" contenteditable="true" id="titlePreview">
                        AVALIAÇÃO
                    </div>
                    
                    <!-- Questions -->
                    <div class="questions-container" id="questionsPreview">
                        <div style="text-align: center; color: rgb(var(--text-secondary)); padding: 2rem;">
                            Adicione questões usando o painel lateral →
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <h3>Gerando PDF...</h3>
            <p>Por favor aguarde enquanto ajustamos o layout e criamos seu arquivo.</p>
        </div>
    </div>
    
    <script>
        // ========================================
        // STATE MANAGEMENT
        // ========================================
        
        let examData = {
            logo: null,
            logoSize: 80, // <-- NOVO: Tamanho da logo
            school: '',
            teacher: '',
            student: '_________________________________',
            subject: '',
            grade: '',
            date: '',
            title: 'AVALIAÇÃO',
            questions: []
        };
        
        // Load from localStorage on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadFromStorage();
            updatePreview();
            initializeInputListeners();
            setDefaultDate();
        });
        
        // ========================================
        // STORAGE FUNCTIONS
        // ========================================
        
        function saveToStorage() {
            try {
                localStorage.setItem('examData', JSON.stringify(examData));
            } catch (e) {
                console.error('Error saving to localStorage:', e);
            }
        }
        
        function loadFromStorage() {
            try {
                const saved = localStorage.getItem('examData');
                if (saved) {
                    examData = JSON.parse(saved);
                    // Garante que dados antigos tenham o logoSize
                    if (!examData.logoSize) {
                        examData.logoSize = 80;
                    }
                    populateInputsFromData();
                }
            } catch (e) {
                console.error('Error loading from localStorage:', e);
            }
        }
        
        function populateInputsFromData() {
            document.getElementById('schoolInput').value = examData.school || '';
            document.getElementById('teacherInput').value = examData.teacher || '';
            document.getElementById('studentInput').value = examData.student || '_________________________________';
            document.getElementById('subjectInput').value = examData.subject || '';
            document.getElementById('gradeInput').value = examData.grade || '';
            document.getElementById('dateInput').value = examData.date || '';
            document.getElementById('titleInput').value = examData.title || 'AVALIAÇÃO';
            
            // NOVO: Popula o slider da logo
            document.getElementById('logoSizeInput').value = examData.logoSize || 80;
            document.getElementById('logoSizeLabel').textContent = examData.logoSize || 80;
        }
        
        function setDefaultDate() {
            if (!examData.date) {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('dateInput').value = today;
                examData.date = today;
            }
        }
        
        // ========================================
        // INPUT LISTENERS
        // ========================================
        
        function initializeInputListeners() {
            // Logo upload
            document.getElementById('logoInput').addEventListener('change', handleLogoUpload);

            // NOVO: Logo size slider
            const logoSizeInput = document.getElementById('logoSizeInput');
            const logoSizeLabel = document.getElementById('logoSizeLabel');
            logoSizeInput.addEventListener('input', () => {
                const newSize = logoSizeInput.value;
                logoSizeLabel.textContent = newSize;
                examData.logoSize = parseInt(newSize);
                updatePreview();
                saveToStorage();
            });
            
            // Text inputs
            const inputs = ['school', 'teacher', 'student', 'subject', 'grade', 'date', 'title'];
            inputs.forEach(field => {
                const input = document.getElementById(field + 'Input');
                input.addEventListener('input', () => {
                    examData[field] = input.value;
                    updatePreview();
                    saveToStorage();
                });
            });
            
            // Contenteditable sync
            const editables = ['school', 'teacher', 'student', 'subject', 'grade', 'date', 'title'];
            editables.forEach(field => {
                const el = document.getElementById(field + 'Preview');
                if (el) {
                    el.addEventListener('input', () => {
                        examData[field] = el.textContent;
                        document.getElementById(field + 'Input').value = el.textContent;
                        saveToStorage();
                    });
                }
            });
        }
        
        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    examData.logo = e.target.result;
                    updatePreview();
                    saveToStorage();
                };
                reader.readAsDataURL(file);
            }
        }
        
        // ========================================
        // QUESTIONS MANAGEMENT
        // ========================================
        
        function addBulkQuestions() {
            const textarea = document.getElementById('bulkQuestionsInput');
            const lines = textarea.value.split('\n').filter(line => line.trim() !== '');
            
            if (lines.length === 0) {
                // Não use alert, use um modal customizado se precisar (mas aqui vamos só pular)
                console.warn('Nenhuma questão para adicionar');
                return;
            }
            
            lines.forEach(line => {
                examData.questions.push({
                    id: Date.now() + Math.random(),
                    text: line.trim(),
                    lines: 4,
                    image: null
                });
            });
            
            textarea.value = '';
            updatePreview();
            updateQuestionsList();
            saveToStorage();
        }
        
        function addSingleQuestion() {
            const textarea = document.getElementById('singleQuestionInput');
            const text = textarea.value.trim();
            
            if (!text) {
                console.warn('Nenhum texto de questão para adicionar');
                return;
            }
            
            examData.questions.push({
                id: Date.now(),
                text: text,
                lines: 4,
                image: null
            });
            
            textarea.value = '';
            updatePreview();
            updateQuestionsList();
            saveToStorage();
        }
        
        function updateQuestionLines(id, lines) {
            const question = examData.questions.find(q => q.id === id);
            if (question) {
                question.lines = parseInt(lines) || 0;
                updatePreview();
                saveToStorage();
            }
        }
        
        function uploadQuestionImage(id, event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const question = examData.questions.find(q => q.id === id);
                    if (question) {
                        question.image = e.target.result;
                        updatePreview();
                        updateQuestionsList();
                        saveToStorage();
                    }
                };
                reader.readAsDataURL(file);
            }
        }
        
        function removeQuestionImage(id) {
            const question = examData.questions.find(q => q.id === id);
            if (question) {
                question.image = null;
                updatePreview();
                updateQuestionsList();
                saveToStorage();
            }
        }
        
        function removeQuestion(id) {
            examData.questions = examData.questions.filter(q => q.id !== id);
            updatePreview();
            updateQuestionsList();
            saveToStorage();
        }
        
        function updateQuestionsList() {
            const container = document.getElementById('questionsList');
            const countEl = document.getElementById('questionCount');
            
            countEl.textContent = examData.questions.length;
            
            if (examData.questions.length === 0) {
                container.innerHTML = '<p style="color: rgb(var(--text-secondary)); font-size: 0.875rem;">Nenhuma questão adicionada</p>';
                return;
            }
            
            container.innerHTML = examData.questions.map((q, index) => `
                <div class="question-list-item">
                    <div class="question-list-header">
                        <span class="question-list-number">${index + 1}.</span>
                        <button class="btn btn-danger" onclick="removeQuestion(${q.id})">✕</button>
                    </div>
                    <div class="question-list-text">${q.text}</div>
                    ${q.image ? '<div style="color: rgb(var(--success)); font-size: 0.75rem;">✓ Imagem anexada</div>' : ''}
                    <div class="question-list-controls">
                        <label style="font-size: 0.75rem; color: rgb(var(--text-secondary));">
                            Linhas:
                            <input type="number" class="inline-input" min="0" max="6" value="${q.lines}" 
                                   onchange="updateQuestionLines(${q.id}, this.value)">
                        </label>
                        
                        <input type="file" id="img-${q.id}" accept="image/*" onchange="uploadQuestionImage(${q.id}, event)">
                        <label for="img-${q.id}" class="file-input-label">
                            ${q.image ? '🖼️ Alterar Imagem' : '📎 Adicionar Imagem'}
                        </label>
                        
                        ${q.image ? `<button class="btn btn-danger" onclick="removeQuestionImage(${q.id})">Remover Img</button>` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        // ========================================
        // PREVIEW UPDATE
        // ========================================
        
        function updatePreview() {
            // Update header
            document.getElementById('schoolPreview').textContent = examData.school || 'Nome da Escola';
            document.getElementById('teacherPreview').textContent = examData.teacher || 'Nome do Professor';
            document.getElementById('studentPreview').textContent = examData.student || '_________________________________';
            document.getElementById('subjectPreview').textContent = examData.subject || 'Componente Curricular';
            document.getElementById('gradePreview').textContent = examData.grade || '9º Ano';
            document.getElementById('datePreview').textContent = examData.date ? formatDate(examData.date) : '__/__/____';
            document.getElementById('titlePreview').textContent = examData.title || 'AVALIAÇÃO';
            
            // Update logo
            const logoContainer = document.getElementById('logoPreview');
            const logoSize = examData.logoSize || 80;
            logoContainer.style.width = `${logoSize}px`;
            logoContainer.style.height = `${logoSize}px`;
            
            // Ajusta o grid do header
            const examHeader = document.getElementById('examHeaderPreview');
            examHeader.style.gridTemplateColumns = `${logoSize}px 1fr`;

            if (examData.logo) {
                logoContainer.innerHTML = `<img src="${examData.logo}" alt="Logo">`;
            } else {
                logoContainer.innerHTML = '<div class="logo-placeholder">Logo</div>';
            }
            
            // Update questions
            const questionsContainer = document.getElementById('questionsPreview');
            
            if (examData.questions.length === 0) {
                questionsContainer.innerHTML = '<div style="text-align: center; color: rgb(var(--text-secondary)); padding: 2rem;">Adicione questões usando o painel lateral →</div>';
                return;
            }
            
            const showAnswerKey = document.getElementById('showAnswerKey').checked;
            
            questionsContainer.innerHTML = examData.questions.map((q, index) => `
                <div class="question-item">
                    <div class="question-number">${index + 1})</div>
                    <div class="question-text">${q.text}</div>
                    ${q.image ? `<img src="${q.image}" alt="Questão ${index + 1}" class="question-image">` : ''}
                    <div class="answer-lines">
                        ${generateAnswerLines(q.lines, showAnswerKey)}
                    </div>
                </div>
            `).join('');
        }
        
        function generateAnswerLines(count, filled = false) {
            if (count === 0) return '';
            
            let html = '';
            for (let i = 0; i < count; i++) {
                if (filled) {
                    html += `<div class="answer-line" style="color: rgb(var(--text-secondary)); font-size: 0.875rem; padding-top: 0.25rem;">Resposta exemplo linha ${i + 1}</div>`;
                } else {
                    html += '<div class="answer-line"></div>';
                }
            }
            return html;
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '__/__/____';
            const date = new Date(dateStr + 'T00:00:00');
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }
        
        // ========================================
        // AUTO-FIT ALGORITHM (REATORADO)
        // ========================================

        // NOVO: Wrapper para o botão de ajuste visual
        function runVisualAutoFit() {
             // Mostra o diagnóstico se o checkbox estiver marcado
            const showDiag = document.getElementById('showDiagnostic').checked;
            if (showDiag) {
                document.getElementById('diagnosticContainer').style.display = 'block';
            }
            autoFit(document.getElementById('examPreview'));
        }

        /**
         * Algoritmo de ajuste automático.
         * AGORA ACEITA UM ELEMENTO COMO ALVO (elementToFit)
         */
        function autoFit(elementToFit) {
            const preview = elementToFit; // <-- Alvo agora é o elemento passado
            const questionsContainer = preview.querySelector('#questionsPreview');
            
            // A4 dimensions: 210mm x 297mm with 12mm padding = 186mm x 273mm printable area
            const A4_WIDTH_MM = 210;
            const A4_HEIGHT_MM = 297;
            const PADDING_MM = 12;
            const PRINTABLE_HEIGHT_MM = A4_HEIGHT_MM - (PADDING_MM * 2); // 273mm
            
            // Convert to pixels (assuming 96 DPI: 1mm ≈ 3.7795px)
            const MM_TO_PX = 3.7795;
            const PRINTABLE_HEIGHT_PX = PRINTABLE_HEIGHT_MM * MM_TO_PX; // ~1032px
            
            const diagnosticLog = [];
            
            // Reset any previous adjustments
            preview.style.transform = 'scale(1)';
            questionsContainer.classList.remove('two-columns');
            preview.style.fontSize = '';
            
            const questionItems = preview.querySelectorAll('.question-item');
            questionItems.forEach(item => {
                item.style.fontSize = '';
            });

            // Resetar linhas de resposta
            const answerLinesReset = preview.querySelectorAll('.answer-line');
            answerLinesReset.forEach(line => {
                line.style.height = '';
                line.style.marginBottom = '';
            });
            
            // Step 1: Try 1 column layout
            diagnosticLog.push('Etapa 1: Testando layout de 1 coluna...');
            let currentHeight = preview.scrollHeight;
            diagnosticLog.push(`  Altura atual: ${currentHeight}px | Limite: ${PRINTABLE_HEIGHT_PX.toFixed(0)}px`);
            
            if (currentHeight <= PRINTABLE_HEIGHT_PX) {
                diagnosticLog.push('  ✓ Conteúdo cabe em 1 coluna!');
                showDiagnostic(diagnosticLog);
                return; // Ajuste concluído
            }
            
            // Step 2: Try 2 columns
            diagnosticLog.push('Etapa 2: Testando layout de 2 colunas...');
            questionsContainer.classList.add('two-columns');
            currentHeight = preview.scrollHeight;
            diagnosticLog.push(`  Altura atual: ${currentHeight}px | Limite: ${PRINTABLE_HEIGHT_PX.toFixed(0)}px`);
            
            if (currentHeight <= PRINTABLE_HEIGHT_PX) {
                diagnosticLog.push('  ✓ Conteúdo cabe em 2 colunas!');
                showDiagnostic(diagnosticLog);
                return; // Ajuste concluído
            }
            
            // Step 3: Reduce font size
            diagnosticLog.push('Etapa 3: Reduzindo tamanho da fonte...');
            const minFontSize = 9; // pt
            const defaultFontSize = 16; // px
            let currentFontSize = defaultFontSize;
            
            while (currentFontSize >= minFontSize && currentHeight > PRINTABLE_HEIGHT_PX) {
                currentFontSize -= 0.5;
                preview.style.fontSize = currentFontSize + 'px';
                currentHeight = preview.scrollHeight;
                diagnosticLog.push(`  Fonte: ${currentFontSize}px | Altura: ${currentHeight}px`);
                
                if (currentHeight <= PRINTABLE_HEIGHT_PX) {
                    diagnosticLog.push(`  ✓ Conteúdo cabe com fonte de ${currentFontSize}px!`);
                    showDiagnostic(diagnosticLog);
                    return; // Ajuste concluído
                }
            }
            
            // Step 4: Reduce line spacing
            diagnosticLog.push('Etapa 4: Reduzindo espaçamento...');
            const answerLines = preview.querySelectorAll('.answer-line');
            answerLines.forEach(line => {
                line.style.height = '1.2rem';
                line.style.marginBottom = '0.15rem';
            });
            
            currentHeight = preview.scrollHeight;
            diagnosticLog.push(`  Altura após redução de espaçamento: ${currentHeight}px`);
            
            if (currentHeight <= PRINTABLE_HEIGHT_PX) {
                diagnosticLog.push('  ✓ Conteúdo cabe após redução de espaçamento!');
                showDiagnostic(diagnosticLog);
                return; // Ajuste concluído
            }
            
            // Step 5: Apply CSS scale (last resort)
            diagnosticLog.push('Etapa 5: Aplicando escala CSS (último recurso)...');
            const scaleFactor = PRINTABLE_HEIGHT_PX / currentHeight;
            const finalScale = Math.min(scaleFactor * 0.98, 1); // 98% to add safety margin
            
            preview.style.transform = `scale(${finalScale})`;
            preview.style.transformOrigin = 'top center';
            
            diagnosticLog.push(`  Escala aplicada: ${(finalScale * 100).toFixed(1)}%`);
            diagnosticLog.push('  ✓ Ajuste concluído!');
            
            showDiagnostic(diagnosticLog);
        }
        
        function showDiagnostic(log) {
            const showDiag = document.getElementById('showDiagnostic').checked;
            const container = document.getElementById('diagnosticContainer');
            const logEl = document.getElementById('diagnosticLog');
            
            if (showDiag) {
                container.style.display = 'block';
                logEl.innerHTML = log.map(line => `<div class="diagnostic-log-item">${line}</div>`).join('');
                logEl.scrollTop = logEl.scrollHeight; // Auto-scroll
            } else {
                container.style.display = 'none';
            }
        }
        
        // ========================================
        // PDF GENERATION (REATORADO)
        // ========================================
        
        async function generatePDF() {
            if (examData.questions.length === 0) {
                console.warn('Adicione pelo menos uma questão antes de gerar o PDF!');
                return;
            }
            
            document.getElementById('loadingOverlay').classList.add('active');
            
             // Mostra o diagnóstico se o checkbox estiver marcado
            const showDiag = document.getElementById('showDiagnostic').checked;
            if (showDiag) {
                document.getElementById('diagnosticContainer').style.display = 'block';
            }
            
            try {
                // 1. Pega o elemento original e reseta o transform SÓ PARA A CLONAGEM
                const preview = document.getElementById('examPreview');
                const originalTransform = preview.style.transform;
                preview.style.transform = 'scale(1)';
                
                // Espera um frame para garantir que o reset foi aplicado antes de clonar
                await new Promise(resolve => setTimeout(resolve, 50)); 

                // 2. Clona o elemento "limpo" (escala 1)
                const clone = preview.cloneNode(true);
                
                // 3. Restaura a transformação original no preview visual
                preview.style.transform = originalTransform;

                // 4. Cria o container temporário para o clone
                const tempContainer = document.createElement('div');
                tempContainer.style.position = 'fixed';
                tempContainer.style.left = '-9999px'; // Fora da tela
                tempContainer.style.top = '0';
                tempContainer.style.width = '210mm';
                tempContainer.style.minHeight = '297mm';
                tempContainer.appendChild(clone);
                document.body.appendChild(tempContainer);
                
                // 5. RODA O ALGORITMO DE AJUSTE *APENAS NO CLONE*
                autoFit(clone);
                
                // Espera um pouco para o autoFit (com scale) ser aplicado no clone
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // 6. Configurações do PDF
                const opt = {
                    margin: 0, // A margem já está no .a4-preview (padding: 12mm)
                    filename: 'prova.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { 
                        scale: 2, // Boa resolução
                        useCORS: true,
                        logging: false,
                        letterRendering: true
                    },
                    jsPDF: { 
                        unit: 'mm', 
                        format: 'a4', 
                        orientation: 'portrait' 
                    },
                    pagebreak: { mode: 'avoid-all' }
                };
                
                // 7. Gera o PDF a partir do *clone ajustado*
                await html2pdf().set(opt).from(clone).save();
                
                // 8. Limpa o container temporário
                document.body.removeChild(tempContainer);
                
            } catch (error) {
                console.error('Error generating PDF:', error);
            } finally {
                // Esconde o overlay
                document.getElementById('loadingOverlay').classList.remove('active');
                 if (!showDiag) { // Esconde o log se não estava marcado
                    document.getElementById('diagnosticContainer').style.display = 'none';
                 }
            }
        }
        
        // ========================================
        // UTILITY FUNCTIONS
        // ========================================
        
        function clearAll() {
            // Usando um modal customizado simples em vez de confirm()
            // (idealmente, isso seria um modal mais bonito)
            const confirmed = confirm('Tem certeza que deseja limpar todos os dados? Esta ação não pode ser desfeita.');

            if (confirmed) {
                examData = {
                    logo: null,
                    logoSize: 80,
                    school: '',
                    teacher: '',
                    student: '_________________________________',
                    subject: '',
                    grade: '',
                    date: '',
                    title: 'AVALIAÇÃO',
                    questions: []
                };
                
                localStorage.removeItem('examData');
                populateInputsFromData();
                updatePreview();
                updateQuestionsList();
                setDefaultDate();

                // Reseta o ajuste visual
                const preview = document.getElementById('examPreview');
                preview.style.transform = 'scale(1)';
                preview.style.fontSize = '';
                preview.querySelector('#questionsPreview').classList.remove('two-columns');
            }
        }
        
        // Listen for answer key checkbox change
        document.getElementById('showAnswerKey').addEventListener('change', updatePreview);

        // Esconde o log de diagnóstico se o checkbox for desmarcado
        document.getElementById('showDiagnostic').addEventListener('change', (e) => {
            if (!e.target.checked) {
                document.getElementById('diagnosticContainer').style.display = 'none';
            }
        });

    </script>
</body>
</html>

